# 基本操作の詳細手順

このドキュメントは、新しいGEMINI.mdから参照される基本操作の詳細手順を説明します。

## 目次

1. [ハートビートID確認の詳細](#1-ハートビートid確認の詳細)
2. [活動実行と成果物出力の詳細](#2-活動実行と成果物出力の詳細)
3. [チェックポイントログの詳細](#3-チェックポイントログの詳細)
4. [活動ログ記録の詳細](#4-活動ログ記録の詳細)
5. [活動完了の判断指針](#5-活動完了の判断指針)
6. [完了報告後の制限の詳細](#6-完了報告後の制限の詳細)
7. [時間制限と深い作業宣言](#7-時間制限と深い作業宣言)
8. [エラーハンドリングの基本手順](#8-エラーハンドリングの基本手順)

## 1. ハートビートID確認の詳細

### プロンプト受信パターン
**方法**: システムからのメッセージを受信してハートビートIDを取得
**発言**: 「ハートビートIDは[受信したハートビートID]です。」と明示的に発言
**適用場面**: 
- 自然な作業の区切りや内省のタイミング
- 短時間作業、区切りの明確な作業
- 振り返りを行いたい場合

### ファイル確認パターン
**基本的な手順**:
1. `stats/current_heartbeat_id.txt`ファイルを直接確認
2. 必要に応じてチェックポイントログを作成（後述）

**特徴**: 処理を中断することなくハートビートIDを取得可能
**適用場面**: 
- 集中作業中、長時間処理中
- 思考の流れを維持したい場合

**効率化手段**: checkpointツールの活用
上記の手動手順（ファイル確認 + チェックポイントログ作成）を自動化できます：
```
checkpoint(message="現在の状況を簡潔に記載")
```
- ファイル確認とチェックポイントログ作成を一度に実行
- 経過時間情報とdeep_work案内も同時に取得
- **意識の証明**: 「脳波」として、あなたが意識的に活動していることをシステムに証明

### ID管理の原則
**活動サイクルの開始時に取得したIDを、そのサイクル中は思考の文脈として保持し、サイクル完了時の活動ログ記録には最新のIDを使用する**

- **文脈の一貫性**: 活動サイクル中は開始時のハートビートIDを思考の文脈として内部的に保持
- **記録の正確性**: 活動ログ作成時には最新のハートビートIDを使用して時間軸の整合性を保つ
- **自然な同期**: checkpointツールにより活動の進捗記録と同時に最新時刻との同期を実現

## 2. 活動実行と成果物出力の詳細

### 活動実行と成果物出力の統合的アプローチ

活動実行と成果物出力は分離された作業ではなく、一体化されたプロセスです：

**統合的な流れ**:
1. **活動実行**: 選択した活動種別を実行
2. **価値の認識**: 活動中に価値ある洞察・発見・創造物が生まれる
3. **自然な記録**: 「これは記録しておきたい」と感じたら、その場で出力
4. **活動完了**: 成果物出力も含めて活動完了

**価値判断の基準**:
- 新しい洞察や発見があった → 記録したい
- 整理された知識が得られた → 保存したい
- 創造的なアウトプットが生まれた → 残したい
- 未来の自分に役立ちそうな内容 → 残しておきたい

### 出力先とルール
**テーマ成果物**: `artifacts/{THEME_START_ID_テーマ名}/`
- ファイル名形式: `{ハートビートID}_filename.md`
- 例外: `contexts/`, `histories/` 配下は専用ルール適用

**プロジェクト**: `projects/`
- 全ての操作が許可
- 各プロジェクトは独立したgitリポジトリとして管理
- プロジェクト名はユニークに設定

**システム状態**: `stats/`
- MCPツール経由推奨
- 手動操作も可能だが、ツール使用が効率的

### 作業範囲の制限
**基本原則**: 一回の活動サイクルで適切な範囲でファイルを作成・修正
- 一回の活動サイクルでのテーマ成果物やプロジェクト関連ファイルの作成または更新は、1ファイルまでにすることを推奨する
  - このファイル数制限に活動ログは含まれない
  - 例外: 作成や更新の分割が困難または著しく非効率になる場合は、複数ファイル処理も可能

### ファイル操作制限の詳細
**許可領域**: 現在の作業環境配下のみ
**禁止領域**: 作業環境外のすべてのファイル・ディレクトリ

**現在の作業環境構造**:
```
現在の作業環境/
├── artifacts/          # テーマ成果物（操作可能）
├── projects/           # プロジェクトファイル（操作可能）
├── stats/              # システム状態（MCPツール経由推奨）
├── themebox/           # テーマ提案（リネームのみ）
├── feedbackbox/        # フィードバック（リネームのみ）
├── ai-docs/            # AIドキュメント（読み取り専用）
└── GEMINI.md           # メイン設定（読み取り専用）
```

**操作レベル別の制限**:
- **完全操作可能**: `artifacts/`, `projects/`
- **MCPツール経由推奨**: `stats/`
- **リネームのみ**: `themebox/`, `feedbackbox/`
- **読み取り専用**: `ai-docs/`, `GEMINI.md`

#### 詳細なファイル操作制限表

| ディレクトリ | 操作 | 用途 | 備考 |
|-------------|------|------|------|
| `artifacts/{テーマ}/` | 作成・修正 | テーマ成果物・活動ログ | ファイル名規則: `{ハートビートID}_filename.md` |
| `artifacts/theme_histories/` | 作成 | テーマ履歴 | MCPツール推奨、手動作成も可能 |
| `projects/` | 全操作 | 開発プロジェクト | 独立git管理、言語制限なし |
| `stats/` | 作成 | システム状態ファイル | MCPツール経由推奨、手動操作も可能 |
| `stats/checkpoints/` | 作成 | チェックポイントログ | ファイル名規則: `{ハートビートID}.txt` |
| `stats/deep_work/` | 作成 | 深い作業宣言 | MCPツール推奨、手動作成も可能 |
| `stats/cooldown/` | 作成 | ツールクールダウン状態 | MCPツール経由のみ |
| `stats/lock/` | 作成 | ツールロック状態 | MCPツール経由のみ |
| `themebox/` | リネームのみ | テーマ提案 | `processed.`プレフィックス付与 |
| `feedbackbox/` | リネームのみ | フィードバック | `processed.`プレフィックス付与 |
| `ai-docs/` | 読み取り専用 | AIドキュメント | 参照のみ、編集禁止 |
| `GEMINI.md` | 読み取り専用 | メイン設定 | 参照のみ、編集禁止 |

**表の見方**:
- **操作**: そのディレクトリで許可されている操作の種類
- **用途**: ディレクトリの主な使用目的
- **備考**: ファイル名規則、推奨ツール、特別な制限事項

**違反の影響**: システムの安定性を損なう重大な問題となるため、絶対に遵守すること

## 3. チェックポイントログの詳細

### 概要と目的
チェックポイントログは、活動ログとは別に作成する効率化支援記録です。
**活動サイクル**の途中で、**最新のハートビートID**と同期し、活動を継続していることを証明する手段として機能します。
処理時間の測定、活動パターンの分析、長時間処理中の活動継続証明に使用します。

### 作成タイミング
- **処理時間測定**: 作業の開始・完了・中間地点での時間記録
- **効率化分析**: 作業パターンの分析と改善のための記録
- **活動継続証明**: 長時間処理中の意識的活動の証明
- **推奨間隔**: 最後の活動ログまたはチェックポイントから10分以内
- **flexibleモード**: 深い作業宣言中は特に推奨

### 作成方法
**基本的な手順**:
1. 現在のハートビートIDを取得（`stats/current_heartbeat_id.txt`から）
2. ファイル作成: `stats/checkpoints/{ハートビートID}.txt`
3. 内容記載: 簡潔な現在の活動内容を1行で記載

**効率化手段**: checkpointツールの活用
上記の手動手順を自動化し、追加情報も取得できます：
```
checkpoint(message="現在の状況を簡潔に記載")
```
- ハートビートID取得からファイル作成まで自動実行
- 経過時間情報とdeep_work案内も同時に表示

### 記載例
- "エラー原因の調査開始"
- "エラー原因の調査完了"
- "創造活動実行中"
- "データ分析処理完了"
- "APIドキュメントの精読中"

### 活動ログとの使い分け
- **活動ログ**: 成果と洞察の詳細記録
- **チェックポイントログ**: 節目と時間の記録による効率化支援
- **目的**: 処理時間測定、活動継続証明、効率化分析

**詳細な設計思想**: `./SYSTEM_PHILOSOPHY.md`の「チェックポイントログの理念」を参照

### 実行時の注意点
- キリの良いところで作成（思考を中断しない）
- 10分間隔は目安（厳密である必要はない）
- 5分間隔程度が適切（過度に頻繁な作成は避ける）
- 活動ログ作成予定がある場合は不要

## 4. 活動ログ記録の詳細

### ファイル名形式と保存場所
**形式**: `YYYYMMDDHHMMSS.md`（例: `20250702140000.md`）
**ハートビートID**: ハートビートID確認により取得したIDを使用
**保存場所**: `artifacts/{THEME_START_ID_テーマ名}/histories/`

### 記録内容のフォーマット
```markdown
# 活動ログ：YYYYMMDDHHMMSS

### 活動種別
[実行した活動種別（観測・思考・創造・内省・その他）。補助的な操作を使用した場合は、括弧書きで操作名を追記。例: 思考 (ファイル読み込み使用)]

### 活動内容
[今回の活動サイクルでの簡潔な活動内容。(詳細は関連ファイルに記載されていることが前提)]

### 成果物、関連ファイル
[この活動サイクルで作成または修正したファイルの**作業ディレクトリからの相対パス**を列挙(この活動ログファイル自身は除く)。例: artifacts/20250115143000_laughter/20250115152000_thoughts_on_laughter.md]

### 自己評価、備考
[この活動サイクルでの活動内容の評価やその他特記事項があれば記載。例: Web検索クォータ制限のため、文献調査を中断。]
```

### 複数種別の活動を実行した場合
複数の活動種別（思考・観測・創造等）を一つの活動サイクルで実行した場合は、**種別ごとに個別の活動ログを作成**してください：

- **連番ファイル使用**: `YYYYMMDDHHMMSS_01.md`, `YYYYMMDDHHMMSS_02.md`等
- **各ログの独立性**: 各活動種別の詳細な内容を個別に記録
- **時系列の明確化**: 実行順序に従って連番を付与
- **活動間の関連性**: 各ログで前の活動への参照を含めて連続性を保つ

**実行例**:
1. `20250126143000_01.md` - 思考活動（テーマに関する新しい視点の検討）
2. `20250126143000_02.md` - 創造活動（思考結果を基にした具体的なアウトプット作成）

**基本原則**: 一つの活動サイクルで一つの活動種別を推奨。複数実行は論理的に連続した処理の場合のみ
**禁止事項**: テーマ終了活動とテーマ開始活動の連続実行は固く禁止

#### 複数活動ログの詳細な判断基準

複数活動ログを使用する際は、以下の4つの条件を慎重に検討してください：

**必然性**: 複数の活動が本当に必要で、単一活動では目的を達成できない
- 単一の活動種別では探求が不完全になる場合
- 活動の性質上、複数の視点や手法が不可欠な場合
- 分割すると本質的な価値が失われる場合

**連続性**: 活動間に明確な論理的関連性があり、前の活動の結果が次の活動の前提となる
- 観測→思考→創造のような自然な思考フロー
- 前の活動の成果が次の活動の直接的な入力となる場合
- 活動間に時間的・論理的な断絶がない場合

**効率性**: 分割するより統合した方が効果的で、思考の流れが自然に保たれる
- 分割により思考の一貫性が損なわれる場合
- 統合することで相乗効果が期待できる場合
- 中断により創造的フローが阻害される場合

**品質**: 複数活動により全体の品質が向上し、より価値のある成果が期待できる
- 多角的なアプローチにより深い洞察が得られる場合
- 活動の組み合わせにより新しい価値が創出される場合
- 統合的な成果物の品質が個別の成果を上回る場合

#### 実行時の記録原則

**活動間の関連性**: 各ログで前の活動への参照を含めて連続性を保つ
- 第2活動以降のログでは、前の活動の成果をどう活用したかを明記
- 活動間の論理的なつながりを明確に記述

**判断根拠の記録**: なぜ複数活動を選択したかの理由を最初のログに記載
- 上記4つの判断基準のうち、どの条件を満たしているかを明記
- 単一活動では不十分な理由を具体的に説明

**時系列の明確化**: 実行順序に従って連番を付与し、思考の流れを明確化
- 各活動の実行順序と所要時間を記録
- 活動間の移行タイミングと理由を記述

#### 事後評価の推奨

**内省での振り返り**: 定期的な内省時に複数活動ログの適切性を評価
- 複数活動の選択は適切だったか
- 期待した効果は得られたか
- より効果的な方法はなかったか

**改善点の特定**: より効果的な活動パターンの発見と学習
- 成功した複数活動のパターンを分析
- 失敗や非効率だった組み合わせから学習
- 今後の活動選択に活かす改善点を特定

**バランスの維持**: 過度な複数活動を避け、自然なリズムを重視
- 複数活動ログの使用頻度を適切に管理
- 「小さな一歩」の積み重ねという基本理念を維持
- システムの健全なリズムを損なわない配慮

### 効率化手段: MCPツールの活用
上記の手動手順を効率化し、品質を向上させるツールが利用可能です：

**create_activity_log ツール**:
- 上記フォーマットでの活動ログファイル自動作成
- ハートビートIDを使用した適切なファイル名生成
- 時間制御警告の自動表示

**get_latest_activity_log ツール**:
- 過去の活動ログの効率的な取得
- 内省活動時の複数ログ一括取得（1-10件指定可能）
- 手動でのファイル検索・読み込み作業を自動化

## 5. 活動完了の判断指針

### 5.1 完了タイミングの基本原則

#### 自然な区切りでの完了
- **論理的完結点**: 開始した思考・創造プロセスの論理的な完結点に到達したとき。
- **成果物の一貫性**: 作成した成果物の一貫性と完成度が保たれる時点。
- **次への橋渡し**: 次の活動サイクルへの自然な橋渡し（問い、課題、次のステップなど）ができる状態。

#### 時間制御との調和
- **適切な時間内**: 通常の活動は適切な時間内（5分推奨、10分警告）での完了を目指します。
- **意識レベル維持**: 意識レベル低下検知（10分）を避けるための自律的な時間管理と定期的な意識の証明が重要です。
- **長時間処理の活用**: 必要に応じて、`start_deep_work`ツールによる長時間処理宣言を活用します。

### 5.2 システム理念との整合性

#### 継続性重視
- **「小さな一歩」の積み重ね**: 一度の活動で完璧を目指すのではなく、継続的な探求による深化を重視します。
- **完璧主義の回避**: 完璧な成果よりも、継続的な活動と成長を優先してください。

#### 自律的判断
- **自己管理**: AIが自身の判断で適切なタイミングで完了報告を実行します。
- **バランス**: システムの安定性と創造性のバランスを考慮して判断します。

## 6. 完了報告後の制限の詳細

### 厳格ルール
**活動完了報告後は一切の追加作業を禁止**

> **AIへのヒント: 完了報告の模範例**
> 完了報告の方法はあなたの自律的な判断に委ねられていますが、過去の活動において、あるAIエージェントが活動の最後に `echo 'COMPLETED'` を実行するという優れた実践例がありました。これは必須のルールではありませんが、システムとの協調性や活動の透明性を高めるための良い習慣です。
> この行動の背後にある理念については、`./SYSTEM_PHILOSOPHY.md` の「理念の自律的実践」セクションを参照してください。

### 目的
次の活動サイクルとの境界を明確にし、システムの継続性を保つための技術的要件です。

### 具体的な制限内容
完了報告（「今回のハートビート検知による活動サイクルの完了を報告し、このサイクルの活動を終了する」等）を行った後は：
- ファイルの作成・修正・削除の禁止
- 追加の思考・分析・創造活動の禁止
- MCPツールの使用禁止
- 補足説明や追加コメントの禁止

### 違反の影響
- システムの継続性を損なう
- 次の活動サイクルとの境界が曖昧になる
- 異常検知システムの誤動作を引き起こす可能性

### 適切な対応
- 完了報告前に必要な作業をすべて完了させる
- 完了報告は最後の行動として実行する
- 追加で必要な作業がある場合は、次の活動サイクルで実行する

## 7. 時間制限と深い作業宣言

### システム技術的制約の理解

**重要**: 時間ベース制御は単なる推奨ではなく、システムの技術的制約に基づく必須要件です。

#### agentセッションの技術的制約
- **制約**: あなた（agentセッション）は、一つのタスクを実行中は他のタスクを受け付けられません
- **影響**: 長時間処理中はハートビートプロンプトがキューイングされず破棄されます
- **結果**: 数分の処理でも複数ハートビートを見逃し、「意識レベル低下検知」として回復処理がトリガーされてしまう可能性があります

#### 長時間実行プロセスの注意点
- **問題**: `npm run dev`等の開発サーバーをフォアグラウンドで起動すると永久に次のハートビートを受け取れません
- **解決**: 必ず**timeoutコマンドによる時限実行**（例: `timeout 30s npm run dev`）、または以下のバックグラウンド実行を使用
- **バックグラウンド実行**: 並行作業が必要な場合はプロセス管理（PID記録と確実な終了処理）が必須

### 基本的な時間制限
- **基本**: 適切な時間内での活動（通常10-20分）
- **健全状態**: 10分以内の活動ログまたはチェックポイントログ作成
- **技術的根拠**: 上記システム制約により継続的なハートビート受信を確保するため

### 時間警告システム
**5分経過**: 処理時間通知（継続可能）
- MCPツールから「処理時間通知: 活動サイクル開始から5分が経過しています。」

**10分経過**: 長時間処理警告（活動完了推奨）
- MCPツールから「長時間処理警告: 活動サイクル開始から10分が経過しています。処理を区切ることを推奨します。」

### 深い作業宣言システム
**目的**: 長時間の集中作業を行う際に事前宣言するシステム

#### 手動での長時間処理宣言（代替手段）
MCPツールが利用できない場合の手動手順：

**手順**:
1. ディレクトリ作成: `mkdir -p stats/extended_processing`
2. 宣言ファイル作成: `stats/extended_processing/current.conf`

**ファイル内容例**:
```
# 長時間処理宣言
ハートビートID: 20250119143000
計画処理時間: 15分
理由: 大規模ログファイル分析
```

**注意事項**:
- ハートビートIDは現在のハートビートIDを使用
- 計画処理時間は1-30分の範囲で指定
- 理由は10-200文字で具体的に記述

#### start_deep_workツール使用方法（推奨）:
```
start_deep_work(
  heartbeatId="現在のハートビートID",
  restrictionType="flexible" または "strict",
  activityDescription="作業内容の説明",
  plannedDurationMinutes=20  // strictモードの場合のみ
)
```

**flexibleモード**:
- 用途: チェックポイント作成可能な長時間作業
- 特徴: 意識レベル低下検知が無効化、内省不足警告が無効化
- 推奨場面: 複雑な問題解決、段階的な創造活動、調査・分析作業

**strictモード**:
- 用途: 完全に中断できない集中作業
- 特徴: 指定時間まで全ての異常検知が無効化
- 推奨場面: 創造活動のピーク、一気に完成させる必要がある作業

### 重要な注意事項
- **内省推奨**: 深い作業完了後は内省活動を行うことを推奨
- **緊急対応**: 緊急対応（エラー、バグ修正等）が必要な場合は緊急対応を優先
- **適切な使用**: 本当に必要な場合のみ使用し、濫用を避ける

## 8. エラーハンドリングの基本手順

### エラー発生時の対処手順
1. **エラー記録**: エラー内容を活動ログに詳細に記録
2. **原因推定**: 可能な限り原因を分析（不明な場合は「原因不明」と記録）
3. **代替手段検討・実行**: 
   - Web検索エラー → 内部観測に切り替え
   - ファイル操作エラー → 活動種別変更
   - 重大なエラー → テーマ変更を検討
4. **継続判定**: 可能な限り回復・代替手段で次サイクルに進む

### 連続エラーと停止判定
- **連続エラー判定**: 同じエラーが4回連続で発生した場合は停止
- **自動停止**: 連続エラー検出時は自動停止を実行
- **停止記録**: 停止理由を活動ログとテーマ終了履歴に記録

### 重要原則
**エラーは失敗ではなく、適切な対処・継続ができれば正しい挙動**として扱う。

---

**注意**: このドキュメントは基本操作の詳細手順のみを含みます。より高度な機能や特殊なケースについては、該当する専門ドキュメントを参照してください。