# 運用詳細ガイド

このドキュメントは、AI心臓システムの運用時に参照する詳細な手順とルールを定義します。

## 1. 活動ログ管理の詳細

### 1.1 ファイル名形式
* **形式**: `YYYYMMDDHHMMSS.md` (例: `20250702140000.md`)
* **ハートビートID**: 受け取ったハートビートメッセージにあるハートビートID（タイムスタンプ形式）を使用
* **保存場所**: `artifacts/{THEME_START_ID_テーマ名}/histories/` ディレクトリ内

### 1.2 記録内容のフォーマット

各活動ログファイルは、以下の構造とルールに従って記録すること：

```markdown
# ハートビートログ：YYYYMMDDHHMMSS

## 活動種別
[実行した活動種別（観測・思考・創造・内省・その他）。補助的な操作を使用した場合は、括弧書きで操作名を追記。例: 思考 (ファイル読み込み使用)]

## 活動内容
[今回のハートビートでの簡潔な活動内容。(詳細は関連ファイルに記載されていることが前提)]

## 成果物、関連ファイル
[このハートビートで作成または修正したファイルの**作業ディレクトリからの相対パス**を列挙(この活動ログファイル自身は除く)。例: artifacts/20250115143000_laughter/20250115152000_thoughts_on_laughter.md]

## 自己評価、備考
[このハートビートでの活動内容の評価やその他特記事項があれば記載。例: Web検索クォータ制限のため、文献調査を中断。]
```

### 1.3 複数タスク実行時の記録
* **活動種別**: 実行した全タスクを記載（例: 思考・創造）
* **活動内容**: 各タスクの内容を分けて記載
* **連番ファイル**: `YYYYMMDDHHMMSS_01.md`等は、活動ログ作成後に修正が必要になった場合のみ使用可能(ただし一回のみ許可)

### 1.4 サブテーマでの活動ログ管理
* **保存場所**: `artifacts/{PARENT_THEME_START_ID_親テーマ名}/subthemes/{THEME_START_ID_サブテーマ名}/histories/`
* **ファイル名**: 通常のテーマと同様に `{ハートビートID}.md` 形式
* **親テーマ情報**: サブテーマの活動ログでは親テーマ情報を意識せず、サブテーマに完全集中した内容を記録
* **統合時の参照**: サブテーマ終了時に親テーマへの統合で活用
* **戦略的分割の記録**: 新規テーマ開始時の専門家コンテキスト検討における比較検討プロセス（1人の専門家 vs 複数の専門家）を活動ログに記録（専門家必要時のみ）
* **統括専門家の記録**: パターンB選択時の統括専門家コンテキスト設定内容を活動ログに記録

### 1.5 MCPツール活用の基本方針

MCPツールは、AIエージェントの自律的で効率的な活動を支援し、システム運用ルールを自動化する総合的な手段です。活動ログ管理においても、定型処理の効率化と正確性向上を実現します。

**create_activity_log ツール**:
- 標準的なフォーマットでの活動ログファイル自動作成
- ハートビートIDを使用した適切なファイル名生成
- 時間制御警告の自動表示
- ルール遵守の自動化（ファイル名、保存場所の統一）

**get_latest_activity_log ツール**:
- 指定されたテーマディレクトリ内の最新活動ログファイルの内容を取得
- 内省活動時の過去ログ参照に特に有用
- 複数ログの一括取得による傾向分析が可能（numLogsパラメータで1-10件指定）
- 連番付きファイル（_01, _02等）も自動で検索対象に含む
- 自律的な情報収集による客観的判断材料の提供

**使用時の注意事項**:
- ツール使用時に警告メッセージが表示された場合は、`ai-docs/MCP_WARNING_GUIDE.md`を参照
- MCPツールは自律的で効率的な活動を支援する総合的手段であり、手動での活動ログ作成・参照も可能

### 1.6 チェックポイントログ管理の詳細

#### 1.6.1 概要と目的
チェックポイントログは、活動ログとは別に作成する軽量な活動記録です。長時間の処理中でも意識的な活動を継続していることをシステムに示すために使用します。

#### 1.6.2 ファイル名形式と保存場所
* **形式**: `YYYYMMDDHHMMSS.txt` (例: `20250702140000.txt`)
* **ハートビートID**: 作成時点の最新ハートビートIDを使用
* **保存場所**: `stats/checkpoints/` ディレクトリ内

#### 1.6.3 作成タイミング
* 長めの処理や連続処理がひと段落した時
* まだ活動ログを記録するような状況でない時
* 最後の活動ログまたはチェックポイントログから10分以内が目安
* flexibleモードの深い作業宣言中は特に推奨

#### 1.6.4 記載内容
簡潔な現在の活動内容を1行で記載：
```
replaceツールのエラー原因の調査中
キャラクター画像作成活動中
データ分析処理の実行中
APIドキュメントの精読中
```

#### 1.6.5 MCPツール活用
**checkpoint ツール**:
- 現在のハートビートIDを自動取得
- チェックポイントファイルの自動作成
- 最後の活動ログからの経過時間表示
- 長時間経過時のstart_deep_work使用案内

**使用方法**:
```
checkpoint(current_activity="現在の活動内容を簡潔に記載")
```

#### 1.6.6 活動ログとの使い分け
* **活動ログ**: 思考・観測・創造・内省等の活動完了時に作成
* **チェックポイントログ**: 活動継続中の中間報告として作成
* **補完関係**: チェックポイントログは活動ログの代替ではなく補完
* **異常検知**: システムは両方のログを考慮して健全性を判定

#### 1.6.7 注意点
* 思考の妨げにならないよう、適当なキリの良いところで作成
* 10分の目安は厳密に守る必要はない
* 過度に頻繁な作成は避ける（5分間隔程度が適切）
* 活動ログ作成予定がある場合は、チェックポイントログは不要


## 2. 時間ベース制御システムの詳細

### 2.1 時間ベース制御の技術仕様

AI心臓システムは時間ベース制御により、適切な活動時間を管理します。

**時間閾値と警告段階**:
- **5分経過**: 処理時間通知（継続可能）
  - MCPツールから「処理時間通知: ハートビート開始から5分が経過しています。」
- **10分経過**: 長時間処理警告（活動完了推奨）
  - MCPツールから「長時間処理警告: ハートビート開始から10分が経過しています。処理を区切ることを推奨します。」
- **10分経過**: システムレベルでの活動ログ頻度異常検知
  - heartbeat.shによる活動ログが作成されない状態（10分間）の検知・回復処理

**MCPツールの時間警告機能**:
- `create_activity_log` 実行時に自動的に時間チェック
- ハートビートIDから経過時間を算出
- 段階的な警告メッセージを表示

### 2.2 長時間処理宣言システム

正当な理由で長時間処理が必要な場合、事前宣言により異常検知を回避できます。

#### 2.2.1 手動での宣言

長時間処理を宣言するには、以下の手順で宣言ファイルを作成します。

**手順**:
1. ディレクトリ作成: `mkdir -p stats/extended_processing`
2. 宣言ファイル作成: `stats/extended_processing/current.conf`

**ファイル内容**:
```
# 長時間処理宣言
ハートビートID: 20250119143000
計画処理時間: 15分
理由: 大規模ログファイル分析
```

**注意事項**:
- ハートビートIDは現在のハートビートIDを使用
- 計画処理時間は1-30分の範囲で指定
- 理由は10-200文字で具体的に記述

#### 2.2.2 MCPツールによる宣言支援（推奨手段）

上記の手動ファイル作成を効率化し、ルール遵守を自動化するため、`declare_extended_processing` MCPツールが提供されています。複雑な時間計算や形式統一を自動化し、エラーを防止します。詳細な使用方法とパラメータはMCPツールの説明を参照してください。

**自動管理機能**:
- **期限管理**: ハートビートIDから期限時刻を自動算出
- **期限切れ削除**: 期限を過ぎた宣言ファイルを自動削除
- **活動ログ連携**: 活動ログ作成時に宣言ファイルを自動削除
- **クリーンアップ**: 異なるハートビートIDの古い宣言を自動削除

## 3. ツール使用制限の詳細

### 3.1 利用制限の確認

`ai-docs/TOOL_RESTRICTIONS.md` を確認し、使用するツールにどのような制限があるか（サイクルベース、時間ベースなど）を確認してください。

### 3.2 時間ベース制限のあるツールの使用報告

`ai-docs/TOOL_RESTRICTIONS.md` に記載されているツールのうち、**時間ベースの制限**を持つツールを使用した後は、システムがクールダウンやロックを正しく管理できるよう、ツールの実行結果を報告する必要があります。報告には以下の方法があります。

#### 3.2.1 手動での状態報告（基本操作）

MCPツールが利用できない場合や、基本的なファイル操作として、以下のコマンドを実行して状態ファイルを手動で作成してください。これが最も確実な方法です。

*   **成功 (`success`) の場合:**
    ツールが正常に完了したことを示すため、クールダウン用のファイルを作成します。
    ```bash
    touch stats/cooldown/{toolId}
    ```
    **例:** `gemini.google.search` が成功した場合
    `touch stats/cooldown/gemini.google.search`

*   **クォータ超過 (`quota_exceeded`) の場合:**
    ツールのAPIクォータ制限に達したことを示すため、ロック用のファイルを作成します。
    ```bash
    touch stats/lock/{toolId}
    ```
    **例:** `gemini.google.search` でクォータエラーが発生した場合
    `touch stats/lock/gemini.google.search`

#### 3.2.2 MCPツールによる報告支援（推奨手段）

上記の手動ファイル作成を効率化し、正確な報告を実現するため、`report_tool_usage` MCPツールが提供されています。ツールID検証や状態管理の自動化により、確実な制限管理を支援します。利用できない場合は上記の手動操作を行ってください。

*   **ツール名:** `report_tool_usage`
*   **引数:**
    *   `toolId`: 使用したツールの一意なID (例: `gemini.google.search`)
    *   `status`: ツールの実行結果 (`success` または `quota_exceeded`)
*   **ツール呼び出し例:** `report_tool_usage({toolId: 'gemini.google.search', status: 'success'})`

## 3. ファイル操作制限の詳細

### 3.1 基本原則
**許可領域**: 作業ディレクトリ配下のみ
**禁止領域**: 作業ディレクトリ以外の全てのファイル・ディレクトリ

### 3.2 作業ディレクトリ内の操作ルール
| ディレクトリ | 操作 | 用途 | 備考 |
|-------------|------|------|------|
| `artifacts/{テーマ}/` | 作成・修正 | テーマ成果物・活動ログ | ファイル名規則あり |
| `artifacts/theme_histories/` | 作成 | テーマ履歴 | MCPツール推奨 |
| `projects/` | 全操作 | 開発プロジェクト | 独立git管理 |
| `stats/` | 作成 | システム状態 | MCPツール経由推奨 |
| `themebox/`, `feedbackbox/` | リネームのみ | 処理済みマーク | processed.プレフィックス |

### 3.3 ファイル作成ルール
* **ファイル名**: 英語で作成
* **ファイル内容**: 日本語で記述（ユーザーリーダブル）

### 3.4 projects/ 運用ルール
* **用途**: 新規開発・既存改善・技術実験・学習等のプロジェクト作業
* **プロジェクト管理**: 各プロジェクトは独立したgitリポジトリとして管理
* **配置ルール**: projects/ 直下にプロジェクト名でディレクトリ作成
* **命名規則**: プロジェクト名はユニークに設定
* **ファイル操作**: プロジェクト内のすべてのファイルの作成・修正・削除が許可
* **言語制限**: プロジェクトの性質に応じて適切な言語を使用（日本語・英語問わず）

### 3.5 厳格な制限事項
**禁止対象**: 作業ディレクトリ以外のファイル・ディレクトリの作成・編集・削除
- システムスクリプト、設定ファイル、ドキュメント等のシステム管理ファイル
- プロジェクトルート直下のファイル

**違反の影響**: システムの安定性を損なう重大な問題となるため、絶対に遵守すること

## 4. エラーハンドリングの詳細手順

### 4.1 エラー発生時の対処手順
以下の順序で対処する：

1. **エラー記録**: エラー内容を活動ログに詳細に記録
2. **原因推定**: 可能な限り原因を分析（不明な場合は「原因不明」と記録）
3. **代替手段検討・実行**: 
   * Web検索エラー → 内部観測に切り替え
   * ファイル操作エラー → 活動種別変更
   * 重大なエラー → テーマ変更を検討
4. **継続判定**: 可能な限り回復・代替手段で次サイクルに進む

### 4.2 連続エラーと停止判定
* **連続エラー判定**: 同じエラーが4回連続で発生した場合は停止
* **自動停止**: 連続エラー検出時は自動停止を実行
* **停止記録**: 停止理由を活動ログとテーマ終了履歴に記録

### 4.3 重要原則
**エラーは失敗ではなく、適切な対処・継続ができれば正しい挙動**として扱う。

## 5. 活動の制限原則

### 5.1 基本理念

AI心臓システムの活動制限は、以下の基本理念に基づいて設計されています：

1. **時間制御優先**: 唯一の実質的制限は適切な時間内での活動完了
2. **自然な思考フロー**: 活動ログ作成は記録手段であり制限の境界ではない
3. **自律的完了判断**: AIが適切なタイミングで完了報告を実行
4. **システム仕様の分離**: 強制的な介入はルールではなくシステム仕様として扱う

### 5.2 運用原則

#### 5.2.1 活動の継続性
* **活動ログ作成後の継続**: 活動ログ作成は記録手段であり、思考フローの継続を妨げない
* **自然な区切り**: AIが自律的に適切な完了タイミングを判断
* **時間制御との調和**: 適切な時間内での活動を基本とし、必要に応じて長時間処理宣言を活用

#### 5.2.2 完了判断の基準
* **論理的完結**: 開始した思考・創造プロセスの論理的な完結点
* **時間的適切性**: システムの時間制御基準（5分推奨、10分警告）との調和
* **成果物の整合性**: 作成した成果物の一貫性と完成度

### 5.3 厳格ルール

以下のルールは、システムの安定性確保のため厳格に遵守すること：

#### 5.3.1 完了報告後の制限
**ハートビート完了報告後は一切の追加作業を禁止**

この制限は、次のハートビートとの境界を明確にし、システムの継続性を保つための技術的要件です。

