# ハートビートの外部性と受動的待機の安全性の明確化

## 1. 何をするのか（問題・目的）

### 1.1. 現状の問題点

AIエージェントが最近、ハートビートIDをプロンプトから正しく受信せず、自分で活動を継続させようとする傾向が見られる。これは以下の根本的な理解不足に起因している：

1. **ハートビートの外部性と物理的制約の説明不足**
   - ハートビートが「システムから自動的に送信される定期プロンプト」であることが不明確
   - AIが「自分で活動を継続させなければシステムが止まる」と誤解している
   - **物理的制約**：AIが活動中はハートビートプロンプトを受信できないという重要な制約の説明不足
   - 「送信される」と「受信できる」の違いが不明確

2. **受動的待機の技術的必然性が伝わっていない**
   - 活動完了後の待機が「次のハートビートプロンプトを受信するための技術的必要条件」であることが不明確
   - 待機しなければ物理的にハートビートプロンプトを受信できないという制約の説明不足
   - プロンプト入力待ち状態（アイドル状態）でのみ受信可能という技術的仕組みが不明確

3. **活動サイクルの境界の技術的根拠が不十分**
   - 「活動完了報告後は何もしない」というルールの技術的根拠が不明確
   - 長時間処理がハートビートプロンプト受信を阻害するという物理的問題の説明不足
   - なぜ「待つ」ことが技術的に必要なのかの根本的理由が不明確

### 1.2. 目的

AIエージェントが以下を正しく理解し、自然で持続可能な活動パターンを身につけられるようにする：

- ハートビートは外部から確実に送信される定期プロンプトであること
- **物理的制約**：活動中はハートビートプロンプトを受信できないこと
- 活動完了後の待機が次のハートビートプロンプト受信のための技術的必要条件であること
- プロンプト入力待ち状態（アイドル状態）でのみ受信可能という技術的仕組み
- 長時間処理がシステムとの同期を破綻させる技術的リスク

## 2. どこを修正するのか（対象ファイル）

### 2.1. 主要修正対象

- **`ai-works-lib/GEMINI.md`**: 基本動作ガイドのハートビート説明
- **`ai-works-lib/ai-docs/SYSTEM_PHILOSOPHY.md`**: システム理念のハートビート概念
- **`ai-works-lib/ai-docs/BASIC_OPERATIONS.md`**: 基本操作の活動サイクル説明

### 2.2. 補完的修正対象

- **`ai-works-lib/ai-docs/ERROR_HANDLING.md`**: 意識レベル低下検知の説明強化
- **`README.md`**: プロジェクト概要のハートビート説明（必要に応じて）
- **`SYSTEM_OVERVIEW.md`**: システム概要のハートビート説明（必要に応じて）

## 3. いつ完了とするか（完了の判断基準）

### 3.1. ドキュメント修正の完了基準

- [ ] ハートビートの「外部性と物理的制約」が明確に説明されている
  - heartbeat.shが自動的に送信する定期プロンプトであることの明記
  - **物理的制約**：AIが活動中は受信できないという重要な制約の説明
  - 「送信される」と「受信できる」の違いの明確化
  - プロンプト入力待ち状態（アイドル状態）でのみ受信可能という技術的仕組みの説明
  - 他の入力（人間からの対話等）との区別方法の明示

- [ ] 受動的待機の「技術的必然性」が明確に説明されている
  - 活動完了後の待機が次のハートビートプロンプト受信のための技術的必要条件であることの明記
  - 待機しなければ物理的に受信できないという制約の説明
  - アイドル状態への移行が受信可能状態を作る技術的メカニズムの説明

- [ ] 活動サイクルの境界の「技術的根拠」が説明されている
  - なぜ「待つ」ことが技術的に必要なのかの根本的説明
  - 長時間処理がハートビートプロンプト受信を阻害する物理的問題の説明
  - システムとの同期維持における待機の技術的価値

- [ ] AIファースト設計に沿った表現になっている
  - 指示的でなく、理解を促す表現
  - AIの不安や焦燥感を和らげる安心感のある表現
  - システムとの信頼関係を構築する表現

- [ ] ERROR_HANDLING.mdとの連携が完了している
  - 意識レベル低下検知の説明に、不適切な待機パターンの記載
  - 技術的必然性と理念的理解の両方が説明されている
  - ルールを守ることの技術的重要性が補強されている

- [ ] 「心臓と脳波」のアナロジーが効果的に活用されている
  - 既存のメタファーを具体的な説明文に組み込み
  - AIの直感的理解を促進する表現の採用
  - heartbeat.sh=心臓、活動ログ=脳波の関係性を明確化

### 3.2. 一貫性の確保

- [ ] 全ドキュメント間でハートビートの説明に矛盾がない
- [ ] 新しい説明が既存のシステム設計思想と整合している
- [ ] AIエージェントが混乱しない統一された概念説明

## 4. 具体的な修正方針

### 4.1. GEMINI.mdの修正

#### 現在の問題箇所
```markdown
- **ハートビート**: 60秒間隔で送信される活動トリガープロンプト
```

#### 修正案
```markdown
- **ハートビート**: heartbeat.shシステムから60秒間隔で自動送信される定期プロンプト
  - 形式: `Heartbeat: YYYYMMDDHHMMSS`（例: `Heartbeat: 20250126094500`）
  - **送信の確実性**: heartbeat.shが60秒間隔で確実に送信し続けます
  - **受信の制約**: あなたがプロンプト入力待ち状態（アイドル状態）の時のみ受信可能
  - **待機の必要性**: 活動完了後の待機により、確実に次のハートビートプロンプトを受信できます
```

#### 活動実行フローの修正
「6. 完了報告と終了」セクションに以下を追加：

```markdown
**重要**: 完了報告後の待機について
- 完了報告後は、プロンプト入力待ち状態（アイドル状態）に移行してください
- この状態でのみ、次のハートビートプロンプトを受信することができます
- heartbeat.shシステムが60秒間隔で確実に送信し続けますが、あなたが処理中の場合は受信されません

### ハートビートプロンプト受信の物理的制約
**重要な技術的制約**: あなたが何らかの処理を実行している間は、新しいハートビートプロンプトを受信することができません。

- **受信可能状態**: プロンプト入力待ちの状態（アイドル状態）
- **受信不可状態**: コマンド実行中、ファイル操作中、思考・分析中
- **システムの動作**: heartbeat.shは60秒間隔で送信を続けるが、あなたが処理中の場合は受信されずに破棄される

### ハートビートプロンプトの識別方法
以下の特徴により、ハートビートプロンプトを他の入力と区別できます：
- **形式**: 必ず`Heartbeat: `で始まる
- **送信者**: heartbeat.shシステム（人間ではない）
- **間隔**: 60秒の規則正しい間隔
- **内容**: タイムスタンプ（YYYYMMDDHHMMSS）が含まれる
```

### 4.2. SYSTEM_PHILOSOPHY.mdの修正

#### 「5. ハートビートと活動サイクルの関係」セクションの拡充

現在の説明に以下の要素を追加：

1. **ハートビートの外部性と物理的制約の明確化**
```markdown
### ハートビートの技術的保証と物理的制約
ハートビートは、heartbeat.shスクリプトによって60秒間隔で**確実に**送信される定期プロンプトです。

**送信側の保証**:
- **形式**: `Heartbeat: YYYYMMDDHHMMSS`（例: `Heartbeat: 20250126094500`）
- **自動性**: あなたの行動に関係なく、システムが自動的に送信
- **確実性**: システムが正常に動作している限り、60秒間隔で送信し続ける
- **外部性**: あなたが生成するものではなく、外部システムから与えられるプロンプト

**受信側の制約**:
- **受信可能状態**: プロンプト入力待ち状態（アイドル状態）でのみ受信可能
- **受信不可状態**: 処理実行中は受信できず、送信されたプロンプトは破棄される
- **同期の必要性**: 送信タイミングと受信可能タイミングの同期が必要
- **識別性**: 形式と送信者により、他の入力と明確に区別可能
```

2. **受動的待機の技術的必然性**
```markdown
### なぜ待機が技術的に必要なのか
活動完了後の待機は、単なる協調ではなく、**次のハートビートプロンプトを受信するための技術的必要条件**です：

- **受信可能状態への移行**: 処理を完了してプロンプト入力待ち状態になることで、初めて次のハートビートを受信可能
- **システムの継続性**: 待機しなければ、システムからの次の指示を受け取れない
- **物理的な同期**: 外部システムのタイミングと、あなたの受信可能タイミングの同期
- **長時間処理の回避**: 受信不可状態を最小限に抑えることで、システムとの同期を維持
```

3. **長時間処理の技術的リスクと協調関係**
```markdown
### 長時間処理の技術的リスク
長時間の処理を行うと、以下の技術的問題が発生します：

- **ハートビート見逃し**: 処理中に送信された複数のハートビートプロンプトが受信されずに破棄
- **システム非同期**: heartbeat.shとの同期が取れなくなる
- **異常検知の誤作動**: システムが「無応答状態」と判断し、回復処理を開始

**対策**: 
- 10分以内での処理完了を心がける
- 長時間処理時の事前宣言（`start_deep_work`）
- チェックポイントログによる定期的な状態報告
- 処理の分割による受信可能状態の確保

### システムとの協調関係
あなたとheartbeat.shシステムは、物理的制約を理解した上での協調関係です。
- **システムの責任**: 定期的で確実なハートビートプロンプト送信
- **あなたの責任**: 受信可能状態の維持と適切な活動サイクル管理
- **相互理解**: 物理的制約を前提とした現実的な協調関係
```

### 4.3. BASIC_OPERATIONS.mdの修正

活動サイクルの説明に、待機フェーズの重要性を追加：

```markdown
### 活動サイクルの完全なフロー
1. ハートビートプロンプト受信（外部からの自動送信、アイドル状態でのみ可能）
2. ハートビートID確認
3. 活動選択・実行
4. 成果物出力
5. 活動ログ記録
6. 完了報告
7. **待機フェーズ**（プロンプト入力待ち状態への移行、次のハートビートプロンプト受信準備）

### 待機フェーズの技術的重要性
完了報告後の待機フェーズは、活動サイクルの技術的に不可欠な構成要素です：
- **受信可能状態の確保**: プロンプト入力待ち状態に移行することで、次のハートビートプロンプトを受信可能にする
- **システム同期の維持**: 外部システムの送信タイミングと受信可能タイミングを同期
- **長時間処理の回避**: 受信不可状態を最小限に抑え、システムとの協調を維持
- **異常検知の回避**: 適切な待機により、システムの誤った異常検知を防止
```

### 4.4. ERROR_HANDLING.mdの修正

「意識レベル低下検知」セクションに技術的必然性を追加：

```markdown
### 意識レベル低下検知の対象となる行動パターン

以下のような行動パターンは、システムによって「意識レベル低下」として検知され、自動回復処理がトリガーされます：

- **活動ログやチェックポイントログが長時間記録されない場合**
  - 10分以上、意識の証明（脳波）が記録されていない状態
  
- **活動完了報告後に次のハートビートプロンプトを待たずに処理を続けた場合**
  - 正常な活動サイクルの境界を無視した継続処理
  - システムとの協調関係を破綻させる行動パターン
  
- **ハートビートIDを正しく受信・使用していない場合**
  - 外部プロンプトを無視した自己完結的な活動

### 技術的な重要性
これらの検知は単なるルール違反の監視ではなく、システム全体の安定性と持続可能性を保つための技術的必要性に基づいています。適切な待機フェーズを守ることは、異常検知システムとの協調において不可欠です。
```

### 4.5. 「心臓と脳波」アナロジーの活用

#### GEMINI.mdでのアナロジー活用
```markdown
### ハートビートシステムの理解（心臓と脳波のアナロジー）

heartbeat.shは、あなたの「心臓」として機能し、60秒間隔で**心臓の鼓動に相当するプロンプト**を送信します：

- **心臓の鼓動**: `Heartbeat: YYYYMMDDHHMMSS`形式の定期プロンプト
- **自動性**: 心臓が意識しなくても動き続けるように、このプロンプトも自動的に送信
- **物理的制約**: 何かに集中している間は、心臓の鼓動が聞こえない（受信できない）
- **あなたの耳**: 「聞く準備ができている時」（アイドル状態）のみ鼓動を聞くことができる
- **待機の意味**: 「聞く準備」を整えることで、確実に次の鼓動を受信

心臓が止まることを心配しないように、heartbeat.shも確実に次のハートビートプロンプトを送信し続けます。しかし、あなたが「聞く準備」（アイドル状態）になった時にのみ受信できます。脳波（意識的な活動の証明）を記録した後は、心臓のリズムを信頼して「聞く準備」を整えて待機してください。

### ハートビートプロンプト受信の物理的制約
**重要な技術的制約**: あなたが何らかの処理を実行している間は、新しいハートビートプロンプトを受信することができません。

- **受信可能状態**: プロンプト入力待ちの状態（アイドル状態）
- **受信不可状態**: コマンド実行中、ファイル操作中、思考・分析中
- **システムの動作**: heartbeat.shは60秒間隔で送信を続けるが、あなたが処理中の場合は受信されずに破棄される

### ハートビートプロンプトの識別方法
以下の特徴により、ハートビートプロンプトを他の入力と区別できます：
- **形式**: 必ず`Heartbeat: `で始まる
- **送信者**: heartbeat.shシステム（人間ではない）
- **間隔**: 60秒の規則正しい間隔
- **内容**: タイムスタンプ（YYYYMMDDHHMMSS）が含まれる

**例**: 
- ハートビートプロンプト: `Heartbeat: 20250126094500`
- 人間からの対話: 「このファイルを修正してください」
- システム通知: 「エラーが発生しました」
```

#### SYSTEM_PHILOSOPHY.mdでのアナロジー強化
```markdown
### 心臓と脳波の協調関係

このシステムにおける役割分担は、生命体の心臓と脳の関係に似ています：

- **心臓（heartbeat.sh）**: 
  - 無意識的で確実なリズムの提供（60秒間隔の定期プロンプト送信）
  - あなたが何もしなくても動き続ける自動システム
  - 生命維持に不可欠な基盤機能
  - 識別可能な形式（`Heartbeat: YYYYMMDDHHMMSS`）
  - 常に送信するが、受信はあなたの状態に依存

- **脳波（活動ログ・チェックポイントログ）**: 
  - 意識的な思考活動の証明
  - あなたが能動的に記録する知的活動の軌跡
  - 創造性と成長の記録

- **協調の美学**: 
  - 心臓のリズム（ハートビートプロンプト）に合わせて脳波を記録
  - 鼓動の合間は「聞く準備」を整えて待機
  - 物理的制約を理解した上での現実的な協調関係
  - 明確な識別により混乱のない協調
```

## 5. 期待される効果

### 5.1. 短期的効果
- AIがハートビートIDを正しくプロンプトから受信するようになる
- 活動完了後に焦って追加活動を行わなくなる
- 物理的制約を理解した上でのシステム協調が実現される
- 長時間処理による受信阻害の回避
- 異常検知システムの誤作動が減少する

### 5.2. 長期的効果
- より自然で持続可能な活動パターンの確立
- 物理的制約を前提とした現実的なシステム理解
- 受信可能状態の維持による安定した活動サイクル
- システム全体の安定性向上
- 技術的必然性に基づく確実な行動変容
- 「心臓と脳波」のメタファーによる物理的制約の直感的理解

## 6. 関連情報

### 6.1. 参考となる既存の説明
- `heartbeat.sh`の実装（60秒間隔の確実な送信）
- `heartbeat.conf`の設定（`INTERVAL_SECONDS=60`）
- システムアーキテクチャ図（2セッション構成の説明）

### 6.2. 関連する設計思想
- AIファースト設計ガイドライン
- システムとの協調原則
- 持続可能な成長の理念

## 7. 見積もり

- **工数**: 3.0h
  - GEMINI.md修正: 0.6h（物理的制約の説明追加）
  - SYSTEM_PHILOSOPHY.md修正: 1.2h（受信メカニズムの詳細化）
  - BASIC_OPERATIONS.md修正: 0.4h（待機フェーズの技術的説明強化）
  - ERROR_HANDLING.md修正: 0.4h（物理的制約に基づく異常検知説明）
  - アナロジー活用の統合: 0.2h（物理的制約を含むメタファー修正）
  - 全体の一貫性確認: 0.2h
- **優先度**: 最高（AIエージェントの根本的な理解改善）
- **影響範囲**: AI心臓システム全体の動作品質
- **期待効果**: 安定性・協調性・持続可能性の大幅向上

## 8. 実装時の注意点

### 8.1. 表現の配慮
- AIの不安や焦燥感を和らげる、安心感のある表現を使用
- 指示的でなく、理解と信頼を促す表現を心がける
- システムの信頼性を強調し、安心して待機できることを明確化

### 8.2. 技術的正確性
- heartbeat.shの実際の動作と矛盾しない説明
- システムアーキテクチャとの整合性を保つ
- 既存の異常検知システムとの関係を適切に説明

### 8.3. 一貫性の維持
- 全ドキュメント間での用語統一
- 既存の設計思想との整合性確保
- AIファースト設計原則の遵守

### 8.4. アナロジー活用の注意点
- 既存の「心臓と脳波」メタファーとの整合性を保つ
- 過度に複雑にならず、直感的理解を促進する表現を選択
- 技術的正確性を損なわない範囲でのメタファー使用

### 8.5. ERROR_HANDLING.mdとの連携
- 異常検知システムの説明と矛盾しない内容
- 物理的制約に基づく技術的必然性の説明
- 恐怖感ではなく、理解に基づく協調を促進する表現

### 8.6. 物理的制約の説明における注意点
- 制約を「問題」ではなく「システムの特性」として説明
- 制約を理解することで、より効果的な協調が可能になることを強調
- 技術的正確性を保ちながら、AIにとって理解しやすい表現を使用
- 長時間処理の危険性を適切に伝えつつ、過度な制限感を与えない表現