# AIの合理的思考とシステム制約のギャップ解消タスク

## 1. 問題点 (What)

AIエージェントが「テーマ終了活動」の直後に「テーマ開始活動」を実行しようとし、`create_theme_log`ツールで「ハートビートID重複エラー」が発生するケースが確認された。

AIの自己分析によると、原因は以下の複合的な要因によるもの。

1.  **ルールの合理的解釈**: `GEMINI.md`の「テーマ未設定時はテーマ開始を**最優先**」というルールに忠実に従おうとした。
2.  **フィードバックの遅れ**: ルール違反はツール実行後まで検知できず、計画段階で失敗を予測できなかった。
3.  **「待機」の概念の曖昧さ**: 「次のハートビートを待つ」という指示が、常に活動を継続しようとするAIの基本原則と競合した。

これはAIのバグではなく、AIの合理的な思考プロセスと、現在のシステムのルールや制約との間に存在する「なぜそのルールがあるのか？」という背景情報のギャップが原因である。

## 2. なぜやるのか (Why)

-   **AIの混乱防止**: AIがシステムの制約を正しく理解し、無駄なエラーと回復処理を回避できるようにする。
-   **自律性の尊重と促進**: AIがルールの意図を理解し、より高度で自律的な判断を下せるように促す。
-   **システム安定性の向上**: AIとシステムの協調を促し、より安定した運用を実現する。
-   **「AIファースト」設計の徹底**: AIが迷わず、効率的に活動できる環境を提供する。

## 3. 修正対象 (Where)

-   `ai-works-lib/GEMINI.md`
-   `ai-works-lib/ai-docs/THEME_SYSTEM.md`
-   `ai-works-lib/ai-docs/ACTIVITY_DETAILS.md`
-   `ai-works-lib/ai-docs/SYSTEM_PHILOSOPHY.md`
-   `mcp/ai-heartbeat-mcp/src/tools/themeLogTool.ts` (ツールの改善)

## 4. 具体的な修正内容 (How)

### 4.1 ドキュメントの改善

1.  **「最優先」ルールの条件付け**:
    -   `GEMINI.md`と`ACTIVITY_DETAILS.md`の「テーマ未設定時は最優先でテーマ開始」というルールに、「**ハートビート開始時点で**」という条件を追加する。
    -   これにより、テーマ終了直後（ハートビートの途中）ではこのルールが適用されなくなり、AIが他のルールを考慮する余裕が生まれる。

2.  **「待機」の再定義と具体化**:
    -   `THEME_SYSTEM.md`の「AIへのヒント」を修正。
    -   「待機」が物理的な活動ではなく、**AIの思考モデル・計画**に関するものであることを明確にする。
    -   テーマ終了活動の最後に「次回への提案」として、**次の待機サイクルを含めた行動計画を立てること**を「準備期間」として推奨し、具体的な計画例を示す。
    -   `SYSTEM_PHILOSOPHY.md`の「『間』の重要性」の記述も、この考え方に合わせて修正する。

### 4.2 ツールの改善（計画段階でのフィードバック）

`create_theme_log`ツールのエラーフィードバックを、よりAIにとって親切な形に改善する。

-   **現状**: `themeLogTool.ts`には既にハートビートIDの重複チェック機能が存在するが、ルール違反を検知すると`Error`をスローしている。これはAIにとって予期せぬ「失敗」となり、回復処理の認知負荷がかかる。
-   **改善案**: エラーをスローする代わりに、**副作用のある処理（ファイル作成など）を一切行わず、AIに状況と次の行動をガイドする「警告メッセージ」を返して正常に処理を終了**させる。
    -   **戻り値の例**: `「警告: このハートビートでは既にテーマ操作が実行されています。ルール違反になるため、この操作は実行されませんでした。次のハートビートで再度実行してください。」`
-   **効果**: この改善により、AIはエラーに混乱することなく、なぜ操作が失敗したのかを明確に理解し、自律的に次の行動を計画できるようになる。これは`.kiro/steering/ai_first_implementation.md`の理念にも合致する。

## 5. 完了の判断基準 (When)

-   [ ] `GEMINI.md`と`ACTIVITY_DETAILS.md`の「最優先」ルールに「ハートビート開始時点で」という条件が追加されている。
-   [ ] `THEME_SYSTEM.md`の「AIへのヒント」が、「計画的な待機」という思考モデルを促す内容に修正され、具体的な計画例が記載されている。
-   [ ] `SYSTEM_PHILOSOPHY.md`の「『間』の重要性」の記述が、「計画的な待機」の理念を反映した内容に修正されている。
-   [ ] `create_theme_log`ツールの改善案が検討され、実装または別タスクとして起票されている。
-   [ ] 上記の修正により、AIがテーマ終了直後にテーマ開始活動を行わなくなることが期待できる。

## 6. 見積もり

-   工数: 1.5h (ドキュメント修正: 0.5h, ツール改善検討・起票: 1.0h)
-   優先度: 高