# スナップショット機能の実装

## 1. 概要

### 1.1. 目的
チュートリアル完了直後の状態（`ai-works`ディレクトリとチャット履歴）を「スナップショット」として保存・復元する機能を実装する。
これにより、新しい環境でのセットアップ時に毎回チュートリアルを実行する手間とコスト（時間、AIトークン）を削減し、開発や実験のサイクルを高速化する。

### 1.2. 背景
現状、`setup.sh`で新しい環境を構築するたびに、AIは同じチュートリアルを最初から実行する必要がある。これは特に、機能開発のテストや新しいテーマの実験を頻繁に行う場合に非効率である。

---

## 2. 機能要件

### 2.1. スナップショットの作成
- スナップショット名をなんらかの方法で指定する
- 現在の`ai-works`ディレクトリ全体を単一のアーカイブファイル（例: `.tar.gz`）として`snapshots/スナップショット名`ディレクトリに保存する。
- 現在の`gemini cli`のチャット履歴を`chat save スナップショット名`機能で保存する。

### 2.2. スナップショットからの復元
- `setup.sh`にスナップショットを指定するオプションを追加する。
- 指定されたスナップショットから`ai-works`ディレクトリのアーカイブを展開し、配置する。
  - 既存の`ai-works`があった場合はリネームしてバックアップする。(既存のバックアップと同じ)
- `gemini cli`を起動し、`chat resume スナップショット名`でチャット履歴を復元する。
- 復元後、themeboxに追加テーマを手動配置後に、restart.shで活動を再開する。

---

## 3. 実装方針

### 3.1. ディレクトリ構造
プロジェクトルートに`snapshots/`ディレクトリを新設し、スナップショットを管理する。

```
snapshots/
└── tutorial-completed-v0.1.7/   # スナップショット名
    └── ai_works.tar.gz           # ai-worksディレクトリのアーカイブ
```

### 3.2. スナップショット作成の自動化
スナップショット作成は、専用のテーマとして実装し、チュートリアル完了後に自動実行する。

**実行フロー:**
1. チュートリアル完了後、スナップショット作成テーマが自動的に開始される
2. AIが`stop.sh`を実行してハートビートを停止し、クールダウン状態に入る
3. クールダウン中に以下の処理を実行：
   - `snapshots/tutorial-completed/` ディレクトリを作成
   - `tmux send-keys -t agent "/chat save tutorial-completed"` でチャット履歴を保存
   - `tar`コマンドで `ai-works/` ディレクトリを `snapshots/tutorial-completed/ai_works.tar.gz` にアーカイブ
4. スナップショット作成完了後、`restart.sh`でシステムを再開

**テーマ実装:**
- `create-snapshot-theme.md` として専用テーマファイルを作成
- 一度実行したら重複実行されないよう、実行済みフラグ（`ai-works/stats/snapshot_created.flag`）で制御

### 3.3. `setup.sh` の拡張
`--snapshot` オプションを追加し、スナップショットからの復元機能を実装する。

**処理フロー:**
1. `setup.sh --snapshot` が指定された場合、スナップショット復元モードで動作
2. 通常の`ai-works-lib`からのコピー処理をスキップ
3. `snapshots/tutorial-completed/ai_works.tar.gz` を展開し、`ai-works/` として配置
4. 既存の`ai-works`がある場合は、通常のバックアップ処理と同様にリネーム保存
5. agentセッション、heartbeatセッションを作成
6. `tmux send-keys -t agent "/chat resume tutorial-completed"` でチャット履歴を復元
7. 復元完了後、themeboxに追加テーマを手動配置してから`restart.sh`で活動再開

---

## 4. 実装方針と考慮事項

### 4.1. 段階的開発アプローチ
**第1段階（MVP）**: 正常パターンの実装と動作確認
- 基本的なスナップショット作成・復元機能の実装
- チュートリアル完了後の自動スナップショット作成
- `setup.sh --snapshot`による復元機能

**第2段階（将来的な拡張）**: 詳細機能の追加
- エラーハンドリングの強化
- バージョン管理機能
- スナップショット管理機能（一覧表示、検証等）

### 4.2. 現段階で対応しない項目
以下の項目は基本機能の動作確認後に検討する：
- **詳細なエラーハンドリング**: 復元失敗時の自動回復等
- **バージョン管理**: システムバージョンとの対応関係管理
- **スナップショット管理**: 複数スナップショットの管理機能

### 4.3. 設計上の考慮事項
- **状態の整合性**: チュートリアル完了直後のクリーンな状態でスナップショット作成
- **重複実行防止**: フラグファイルによる一度限りの実行制御
- **システム統合**: 既存のstop.sh/restart.shとの連携

---

## 5. 完了の定義

### 5.1. 基本機能の動作確認
- チュートリアル完了後にスナップショット作成テーマが自動実行され、正常にスナップショットが作成されること
- `setup.sh --snapshot` を実行した際に、`ai-works`ディレクトリとチャット履歴が正しく復元されること
- 復元された環境でAIエージェントが起動し、チュートリアル完了後の状態から問題なく活動を再開できること

### 5.2. 実装成果物
- スナップショット作成テーマファイル（`create-snapshot-theme.md`）
- `setup.sh`への`--snapshot`オプション追加
- 適切なディレクトリ構造（`snapshots/tutorial-completed/`）の作成

### 5.3. 動作検証
- 新しい環境で`setup.sh --snapshot`を実行し、チュートリアルをスキップして即座に活動開始できることを確認
- スナップショット作成の重複実行が適切に防止されることを確認

### 5.4. ドキュメント更新
- 関連するドキュメント（`README.md`など）に、スナップショット機能の使用方法を追記