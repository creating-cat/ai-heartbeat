# 内省関連エラーの警告レベル化リファクタリング

## 概要

現在の内省関連のエラーレベル処理を警告レベルに変更し、内省義務違反システムを完全に削除することで、より自然で自律的な内省活動を促進するシステムに改善する。

## 背景・理由

### 現在の問題
- 内省不足でシステム強制中断が発生し、創造活動が不必要に妨げられる
- 内省義務違反システムが複雑で、自律性を阻害している
- エラーレベルの処理が内省の本質（自発的な振り返り）に合わない

### 改善の方向性
- 内省は「システムの機能不全」ではなく「活動の質的改善点」として扱う
- 警告による気づき → 自律的な内省 のフローを重視
- システムの複雑性を軽減し、保守性を向上

## 修正対象と方針

### 1. heartbeat.sh の修正

#### 1.1 check_recent_activity() 関数のcase文修正

**現在の問題**:
```bash
17) # 内省活動警告 → 警告メッセージ表示、処理継続
18) # 内省活動エラー → handle_failure() 呼び出し（回復処理実行）
22) # 内省義務違反 → handle_failure() 呼び出し（回復処理実行）
```

**修正方針**:
```bash
17) # 内省活動警告（軽度） → 軽い警告メッセージ、処理継続
18) # 内省活動警告（重度） → 強い警告メッセージ、処理継続
22) # ケース削除（内省義務システム廃止）
```

**具体的な修正内容**:
- コード18: `handle_failure()` 呼び出しを削除し、警告メッセージ表示に変更
- コード22: ケース全体を削除
- 警告メッセージの段階的差別化（軽度・重度）

#### 1.2 attempt_recovery() 関数の整理

**削除対象**:
```bash
case "$detection_type" in
    "活動ログ内省不足") # 削除
    "内省義務違反")     # 削除
```

**修正方針**: 内省関連のケースを完全削除

#### 1.3 特定ドキュメント決定部分の整理

**削除対象**:
```bash
case "$detection_type" in
    "活動ログ内省不足"|... # 内省不足部分を削除
    "内省義務違反")        # 削除
```

#### 1.4 check_agent_health() 関数の修正

**削除対象**:
```bash
# 内省義務違反チェック（新機能）
detect_deep_work_completion
check_introspection_obligation_violation
```

**修正方針**: 内省義務関連の処理を完全削除

### 2. health_check_core.sh の修正

#### 2.1 削除対象の関数群

**完全削除**:
- `create_introspection_obligation()`
- `clear_introspection_obligation()`
- `is_introspection_exception()`
- `detect_deep_work_completion()`
- `check_introspection_obligation_violation()`

#### 2.2 check_introspection_activity_anomaly() の動作確認

**現在の戻り値**:
- 0: 正常
- 1: 警告レベル（2/3閾値超過）
- 2: エラーレベル（閾値超過）
- 3: 通知レベル（1/2閾値超過）

**修正方針**: 戻り値の意味は変更せず、heartbeat.sh側でエラーレベル(2)を警告として扱う

### 3. config.sh の修正

#### 3.1 削除対象

**完全削除**:
```bash
readonly ADVICE_INTROSPECTION_OBLIGATION
```

#### 3.2 ADVICE_INTROSPECTION の見直し

**修正方針**: 内容は基本的に維持、必要に応じて表現を緩和

### 4. MCPツール (startDeepWorkTool.ts) の修正

#### 4.1 ツール説明文の修正

**現在**:
```typescript
**flexibleモード**: チェックポイント作成可能、内省不足エラーのみ無効化
**strictモード**: 指定時間まで全ての異常検知を無効化

活動ログ作成時に宣言は自動的に解除されます。深い作業完了後は必ず内省活動を行ってください。
```

**修正後**:
```typescript
**flexibleモード**: チェックポイント作成可能、内省不足警告を無効化
**strictモード**: 指定時間まで全ての異常検知を無効化

活動ログ作成時に宣言は自動的に解除されます。
```

#### 4.2 アドバイスメッセージの修正

**現在**:
```typescript
- 内省不足エラーは無効化されます
- 内省不足エラーも無効化されます
```

**修正後**:
```typescript
- 内省不足警告は無効化されます
- 内省不足警告も無効化されます
```

#### 4.3 実行時メッセージの修正

**現在**:
```typescript
responseText += '\n\n**重要**: 深い作業完了後は必ず内省活動を行ってください。';
```

**修正後**:
```typescript
responseText += '\n\n**推奨**: 深い作業完了後は内省活動を行うことを推奨します。';
```

### 5. ファイルシステムの整理

#### 5.1 削除対象ディレクトリ

**削除**:
```bash
ai-works/stats/introspection_obligation/
```

**修正方針**: システム起動時または初回実行時に自動削除

## 実装手順

### Phase 1: heartbeat.sh の修正
1. check_recent_activity() 関数のcase文修正
2. attempt_recovery() 関数の整理
3. check_agent_health() 関数の修正

### Phase 2: health_check_core.sh の修正
1. 内省義務関連関数の削除
2. 不要なコメント・変数の整理

### Phase 3: config.sh の修正
1. ADVICE_INTROSPECTION_OBLIGATION の削除
2. 必要に応じてADVICE_INTROSPECTION の調整

### Phase 4: MCPツールの修正
1. startDeepWorkTool.ts の説明文・メッセージ修正
2. TypeScriptビルドとテスト

### Phase 5: 動作確認とクリーンアップ
1. システム全体の動作確認
2. 不要ディレクトリの削除
3. ドキュメントの更新

## 期待される効果

### 1. システム安定性の向上
- 不要な強制中断の排除
- より自然な活動フローの実現

### 2. ユーザー体験の改善
- 創造活動への影響最小化
- 自律的な内省への誘導

### 3. 保守性の向上
- 約200行のコード削除
- 複雑な状態管理の排除
- テストケースの簡素化

### 4. 設計思想との整合
- AI心臓システムの「自律性」理念に合致
- 内省の本質（自発的振り返り）の尊重

## 注意事項

### 1. 後方互換性
- 既存の内省義務ディレクトリが残っている場合の処理
- 設定ファイルの互換性確保

### 2. 段階的な警告システム
- 軽度・重度警告の適切な差別化
- メッセージ内容の効果的な設計

### 3. 動作確認項目
- 内省不足警告の正常動作
- 深い作業宣言との連携
- MCPツールとの整合性

### 6. setup.sh の修正

#### 6.1 内省義務ディレクトリ作成の削除

**現在の問題**:
```bash
mkdir -p "ai-works/stats/introspection_obligation"
```

**修正方針**: この行を削除

### 7. ai-works-lib配下のドキュメント修正

#### 7.1 ACTIVITY_DETAILS.md の修正

**削除対象セクション**:
- `### 深い作業後の内省義務`
- `#### 内省義務の概要`
- `#### 内省義務が発生する条件`
- `#### 内省義務の履行方法`
- `#### 例外的な場合`

**修正方針**: 内省義務関連のセクションを完全削除し、一般的な内省活動の推奨に変更

#### 7.2 ERROR_HANDLING.md の修正

**削除対象**:
```markdown
#### 5. 内省義務違反 (Introspection Obligation Violation)
```

**修正対象**:
```markdown
- **義務**: 深い作業完了後は、必ず内省活動を行う義務があります。
```
↓
```markdown
- **推奨**: 深い作業完了後は内省活動を行うことを推奨します。
```

#### 7.3 ADVANCED_FEATURES.md の修正

**修正対象**:
```markdown
- **内省不足エラー無効化**: 長時間の集中作業中の内省義務を一時的に緩和
```
↓
```markdown
- **内省不足警告無効化**: 長時間の集中作業中の内省不足警告を一時的に無効化
```

**修正対象**:
```markdown
**重要**: 深い作業完了後は必ず内省活動を実行
```
↓
```markdown
**推奨**: 深い作業完了後は内省活動を行うことを推奨します
```

**削除対象**:
```markdown
- **緊急対応**: エラー修正やバグ対応等は内省義務の例外
- **システム問題**: システム異常への対応は内省義務を一時的に免除
```

#### 7.4 BASIC_OPERATIONS.md の修正

**修正対象**:
```markdown
- **内省義務**: 深い作業完了後は必ず内省活動を行う
- **例外処理**: 緊急対応（エラー、バグ修正等）は内省義務の例外
```
↓
```markdown
- **内省推奨**: 深い作業完了後は内省活動を行うことを推奨します
```

**修正対象**:
```markdown
- 特徴: 活動ログ頻度異常検知が無効化、内省不足エラーが無効化
```
↓
```markdown
- 特徴: 活動ログ頻度異常検知が無効化、内省不足警告が無効化
```

#### 7.5 TOOL_USAGE.md の修正

**修正対象**:
```markdown
- 内省不足エラーのみ無効化
```
↓
```markdown
- 内省不足警告のみ無効化
```

**修正対象**:
```markdown
- **完了後の内省**: 深い作業完了後は必ず内省活動を実行
```
↓
```markdown
- **完了後の内省**: 深い作業完了後は内省活動を行うことを推奨します
```

## 実装手順（更新版）

### Phase 1: heartbeat.sh の修正
1. check_recent_activity() 関数のcase文修正
2. attempt_recovery() 関数の整理
3. check_agent_health() 関数の修正

### Phase 2: health_check_core.sh の修正
1. 内省義務関連関数の削除
2. 不要なコメント・変数の整理

### Phase 3: config.sh の修正
1. ADVICE_INTROSPECTION_OBLIGATION の削除
2. 必要に応じてADVICE_INTROSPECTION の調整

### Phase 4: setup.sh の修正
1. 内省義務ディレクトリ作成行の削除

### Phase 5: MCPツールの修正
1. startDeepWorkTool.ts の説明文・メッセージ修正
2. TypeScriptビルドとテスト

### Phase 6: ai-works-lib配下ドキュメントの修正
1. ACTIVITY_DETAILS.md の内省義務セクション削除
2. ERROR_HANDLING.md の内省義務違反セクション削除
3. ADVANCED_FEATURES.md の表現修正
4. BASIC_OPERATIONS.md の表現修正
5. TOOL_USAGE.md の表現修正

### Phase 7: 動作確認とクリーンアップ
1. システム全体の動作確認
2. 不要ディレクトリの削除
3. ドキュメントの整合性確認

## 完了基準

1. 内省関連のエラーレベル処理が完全に削除されている
2. 内省義務違反システムが完全に削除されている
3. 警告レベルの内省不足検知が正常に動作している
4. MCPツールの説明文が修正されている
5. setup.shから内省義務ディレクトリ作成が削除されている
6. ai-works-lib配下の全ドキュメントで内省義務関連記述が修正されている
7. システム全体が安定して動作している
8. 不要なファイル・ディレクトリが削除されている

## リスク評価

### 低リスク
- 機能削除による影響は限定的
- 内省不足警告システムは残るため、基本機能は維持

### 中リスク
- 既存の内省義務ディレクトリの処理
- MCPツールとの連携確認
- ドキュメント間の整合性確保

### 対策
- 段階的な実装とテスト
- バックアップの作成
- ロールバック手順の準備
- ドキュメント修正後の全体整合性確認