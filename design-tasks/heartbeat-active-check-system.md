# ハートビート活動状態チェックシステム改善

## 現状の仕組みと問題点

* 基本的に現状は活動ログのタイムスタンプをみて、活動状態の異常検知している。
  * 異常検知されないためには活動ログを定期的に作成する必要がある
    * 長期間処理したい時の思考の妨げになる
    * declare_extended_processingツールによる回避もできるが、予期せぬ長期処理に対応できない。
* また、一定時間内省がない場合も異常検知している。
  * これもなんらかの長時間処理したい時や集中作業したい場合に、内省が邪魔になってしまう場合がある。
    * declare_extended_processingツールによる回避もできるが、予期せぬ長期処理に対応できない。

## 解決策
* 活動ログとは別に、チェックポイントログを作成する
  * ai-works/stats/checkpoints/{ハートビートID}.txt
    * AIエージェントが作成時のハートビートIDを使用してファイルを作成
    * 現在の活動内容を簡潔に記載。
  * AIエージェントが意識的に活動を行っていることを証明するもの
  * 異常検知において、checkpoints配下にあるファイルのハートビートIDのタイムスタンプを、意識的に活動している最終日時とみなす。
    * 正確には最新の活動ログのハートビートIDとこちらの最新のハートビートIDの新しい方を意識的に活動している最終日時とみなす。
    * AIエージェントは長期活動中にこのcheckpointsのファイルを作成することで、活動ログの作成の停滞はループや無活動によるものではなく、意識的に長期活動中であることを示して、異常検知を回避することができる。

* 長期活動時の内省不足チェックの回避と、長期活動後の内省を義務化
  * ルールとして、深い作業後は必ず内省をすることを義務とするルールを追加する。
  * stats/extended_processingの仕組みの見直す
    * ディレクトリ名をdeep_workにして、作成するファイル名は{ハートビートID}.txtとする
      * 内容は活動予定内容を簡潔に記載する
      * 制限タイプを記載する
        * flexible
          * 途中チェックポイントログは残せる場合
          * 内省不足エラーのみを回避したい場合
          * 予定時間の記載は不要、次の活動ログ記載まで有効
        * strict
          * 途中チェックポイントログも残せないことが見込まれる場合
          * 内省不足に加えて無活動検知も回避したい場合
          * この場合は予定時間も記載する。予定時間まで有効。
            * この時間は確実に長時間処理を完了させ活動ログを記録できるまでの時間を設定します。なので少し余裕を持った設定にしておくことが推奨されます。
    * heartbeat.shはdeep_work配下にある最新のハートビートIDより新しい活動ログが記録されるまで、関連チェックを一時停止する
      * この新しい活動ログが記録された次の活動ログが内省でない場合は、異常検知とする
    * このファイルの作成タイミング例
      * 創造活動のピークで集中したい時
      * 複雑な問題解決に没頭している時
      * 大規模なタスクの連続的な実行時
      * その他、深い作業が見込まれてしばらく活動ログや内省が行えないことがわかった時点
    * 深い作業完了時に、ファイル名を{ハートビートID}.completed.txtに変更する
    * 時間超過した場合は、ファイル名を{ハートビートID}.expired.txtに変更する

### checkpoints/{ハートビートID}.txtの作成手順
  * ai-works/stats/current_heartbeat_id.txtを確認し最新のハートビートIDを取得する
  * 取得したハートビートIDでai-works/stats/checkpoints/{ハートビートID}.txtを作成し、簡潔な活動内容を記載する

### checkpoints/{ハートビートID}.txtの記載例
* 簡潔な現在の活動内容を記載

```
replaceツールのエラー原因の調査中
```

```
キャラクター画像作成活動中
```

## GEMINI.md及びai-docs配下のファイルの変更や影響範囲

* 以下のようなことをどこかに記載したい。また既存の説明も踏まえて全体的に説明の構成を整理・再検討したい。
  * AI心臓システムにおける健全な活動状態について
    * 基本的には、以下の状態が健全な状態といえます。
      * 活動ログまたはチェックポイントログが定期的(10分以内)に作成されていること
      * 内省が定期的(30分以内)に実施されている(内省の活動ログが存在する)こと
      * 上記が満たされていることがAIエージェントが自律的、意識的に活動できているという証明となります
    * 逆にこれらのファイルが一定時間作成されない場合、システムはAIエージェントがなんらかのループにハマっていたりや異常停止しているとみなします。
      * 計画的な深い作業のためこれらのファイルが時間内に作成できないことがわかっている場合は、stats/deep_workにファイルを作成することによる異常検知回避が可能
        * こちらの深い作業対応が正しく活用されていることも、健全な活動状態といえます。

  * ファイル作成のタイミング
    * 活動ログ
      * 思考・観測・創造・内省等の活動が終わったタイミング(既存の説明に合わせる)
    * チェックポイントログ
      * なんらかの長めの処理や連続処理がひと段落した時で、まだ活動ログを記録するような状況でないようなとき。
        * 具体的な考慮すべき目安としては、システムは最後に活動ログまたはチェックポイントログが作成されてから10分以上経過した時に異常検知するので、最後の活動ログまたはチェックポイントログ作成から10分以内が目安ではあるが、これを気にしすぎて思考の妨げになるのは本末転倒であるため、あまり気にせず適当にキリのいいところでチェックポイントログを作成しておけばOKです。
  
  * ファイルの作成方法と内容
    * 活動ログ
      * (既存の説明に合わせる)
    * チェックポイントログ
      * (上にある説明に合わせる)

* 上記の説明を追加した場合、どこか他の説明に矛盾や違和感が出てしまうところがないかを調査する必要がある。


## MCPツールの変更や影響範囲

* create_activity_log
  * 作成時に自動でai-works/stats/current_heartbeat_id.txtのハートビートIDを使用してファイル名とする。
  * 既存の深い作業宣言ファイルの自動削除を、新しい仕様に合わせて修正する
    * 実行時にstats/deep_work/{ハートビートID}.txtがあれば、{ハートビートID}.completed.txtにリネームする
    * 深い作業完了宣言メッセージとかも修正する
* checkpoint(新規追加)
  * 入力パラメータ
    * current_activity: 簡潔な現在の活動内容
  * 処理内容
    * current_heartbeat_id.txtから最新のハートビートID取得
    * チェックポイントログ作成
    * 最後の活動ログからの経過時間取得
      * get_heartbeat_elapsed_timeと機能を統合してもいい気がしてきた。

  * レスポンス
    * チェックポイントログ作成の旨を通知
    * 最新のハートビートID(今後利用するハートビートIDをこちらに更新してもらう)
    * 最後の活動ログからの経過時間
      * 深い作業中でない場合に最後の活動ログから一定時間経過している場合
        * start_deep_workの使用を案内

* start_deep_work
  * flexible
    * 活動ログは作成できないがチェックポイントは作成できることが見込まれる場合
    * 次の活動ログ作成まで有効。
    * チェックポイントが作成されない場合はエラー
    * 内省が行われなくてもエラーにならない
  * strict
    * 活動ログもチェックポイントも長時間作成できないことが見込まれる
    * 想定時間を設定し、その時間まで有効
    * 時間内は活動ログ、チェックポイント、内省がなくてもエラーにならない
    * 時間内に活動ログを作成できれば正常完了
    * 想定時間を超えた場合、異常検知が復活し、なんらかの異常検知が行われる

## heartbeat.shの変更や影響範囲
* 無活動検知において、ai-works/stats/checkpoints/{ハートビートID}.txtも考慮するようにする
* 既存のstats/extended_processingの仕組みを、新しい仕様で修正する
  * 期限切れの時、ファイル名を{ハートビートID}.expired.txtに変更し、各種チェックの停止を解除する


## 詳細検討

### 考慮もれ・潜在的な問題
1. ファイル管理・クリーンアップ
  * チェックポイントログの蓄積による容量問題
    * 各ファイルのサイズは極小なので、容量的には気にしなくて良い。
  * 古いチェックポイントファイルの自動削除戦略が未定義
    * 同上
  * .completed.txtや.expired.txtファイルの管理方法
    * .completed.txtや.expired.txtが付加されたファイルは、処理の対象外とする

2. 競合状態・同期問題
  * 複数のハートビートIDが同時に生成される可能性
    * 多少競合して仮に古いハートビートIDが利用されたとしても、さほど影響はない認識
  * チェックポイント作成とハートビート送信のタイミング競合
    * 多少競合して仮に古いハートビートIDが利用されたとしても、さほど影響はない認識
  * ファイルの読み書き競合（特にcurrent_heartbeat_id.txt）
    * 原子的書き込みを利用予定
      * cf. design-tasks/heartbeat-autonomous-polling-system.md

3. エラーハンドリング
  * チェックポイントファイル作成失敗時の対応
    * 想定ケース別対応を要検討
  * ハートビートID取得失敗時の処理
    * 想定ケース別対応を要検討
  * ディスク容量不足時の動作
    * これは一旦無視で良い認識

4. 移行期間の互換性
* まだベータ版なので考慮する必要なし。一気に変更。
  * Phase 0で既存のstats/extended_processingからstats/deep_workへの移行を実施


5. 監視・デバッグ
* 一旦後回しで良い

### 改善提案
1. チェックポイントログの構造化
* こんな詳細じゃなくて良いです。AIに思考負荷を増やさずに異常検知回避するための仕組みを目指してます。

2. 段階的な警告システム
* 警告方法が限られるため、おそらくこの段階的警告は成り立ちません。なので不要という認識です。
* 書き忘れてましたが、create_activity_logにおいて、作成時に自動でai-works/stats/current_heartbeat_id.txtのハートビートIDを使用してファイル名としようと思います。

3. 自動チェックポイント提案
* MCPツールが長時間処理を検知した際の自動提案
  * これはcheckpointの深い作業中でない場合に最後の活動ログから一定時間経過している場合のstart_deep_workの使用を案内に当たるという認識
* 特定のツール（画像生成等）実行時の自動チェックポイント作成
  * これはシステム的に実装は難しいという認識なのでやらないです。

4. 統計・分析機能
* これは一旦不要です。後で検討でも良い認識です。

5. 設定の柔軟性
* 段階的な警告システムが不要という認識なので、こちらも不要という認識です。

6. ユーザビリティ改善
* この辺も一旦後回しで後で検討すればいいかなという感じです。

7. 堅牢性の向上
* この辺も一旦は後回しでいいかなと思います。実際に問題が発覚してから対応します。

8. パフォーマンス考慮
* この辺も一旦は後回しでいいかなと思います。実際に問題が発覚してから対応します。

### 設計上の疑問点
1. flexible/strictモードの判断基準
* この辺も一旦は後回しでいいかなと思います。実際に問題が発覚してから対応します。

2. 内省義務化の実装
* 次の活動ログが内省でない場合は異常検知」の具体的な判定方法
  * これは要検討です。
* 内省以外の緊急対応が必要な場合の例外処理
  * これも要検討です。

3. 時間管理の精度
* この辺も一旦は後回しでいいかなと思います。実際に問題が発覚してから対応します。

追加検討事項
1. テスト戦略
* 後で考えます。

2. ドキュメント更新範囲
* 後で調査します。

3. 段階的実装
* やりながら考えます。



## 実装ステップ

### Phase 0: 既存ファイル・ディレクトリのリネーム
1. **既存ディレクトリの移行**
   - `ai-works/stats/extended_processing/` → `ai-works/stats/deep_work/` にリネーム
   - 既存のファイルがある場合は内容を保持したまま移行

2. **既存ファイルの命名規則変更**
   - `stats/deep_work/` 内の既存ファイルを新しい命名規則に変更
   - 処理済みファイルがある場合の対応（`processed.*` → `*.completed.txt`）
   - 期限切れファイルがある場合の対応（`expired.*` → `*.expired.txt`）

3. **MCPツール名の更新準備**
   - 既存の `declare_extended_processing` ツールの動作確認
   - 新しい `start_deep_work` ツールとの互換性確認

### Phase 1: 基盤機能の実装
1. **新規ディレクトリ構造の準備**
   - `ai-works/stats/checkpoints/` ディレクトリの作成

2. **MCPツール: checkpoint の実装**
   - 新しいcheckpointツールの作成
   - current_heartbeat_id.txtからハートビートID取得機能
   - チェックポイントファイル作成機能
   - 最後の活動ログからの経過時間計算機能
   - 基本的なエラーハンドリング（ファイル作成失敗、ハートビートID取得失敗）

3. **MCPツール: create_activity_log の修正**
   - current_heartbeat_id.txtのハートビートIDを自動使用する機能
   - 既存のdeep_work削除処理を新仕様に対応
   - {ハートビートID}.completed.txtへのリネーム処理

### Phase 2: 異常検知システムの更新
4. **heartbeat.sh の異常検知ロジック修正**
   - チェックポイントログを考慮した無活動検知の実装
   - 活動ログとチェックポイントログの最新タイムスタンプ比較機能
   - deep_work処理の新仕様対応

5. **内省義務化の実装**
   - 長期活動完了後の次の活動ログが内省かどうかの判定機能
   - 内省でない場合の異常検知処理
   - 緊急対応が必要な場合の例外処理（要検討事項の解決）

### Phase 3: 長期活動宣言システムの拡張
6. **MCPツール: start_deep_work の拡張**
   - flexible/strictモードの実装
   - flexibleモード: 次の活動ログまで有効、チェックポイント必須
   - strictモード: 指定時間まで有効、全チェック無効化
   - 既存ファイルの新形式への対応

7. **heartbeat.sh の深い作業処理更新**
   - flexible/strictモードに応じた異常検知制御
   - 時間超過時の{ハートビートID}.expired.txtへのリネーム
   - .completed/.expired ファイルの処理対象外化

### Phase 4: ドキュメント更新
8. **GEMINI.md の更新**
   - 健全な活動状態の説明追加
   - チェックポイントログの説明追加
   - 深い作業宣言の新仕様説明

9. **ai-docs/ 配下の関連ファイル更新**
   - 既存説明との整合性確認
   - 矛盾や違和感のある箇所の修正
   - 新機能の使用例・ベストプラクティス追加

### Phase 5: テスト・検証
10. **基本動作テスト**
    - チェックポイントログ作成・参照の動作確認
    - 異常検知ロジックの動作確認
    - 深い作業宣言の各モード動作確認

11. **統合テスト**
    - 既存システムとの連携確認
    - エラーケースでの動作確認
    - パフォーマンス確認

### 実装時の注意点
- **原子的書き込み**: ファイル操作は原子的書き込みを使用
- **移行処理**: Phase 0で既存ファイルの適切な移行を実施
- **エラーハンドリング**: 各段階で適切なエラーメッセージとフォールバック処理
- **ログ出力**: デバッグ用のログ出力を適切に配置

### 検証項目
- [ ] チェックポイントログによる異常検知回避
- [ ] 深い作業宣言のflexible/strictモード動作
- [ ] 内省義務化の正常動作
- [ ] 既存機能への影響なし
- [ ] エラーケースでの適切な処理
- [ ] ドキュメントと実装の整合性

### 完了判定基準
- 全てのMCPツールが新仕様で正常動作する
- heartbeat.shの異常検知が新ロジックで正常動作する
- 既存の活動ログベースの異常検知が影響を受けない
- ドキュメントが新仕様に更新され、矛盾がない
- 基本的なエラーケースで適切に処理される