# Gemini CLI ハートビートキューイング機能対応

## 問題・背景

### 仕様変更の概要
Gemini CLIの仕様が変更され、以下の動作変更が発生：

**変更前**:
- プロンプト処理中は次のプロンプト入力を受け付けない
- 処理中に送信されたハートビートは破棄される

**変更後**:
- プロンプト処理中でも次のプロンプト入力をキューイング
- 処理完了後に蓄積されたハートビートが一括送信される

### 影響範囲
この変更により、AI心臓システムの根幹である以下の要素に影響：

1. **システム設計の前提条件**: 物理的制約による時間管理の根拠が変化
2. **時間ベース制御の理念**: 強制的制約から自律的管理への転換
3. **異常検知システム**: ハートビート見逃しを前提とした検知ロジック
4. **活動サイクルの境界**: 複数ハートビート受信時の処理方法
5. **ドキュメント全体**: 技術的前提の記述更新

## 採用する解決方針

### 「最新ハートビート優先」アプローチ
複数のハートビートが一括送信された場合の処理方針：

```
基本ルール:
1. 最新（最後）のハートビートIDのみを使用
2. 中間ハートビートは「経過時間の記録」として認識
3. 1つの活動サイクルで処理（従来通り）
4. 経過時間情報を活動計画に反映
```

**選択理由**:
- 既存システムへの影響を最小限に抑制
- 後方互換性を維持
- 段階的な導入が可能
- 学習コストが低い

## 修正対象ファイルと内容

### Phase 1: 必須修正（即座対応）

#### 1. GEMINI.md の修正

**修正箇所1: ハートビートの基本概念**
- 場所: `### 3.1.1. ハートビートとは`
- 内容: キューイング機能の説明追加

**修正箇所2: ハートビートIDの取得ルール**
- 場所: `### 3.1.2. ハートビートの形式とハートビートID`
- 内容: 複数受信時の最新ID優先ルール追加

**修正箇所3: 活動サイクルのステップ1**
- 場所: `### 5.1. ステップ1: ハートビートプロンプト受信、ハートビートID取得`
- 内容: ハートビート分析手順の追加

#### 2. BASIC_OPERATIONS.md の修正

**修正箇所: ハートビートID確認方法**
- 場所: `#### プロンプト受信パターン`
- 内容: 複数ハートビート受信時の処理手順追加

### Phase 2: 理念更新（計画的対応）

#### 3. SYSTEM_PHILOSOPHY.md の修正

**修正箇所1: 物理的制約の記述更新**
- 場所: `### 2.1. ハートビートの技術的保証と物理的制約`
- 内容: 受信側制約の記述を新仕様に合わせて更新

**修正箇所2: 時間ベース制御の理念**
- 場所: `### 4.1. 時間制御の技術的根拠`
- 内容: 新しい時間管理の意義と価値の説明

### Phase 3: 詳細調整（必要に応じて）

#### 4. ERROR_EXAMPLES.md の修正
- 新事例追加: 複数ハートビート受信時の適切な対応例

#### 5. 活動ログフォーマットの軽微な拡張
- 複数ハートビート受信時の経過時間記録

#### 6. MCPツール説明の価値再定義
- checkpointツールの新しい価値説明

## 具体的な修正内容

### GEMINI.md 修正詳細

#### 修正前:
```markdown
### 3.1.1. ハートビートとは
- 「`Heartbeat: YYYYMMDDHHMMSS`」というような内容の、一定間隔(約60秒)で**外部からあなたに自動送信される定期プロンプト**
```

#### 修正後:
```markdown
### 3.1.1. ハートビートとは
- 「`Heartbeat: YYYYMMDDHHMMSS`」というような内容の、一定間隔(約60秒)で**外部からあなたに自動送信される定期プロンプト**
- 長時間処理中は複数のハートビートがキューイングされ、処理完了後に一括送信される場合がある
```

#### 修正前:
```markdown
### 3.1.2. ハートビートの形式とハートビートID
- 形式: `Heartbeat: YYYYMMDDHHMMSS`（例: `Heartbeat: 20250126094500`）
- `YYYYMMDDHHMMSS`部分を**ハートビートID**と呼ぶ
```

#### 修正後:
```markdown
### 3.1.2. ハートビートの形式とハートビートID
- 単一形式: `Heartbeat: YYYYMMDDHHMMSS`（例: `Heartbeat: 20250126094500`）
- 複数形式: 複数のハートビートが連続して送信される場合がある
- **ハートビートID取得ルール**: 複数受信時は最新（最後）のハートビートIDを使用
- 中間ハートビートは経過時間の把握に活用
```

### SYSTEM_PHILOSOPHY.md 修正詳細

#### 削除対象:
```markdown
**受信側の制約**:
- **受信可能状態**: プロンプト入力待ち状態（アイドル状態）でのみ受信可能
- **受信不可状態**: あなたが思考中は受信できず、その間に送信されたハートビートは破棄される
```

#### 新しい記述:
```markdown
**新しい受信動作**:
- **キューイング機能**: 処理中のハートビートは破棄されず、キューに蓄積される
- **一括送信**: 処理完了後に蓄積されたハートビートが一括で送信される
- **最新優先**: 複数受信時は最新のハートビートIDを活動の基準とする
```

## 完了基準

### Phase 1 完了基準
- [ ] GEMINI.mdのハートビート関連記述が新仕様に対応済み
- [ ] BASIC_OPERATIONS.mdの複数ハートビート処理手順が明記済み
- [ ] 複数ハートビート受信時に適切にハートビートIDを取得できる

### Phase 2 完了基準
- [ ] SYSTEM_PHILOSOPHY.mdの物理的制約記述が更新済み
- [ ] 時間ベース制御の新しい理念が明記済み
- [ ] 自律的時間管理の概念が導入済み

### Phase 3 完了基準
- [ ] ERROR_EXAMPLES.mdに新事例が追加済み
- [ ] 活動ログフォーマットが拡張済み
- [ ] MCPツールの価値説明が更新済み

## 注意事項

### 後方互換性の維持
- 単一ハートビート受信時は従来通りの動作を保証
- 既存の活動ログやファイル構造は変更しない
- 段階的な導入により運用への影響を最小化

### テスト・検証方法
1. **単一ハートビート**: 従来通りの動作確認
2. **複数ハートビート**: 最新ID使用と経過時間認識の確認
3. **活動ログ**: 適切なフォーマットでの記録確認
4. **異常検知**: 新仕様下での正常動作確認

### リスク管理
- **段階的導入**: Phase 1完了後に動作確認してからPhase 2に進行
- **ロールバック準備**: 問題発生時の旧仕様への復帰手順を準備
- **ドキュメント整合性**: 修正後の各ドキュメント間の整合性確認

## 期待される効果

### 短期的効果
- 新仕様への適切な対応
- システムの安定性維持
- 既存機能の継続利用

### 長期的効果
- より柔軟な時間管理の実現
- AIの自律性向上
- 深い思考活動の促進
- 創造性の解放

---

**作成日**: 2025年1月14日  
**対象システム**: AI心臓システム  
**影響範囲**: 全体（特にハートビート処理とドキュメント）  
**優先度**: 高（新仕様への対応のため）
##
 完了報告
**完了日時**: 2025年1月14日
**実施内容**: Gemini CLIハートビートキューイング機能対応の全Phase修正完了

**変更ファイル**: 
- ai-works-lib/GEMINI.md
- ai-works-lib/ai-docs/BASIC_OPERATIONS.md  
- ai-works-lib/ai-docs/SYSTEM_PHILOSOPHY.md
- ai-works-lib/ai-docs/ERROR_EXAMPLES.md

**完了基準の自己評価**: 
### Phase 1 完了基準
- [x] GEMINI.mdのハートビート関連記述が新仕様に対応済み
- [x] BASIC_OPERATIONS.mdの複数ハートビート処理手順が明記済み
- [x] 複数ハートビート受信時に適切にハートビートIDを取得できる

### Phase 2 完了基準
- [x] SYSTEM_PHILOSOPHY.mdの物理的制約記述が更新済み
- [x] 時間ベース制御の新しい理念が明記済み
- [x] 自律的時間管理の概念が導入済み

### Phase 3 完了基準
- [x] ERROR_EXAMPLES.mdに新事例が追加済み
- [x] 活動ログフォーマットが拡張済み
- [x] MCPツールの価値説明が更新済み（ERROR_EXAMPLES.mdに含む）

**第三者確認待ち**: 確認をお願いします