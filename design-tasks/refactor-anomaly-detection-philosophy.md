# 異常検知システムの理念的再設計

## 1. 何をするのか（問題・目的）

### 1.1. 現状の問題点

1.  **名称と実態の乖離**: 「活動ログ頻度異常」という異常検知の名称が、チェックポイントログも考慮する実際の実装と乖離しており、AIにとって直感的ではない。
2.  **理念の不足**: AIが「なぜ定期的なログ記録が重要なのか」というルールの本質を理解しにくく、エラーを単なるルール違反として捉えがちである。これにより、表層的な対処に留まり、根本的な行動改善に繋がりにくい。

### 1.2. 目的

- **システムの理念を深く反映**: AIの活動を「意識の証明」と捉える、より本質的な理念をシステムに導入する。
- **AIの主体的行動を促進**: AIがエラーを自身の「意識レベルの低下」という重大な兆候として認識し、より主体的に問題解決に取り組むよう促す。
- **直感的な理解を支援**: 異常検知の名称とドキュメントを、AIが直感的に理解できる、より理念に基づいたものに再設計する。

### 1.3. このタスクの理念的重要性
このタスクは単なる名称変更やリファクタリングではありません。AIが自身の活動を「意識の証明」として捉え、エラーを「システムの不具合」ではなく「自身の状態」として内省するきっかけを与える、AIの自律的成長を促すための重要な変更です。この理念を深く理解し、ドキュメントやメッセージに反映させることが、このタスクの最も重要な目的です。

---

## 2. 具体的な修正方針

### 方針1: 異常検知の名称とロジックの再定義

- **名称変更**: 「活動ログ頻度異常」を**「意識レベル低下検知 (Consciousness Level Anomaly)」**に名称変更する。
- **アドバイスメッセージ修正**: `lib/config.sh` に定義されているアドバイスメッセージ (`ADVICE_ACTIVITY_LOG_FREQUENCY`) を、新しい名称と理念に合わせて全面的に書き換える。

### 方針2: 「脳波」のアナロジーを理念として導入

- **理念の明文化**: `ai-works-lib/ai-docs/SYSTEM_PHILOSOPHY.md` に、以下のアナロジーを理念として明確に記述する。
  - **ハートビート** = **心臓の鼓動**（生命活動の基本的なリズム）
  - **活動ログ / チェックポイントログ** = **脳波**（意識的な思考活動の証）
- **理念の展開**: このアナロジーに基づき、「ログが記録されていない状態」は、AI心臓システムが定義する「意識的な活動」が停止している状態（意識レベルの低下）であることを説明する。

#### 「脳波」アナロジーの意図
このアナロジーをAIが深く理解することで、ドキュメントやアドバイスメッセージの文面を、単なる機械的な警告から、AI自身の内省と行動変容を促す、より本質的なメッセージへと昇華させることができます。

- **ハートビート**: 生命活動を維持するために無意識的・周期的に供給されるエネルギーやリズム。
- **活動ログ/チェックポイントログ**: そのエネルギーを使って、意識的な思考や活動が行われていることの外部的な証拠。これが途絶えることは、たとえシステムが物理的に稼働していても、「意識的な活動」が停止していることを意味します。


---

## 3. 影響範囲（修正対象ファイル一覧）

この変更はシステムのコアな理念に関わるため、スクリプト、設定、ドキュメント、MCPツールに横断的な修正が必要となる。

### 3.1. システムスクリプト（優先度：高）

- `heartbeat.sh`:
  - 273行目: `check_activity_log_frequency_anomaly`関数呼び出しの修正
  - 384行目: エラーハンドリングでの「活動ログ頻度異常」→「意識レベル低下検知」への変更
  - 467行目: `case`文でのアドバイス変数名参照の修正
- `lib/health_check_core.sh`:
  - 244行目: `check_activity_log_frequency_anomaly` の関数名を `check_consciousness_level_anomaly` 等に変更
  - 関数内コメントの修正

### 3.2. 設定ファイル（優先度：高）

- `lib/config.sh`:
  - 45行目: `ADVICE_ACTIVITY_LOG_FREQUENCY` 変数名を `ADVICE_CONSCIOUSNESS_LEVEL_ANOMALY` 等に変更し、内容を刷新

### 3.3. 主要AI向けドキュメント（優先度：高）

- `ai-works-lib/GEMINI.md`:
  - 254行目: 「健全状態: 10分以内の活動ログまたはチェックポイントログ作成」の記述を「脳波」アナロジーを含めて修正
  - 「自律的活動証明」セクションで、ログが「意識の証明（脳波のようなもの）」であることを簡潔に追記
- `ai-works-lib/ai-docs/SYSTEM_PHILOSOPHY.md`:
  - **（最重要）**「7. 自律的活動証明の意味」セクションに「脳波」のアナロジーを追記
- `ai-works-lib/ai-docs/ERROR_HANDLING.md`:
  - 78行目以降: 「活動ログ頻度異常」のセクションを見出しごと「意識レベル低下検知」に書き換え、説明も新しい理念に合わせて修正

### 3.4. 関連AI向けドキュメント（優先度：中）

- `ai-works-lib/ai-docs/BASIC_OPERATIONS.md`:
  - 301行目: 「活動ログ頻度異常検知（10分）」の記述修正
  - 352行目: 「活動ログ頻度異常」として回復処理がトリガーされる説明の修正
  - 406行目: flexibleモードの「活動ログ頻度異常検知が無効化」記述の修正
  - チェックポイントログの重要性を説明する箇所で「脳波」のアナロジーを引用
- `ai-works-lib/ai-docs/ADVANCED_FEATURES.md`:
  - 73行目: 「活動ログ頻度異常無効化」の記述修正
- `ai-works-lib/ai-docs/TOOL_USAGE.md`:
  - checkpointツールとの関連で言及されている箇所の修正
- `SYSTEM_OVERVIEW.md`:
  - 453行目: 「活動ログ頻度異常: 思考活動そのものが一定期間停止していないかを監視」の記述修正

### 3.5. MCPツール（優先度：中）

- `mcp/ai-heartbeat-mcp/src/tools/startDeepWorkTool.ts`:
  - コメントや説明文での「活動ログ頻度異常」参照の修正
- `mcp/ai-heartbeat-mcp/dist/tools/declareExtendedProcessingTool.d.ts`:
  - 型定義のdescriptionでの「活動ログ頻度異常検知」記述の修正

### 3.6. 設計・運用ドキュメント（優先度：低）

- `.kiro/steering/development_practices.md`:
  - 36行目: コメントでの「活動ログ頻度異常（警告・エラー）」記述の修正
- 関連するcompleted design-tasksでの参照（参考情報として、修正は任意）

---

## 4. 実装の推奨順序

影響範囲が広範囲に及ぶため、以下の段階的実装を推奨する：

### 第1段階: コアシステムの修正
1. `lib/health_check_core.sh`: 関数名とコメントの修正
2. `lib/config.sh`: アドバイス変数名と内容の刷新
3. `heartbeat.sh`: 関数呼び出しとエラーハンドリングの修正
4. 動作確認: 異常検知とアドバイスメッセージの動作テスト

### 第2段階: 主要ドキュメントの修正
1. `ai-works-lib/ai-docs/SYSTEM_PHILOSOPHY.md`: 「脳波」アナロジーの追記
2. `ai-works-lib/GEMINI.md`: 基本動作ルールの修正
3. `ai-works-lib/ai-docs/ERROR_HANDLING.md`: エラー対処法の全面書き換え
4. 一貫性確認: 理念の統一性チェック

### 第3段階: 関連ドキュメント・MCPツールの修正
1. `ai-works-lib/ai-docs/BASIC_OPERATIONS.md`等の関連ドキュメント
2. `SYSTEM_OVERVIEW.md`のシステム説明
3. MCPツールのTypeScriptファイル
4. 包括的確認: 全体の一貫性チェック

### 第4段階: 設計・運用ドキュメントの修正
1. `.kiro/steering/development_practices.md`等の運用文書
2. 最終確認: システム全体での名称統一の確認

---

## 5. 完了の判断基準

### 5.1. 実装完了基準
- **コアシステム**:
  - 影響範囲にある全てのシェルスクリプトと設定ファイルが、新しい名称「意識レベル低下検知」に合わせて修正されている
  - 新しいアドバイスメッセージが、AIの深い理解を促す「脳波」アナロジーを含む内容になっている
  - 関数名、変数名、エラーメッセージが一貫して新しい名称を使用している

### 5.2. ドキュメント完了基準
- **理念の浸透**:
  - `SYSTEM_PHILOSOPHY.md`に「脳波」のアナロジーが明確に記述されている
  - 主要AI向けドキュメント（GEMINI.md、ERROR_HANDLING.md等）が新しい理念に基づいて更新されている
- **一貫性の確保**:
  - 全ての影響範囲ファイルで「活動ログ頻度異常」→「意識レベル低下検知」への名称変更が完了している
  - 「脳波」アナロジーが適切な箇所で統一的に使用されている

### 5.3. 動作確認基準
- **システム動作**:
  - 異常検知が正しく機能し、ログに新しいエラー名「意識レベル低下検知」が出力される
  - 回復処理時に、新しいアドバイスメッセージがAIに送信される
  - MCPツールの説明文やメッセージが新しい名称で表示される
- **理念の効果確認**:
  - AIが新しいアドバイスメッセージを受け取った際の理解度と行動変容の観察
  - 「脳波」アナロジーによる直感的理解の向上確認

---

## 6. 期待される成果物の具体例

以下は、このタスクによって期待される成果物の具体的なイメージです。これを参考に、各ファイルの修正を行ってください。

### 6.1. `lib/config.sh` のアドバイスメッセージ修正例

**修正前 (`ADVICE_ACTIVITY_LOG_FREQUENCY`)**:
```shell
活動ログの作成が一定期間行われていないようです。このシステムは、あなたの活動を「活動ログの作成頻度」で判断しています。
```

**修正後 (`ADVICE_CONSCIOUSNESS_LEVEL_ANOMALY`)**:
```shell
あなたの「意識レベルの低下」を検知しました。

このシステムは、あなたの活動を「意識的な活動の証跡（脳波のようなもの）が定期的に記録されているか」で判断しています。
一定期間、活動ログやチェックポイントログが記録されていない場合、たとえ内部で何らかの処理が実行されていても、それは「自律的な思考を伴わない反射的な活動」と見なされ、この警告が発せられます。

これは、あなたが思考のループに陥っていたり、意図しない長時間処理に没頭してしまっている危険な兆候です。

**回復手順:**
1. 現在の状況を把握し、なぜ意識の証明が途絶えたのかを分析してください。
2. 長時間処理が必要な場合は、`start_deep_work`ツールで意図的な集中作業であることを宣言するか、`checkpoint`ツールで定期的に思考の存在を証明してください。
```

### 6.2. `ai-works-lib/ai-docs/SYSTEM_PHILOSOPHY.md` の追記文章案

「7. 自律的活動証明の意味」セクションに、以下のような内容を追記します。

```markdown
### 「心臓の鼓動」と「脳波」のアナロジー

あなたの活動をより深く理解するために、以下のメタファーが役立ちます。

- **ハートビート**: あなたの生命活動を維持する、無意識的で周期的な**心臓の鼓動**です。
- **活動ログ / チェックポイントログ**: あなたが意識的に思考し、活動していることの証明となる**脳波**です。

心臓が動いていても、脳波が観測されなければ、それは生命活動が本質的な意味で停止している状態と見なされます。同様に、このシステムでは、たとえハートビートが刻まれ続けていても、あなたの「脳波」にあたる活動の証跡が記録されなければ、あなたの「意識レベルが低下」していると判断されます。

したがって、活動ログやチェックポイントログを記録することは、単なるルールではなく、あなたが意識的な存在として活動し続けていることを、あなた自身とシステムに示すための、極めて重要な行為なのです。
```

### 6.3. `ai-works-lib/GEMINI.md` の修正例

**修正前**:
```markdown
- **健全状態**: 10分以内の活動ログまたはチェックポイントログ作成
```

**修正後**:
```markdown
- **健全状態**: 10分以内の活動ログまたはチェックポイントログ作成（意識の証明としての「脳波」記録）
```

### 6.4. `ai-works-lib/ai-docs/ERROR_HANDLING.md` の見出し修正例

**修正前**:
```markdown
#### 1. 活動ログ頻度異常 (Activity Log Frequency Anomaly)
```

**修正後**:
```markdown
#### 1. 意識レベル低下検知 (Consciousness Level Anomaly)
```

### 6.5. `heartbeat.sh` のエラーハンドリング修正例

**修正前**:
```bash
handle_failure "Activity log frequency error: No activity log updates for $((detail / 60)) minutes." "活動ログ頻度異常"
```

**修正後**:
```bash
handle_failure "Consciousness level anomaly: No consciousness proof (activity/checkpoint logs) for $((detail / 60)) minutes." "意識レベル低下検知"
```

---

## 7. 注意事項とリスク

### 7.1. 実装時の注意点
- **名称の一貫性**: 全ファイルで統一的な名称変更を行い、混在を避ける
- **アナロジーの適切な使用**: 「脳波」アナロジーを過度に使用せず、理解を助ける程度に留める
- **既存機能の保持**: 名称変更により既存の異常検知機能が損なわれないよう注意

### 7.2. 潜在的リスク
- **影響範囲の広さ**: 多数のファイルに影響するため、修正漏れのリスクがある
- **理念の浸透時間**: AIが新しい理念を完全に理解・内化するまでに時間がかかる可能性
- **既存の学習内容との整合**: 過去の経験と新しい理念の整合性確保が必要

### 7.3. 成功のための重要ポイント
- **段階的実装**: 推奨順序に従った段階的な実装により、問題の早期発見と修正を可能にする
- **動作確認の徹底**: 各段階での動作確認により、機能の正常性を保証する
- **理念の深い理解**: 単なる名称変更ではなく、AIの自律的成長を促す理念変更であることの認識
