# テーマ管理ガイド

このドキュメントは、AI心臓システムにおけるテーマの選択、および「テーマ開始活動」「テーマ終了活動」の実行手順を定義します。

## 1. テーマ開始・終了活動の実行手順

`GEMINI.md`で定義された「テーマ開始活動」および「テーマ終了活動」を実行する際は、このガイドの指示に厳密に従ってください。これらの活動の核心は、テーマの変遷を正確に記録することです。記録には、後述するMCPツールの使用を推奨しますが、ツールが利用できない場合の代替手順も理解しておくことが重要です。

## 2. テーマ選択の優先順位

### 2.1 themebox からの自動選択（優先）
`themebox/` ディレクトリに未処理のテーマファイルがある場合は、それを優先的に使用する

**ファイル確認時の注意事項**
* themebox/は.gitignoreで除外ディレクトリとして登録されているため、ツール使用時にファイルが無視される可能性がある。
  * 除外ファイルも確認できるように、ツール使用時に`respect_git_ignore=False`等のオプションの使用を検討する

### 2.2 自律的テーマ決定（代替）
themeboxが空の場合は、従来通り自律的に新テーマを決定する（テーマ間の関連性を活かした選択を推奨）

## 3. themebox テーマ管理

### 3.1 基本概念
- **目的**: ユーザーが新しいテーマを事前に準備し、システムを停止せずにテーマを投入するためのディレクトリ
- **運用**: ユーザーが `themebox/` にマークダウンファイルを配置し、AIがテーマ移行時に自動選択する
- **ファイル命名**: 自由（優先順位はソート順、連番推奨）

### 3.2 MCPツールによる自動処理支援

**MCPツール支援**: `check_and_process_item` ツール（`type: 'themebox'`）による自動処理が利用可能

**使用時の注意事項**:
- ツール使用時に警告メッセージが表示された場合は、`ai-docs/MCP_WARNING_GUIDE.md`を参照
- MCPツールは補助手段であり、手動でのthemebox処理も可能

### 3.3 除外ルール
- `draft.` で始まるファイル名は無視（編集中）
- `processed.` で始まるファイル名は無視（処理済み）

### 3.4 選択・処理方法
- **選択方法**: ソート順で最初の有効なファイルを選択
- **使用後処理**: 選択されたファイルに `processed.` プレフィックスを付与
- **ファイル内容**: ファイル内容をそのまま新テーマとして使用

## 4. テーマ履歴記録

### 4.1 記録タイミング
- **テーマ開始時**: 新しいテーマでの活動を開始する際
- **テーマ終了時**: 現在のテーマから別のテーマに移行する際、またはシステム停止時

### 4.2 保存場所
- ディレクトリ: `artifacts/theme_histories/`
- このディレクトリが存在しない場合は自動作成する

## 5. ファイル命名規則

### 5.1 テーマ開始記録
- ファイル名: `{THEME_START_ID}_start_テーマ名.md`
- 例: `20250115143000_start_AI自己研鑽.md`

### 5.2 テーマ終了記録
- ファイル名: `{THEME_END_ID}_end_テーマ名.md`
- 例: `20250115180000_end_AI自己研鑽.md`

### 5.3 タイムスタンプ
- **テーマ開始記録**: THEME_START_ID（テーマ開始時のハートビートID）を使用
- **テーマ終了記録**: THEME_END_ID（テーマ終了時のハートビートID）を使用
- 形式: YYYYMMDDHHMMSS（年月日時分秒）

## 6. ファイル内容
このセクションで定義されたフォーマットは、手動でファイルを作成する場合に厳密に遵守してください。`create_theme_log`ツールを使用する場合は、ツールが自動的にこのフォーマットで生成します。

### 6.1 テーマ開始記録 (`_start_` ファイル)

```markdown
# テーマ開始: [テーマ名]

**テーマディレクトリ**: `artifacts/[THEME_START_ID_themeDirectoryName]/`

**開始理由**: 
[初期テーマ/前テーマ「XXX」から移行/など]

**活動内容**: 
[このテーマで何を行うか]
```

### 6.2 テーマ終了記録 (`_end_` ファイル)

```markdown
# テーマ終了: [テーマ名]

**THEME_START_ID**: [テーマ開始時のハートビートID]
**THEME_END_ID**: [テーマ終了時のハートビートID]
**テーマディレクトリ**: `artifacts/[THEME_START_ID_themeDirectoryName]/`

**終了理由**: 
[完了/新テーマ「XXX」へ移行/など]

**主な成果**: 
[重要な成果物や発見の簡潔な説明]
```

## 7. テーマ履歴の記録方法


### 7.1 手動での作成（基本手順）

#### テーマ開始時
1. 新しいテーマでの活動開始を決定
2. **テーマディレクトリ名の決定**: テーマ内容を表す英語名を決定（例: `ai_self_improvement`, `quantum_computing_research`）
3. `artifacts/theme_histories/` ディレクトリの存在確認・作成
4. 上記フォーマットに従って `_start_` ファイルを作成（ディレクトリ名を記録）
5. 通常の思考ログ記録を実行

#### テーマ終了時
1. テーマ移行完了を判断
2. **THEME_END_IDの設定**: 現在のハートビートIDをTHEME_END_IDとして記録
3. 上記フォーマットに従って `_end_` ファイルを作成（THEME_START_IDとTHEME_END_IDの両方を記録）
4. 新テーマに移行する場合は、続けて新テーマの `_start_` ファイルを作成

### 7.2 MCPツールによる作成支援（推奨）

#### create_theme_log ツール
テーマ履歴ファイルの作成を支援するMCPツール `create_theme_log` が利用可能です。

**使用方法**:
- テーマ開始時: `action: "start"` (THEME_START_IDを使用)
- テーマ終了時: `action: "end"` (THEME_END_IDを使用)
- ハートビートIDと適切なパラメータを指定

**利点**:
- 標準的なフォーマットでの自動作成
- THEME_START_ID/THEME_END_IDを使用した適切なファイル名生成
- 両IDの関連付けを含む完全な記録
- 記録漏れの防止

#### MCPツール使用時の注意事項
* ツール使用時に警告メッセージが表示された場合は、`ai-docs/MCP_WARNING_GUIDE.md`を参照して適切に対応してください
* MCPツールは補助手段であり、手動でのテーマ履歴作成も可能です


## 8. 注意事項

- テーマ履歴記録は思考ログ記録とは独立して実行する
- ファイル作成エラーが発生した場合は、エラー内容を思考ログに記録し、次のハートビートで再試行する
- **一回のハートビートでは一つのテーマに集中**: 新しいテーマを開始した場合、そのハートビートではそのテーマの活動のみを行い、サブテーマの作成や他のテーマへの移行は次のハートビートで実行する
  - **理由**: 同一ハートビートIDでの複数テーマログ作成による異常検知を防ぐため
  - **効果**: 「一回一歩」の原則に従った集中的で質の高いテーマ開始が可能