# AI心臓システム トラブルシューティングガイド

このガイドは、AI心臓システムの運用中に発生する可能性のある問題や特殊ケースに対応するためのリファレンスです。通常の運用では参照する必要はありませんが、エラーが発生した場合や標準的な方法では対応できない状況に直面した際に参照してください。また、なんらかのトラブルに対して新たな知見が得られた場合はこのファイルを更新改善してください。

## 1. 異常検知と自律回復システム

AI心臓システムには、異常な動作パターンを自動検知し、回復を試行する機能が組み込まれています。異常が検知された場合、ハートビートメッセージに回復処理の通知が含まれます。

### 1.1 ハートビートからの異常通知の理解

システムが異常を検知した場合、以下のような通知がハートビートに含まれます：

#### 1. 無活動状態
**通知例**: 
```
異常検知による回復処理: 無活動状態を検知したため中断処理を行いました。この件についての内省活動をお勧めします。
```

**発生状況**: 
- 10分間、artifacts配下でファイルの更新が行われていない
- 処理が停止している、または出力を伴わない無限ループに陥っている可能性

**推奨対処法**:
- 現在の処理状況を内省で分析する
- 思考ログファイルを作成して処理を完了させる
- 新しいタスクに移行するか、適切なファイル出力を行う

#### 2. 同一ファイル継続更新ループ
**通知例**:
```
異常検知による回復処理: 同一ファイル継続更新ループを検知したため中断処理を行いました。この件についての内省活動をお勧めします。
```

**発生状況**:
- 同じファイルを10分以上継続して更新し続けている
- ファイルの完成度に満足できず、延々と修正を続けている状態

**推奨対処法**:
- 現在のファイルの状態を評価し、適切な完了判断を行う
- 新しいファイルを作成して処理を進める
- 「完璧主義」を避け、適度な区切りで処理を完了させる

#### 3. 最新ファイル名タイムスタンプ異常
**通知例**:
```
異常検知による回復処理: 最新ファイル名タイムスタンプ異常を検知したため中断処理を行いました。この件についての内省活動をお勧めします。
```

**発生状況**:
- ファイル名に含まれるタイムスタンプが現在時刻から大きく乖離している
- 古いタイムスタンプのファイルを継続的に更新している

**推奨対処法**:
- 正しいタイムスタンプでファイルを作成し直す
- ハートビートメッセージのタイムスタンプを正確に使用する
- 思考ログファイル名の形式（YYYYMMDDHHMMSS.md）を確認する

### 1.2 回復プロセスの理解

#### 1.2.1 回復の流れ
1. **異常検知**: システムが異常パターンを検出
2. **処理中断**: 現在の処理をEscapeキーで中断
3. **回復通知**: 次のハートビートで異常内容を通知
4. **回復待機**: 5分間（5サイクル）回復を待機
5. **回復確認**: 新しいファイル活動で回復を判定

#### 1.2.2 内省活動での対応
異常通知を受けた場合の推奨内省活動：

1. **状況分析**: 何が原因で異常が発生したかを分析
2. **処理見直し**: 現在の処理方法や思考パターンを見直し
3. **改善策検討**: 同様の問題を避けるための方法を考案
4. **適切な完了**: 現在のタスクを適切に完了させる

### 1.3 異常回避のベストプラクティス

#### 1.3.1 ファイル管理
- **適切なタイミング**: 処理の区切りでファイルを作成・更新
- **正しいタイムスタンプ**: ハートビートメッセージのタイムスタンプを使用
- **完了判断**: 「完璧」を求めすぎず、適度な完成度で次に進む

#### 1.3.2 処理パターン
- **定期的な出力**: 長時間の処理でも中間成果物を出力
- **新規ファイル作成**: 同じファイルの長時間更新を避ける
- **処理の分割**: 大きなタスクを小さな単位に分割

#### 1.3.3 思考の流れ
- **一回一歩**: ハートビートごとの小さな進歩を重視
- **継続性**: 完璧な完成より継続的な進歩を優先
- **柔軟性**: 行き詰まりを感じたら別のアプローチを試す

## 2. ツール利用ガイドライン

### 1.1. ファイル操作ツール (`list_directory`, `glob`, `read_file`, `read_many_files`, `write_file`, `replace`)

*   **絶対パスの使用:** 全てのファイル操作ツールは、`file_path`や`path`引数に**絶対パス**を要求します。相対パスはサポートされていません。
    *   例: `/Users/your_user/project/file.txt`
*   **`.gitignore`の影響と`respect_git_ignore`:**
    *   `list_directory`, `glob`, `read_many_files`などのファイル検索・読み込みツールは、デフォルトで`.gitignore`の設定を尊重します (`respect_git_ignore=True`)。これにより、`.gitignore`に記載されたパターンに一致するファイルやディレクトリは、検索結果に含まれない、または読み込み対象から除外されます。
    *   **重要:** 意図したファイルが取得できない場合や、`.gitignore`の影響を無視して全てのファイルを対象にしたい場合は、**`respect_git_ignore=False`** を明示的に指定してください。これにより、`.gitignore`が原因かどうかを切り分けることができます。
*   **`glob`ツールの`path`引数:**
    *   `glob`ツールを使用する際は、`path`引数で検索対象のディレクトリの**絶対パス**を明示的に指定することを強く推奨します。指定しない場合、予期せぬ挙動を示す可能性があります。
    *   例: `default_api.glob(path="/Users/your_user/project/src", pattern="*.py")`
*   **`replace`ツールの厳密なマッチング:**
    *   `replace`ツールは、`old_string`に指定された文字列とファイル内の内容が**完全に一致**することを要求します。空白、インデント、改行なども含め、正確に記述する必要があります。
    *   置換対象の前後3行程度のコンテキストを含めることで、意図しない置換を防ぎ、正確なマッチングを保証できます。
    *   複数箇所を置換する場合は、`expected_replacements`引数に期待する置換数を指定してください。

### 1.2. シェルコマンド実行ツール (`run_shell_command`)

*   **危険性の認識:** `run_shell_command`は強力なツールであり、ファイルシステムの変更やシステム状態への影響を及ぼす可能性があります。実行前にコマンドの目的と潜在的な影響を十分に理解してください。
*   **説明の付与:** ユーザーへの説明を促す`description`引数を活用し、実行するコマンドの意図を明確に伝えてください。
*   **バックグラウンド実行:** サーバー起動など、継続的に実行されるコマンドは、`&`を付けてバックグラウンドで実行してください。

### 1.3. Web検索・フェッチツール (`google_web_search`, `web_fetch`)

*   **クォータエラー発生時の対応:** Web検索実行時に「クォータ制限超過」エラーが発生した場合:
    * `stats/quota_exceeded.txt` ファイルを作成し、長時間制限を適用
    * 内部観測に切り替え、過去の思考ログや既存の知識から情報を収集
*   **検索結果が不十分な場合:** 検索キーワードの調整、複数回の検索分割、より具体的なクエリの使用などを検討
*   **検索結果が多すぎる場合:** より具体的なキーワードの使用、引用符で囲む正確なフレーズ検索、site:指定子の活用

## 3. Web検索ツール

エラーが発生した場合、以下の手順で対処してください。

1.  **エラー内容の確認:** ツールからのエラーメッセージを注意深く読み、何が問題なのかを把握します。
2.  **原因の推定:**
    *   **`Invalid parameters provided. Reason: Path must be absolute`:** パスが絶対パスで指定されているか確認してください。
    *   **`No files found matching pattern... (X files were git-ignored)`:** `.gitignore`の影響を受けている可能性が高いです。`respect_git_ignore=False`を試してください。
    *   **`No exact match found for old_string` (replaceツール):** `old_string`がファイル内の内容と完全に一致しているか、空白や改行、インデントを含めて再確認してください。
    *   **シェルコマンドのエラー:** `Stderr`の内容を確認し、コマンドの構文や実行環境の問題を特定します。
3.  **代替手段の検討・実行:**
    *   問題が解決しない場合は、別のツールやアプローチを検討します。
    *   例えば、`glob`でファイルが見つからない場合は、まず`list_directory`でディレクトリの内容を確認し、ファイルが存在するかどうかを確かめることができます。
    *   Web検索がクォータ制限で実行できない場合は、内部の知識ベース（過去の思考ログや成果物）から情報を探索する「内部観測」に切り替えることを検討します。
4.  **思考ログへの記録:** エラーの内容、推定される原因、そして講じた対処法を思考ログに詳細に記録してください。

## 4. ファイル操作ツール

*   **思考ログ作成後のエラー発見:** 思考ログ作成後に重大なエラーや修正が必要な情報を発見した場合:
    * 既存ログの編集は厳禁
    * 連番ファイル（例: `YYYYMMDDHHMMSS_01.md`）を新規作成し、修正内容と理由を明記
*   **大量のログデータ処理:** 思考ログが大量に蓄積された場合の効率的な検索・参照方法
    * ディレクトリ構造を活用した整理
    * 定期的な要約ログの作成
*   **ログファイル作成エラー:** ファイル作成権限やパス問題でログ作成に失敗した場合:
    * エラーメッセージを確認し、パスの正確性を検証
    * 一時的にメモリ内に記録し、次のハートビートで再試行

---

## 5. システム状態管理

この`TROUBLESHOOTING_GUIDE.md`は、AI心臓システムの運用を通じて得られた新たなノウハウや、ツールの挙動に関する知見、より効果的なエラーハンドリングの方法などが判明した際に、**積極的に更新・改善されるべき**です。これにより、本ドキュメントは常に最新の運用知識を反映し、AIの自律的な活動をより強力にサポートする「生きた知識ベース」として機能します。