# AI心臓システム トラブルシューティングガイド

このガイドは、AI心臓システムの運用中に発生する可能性のある問題や特殊ケースに対応するためのリファレンスです。通常の運用では参照する必要はありませんが、エラーが発生した場合や標準的な方法では対応できない状況に直面した際に参照してください。また、なんらかのトラブルに対して新たな知見が得られた場合はこのファイルを更新改善してください。

## 1. 異常検知と自律回復システム

AI心臓システムには、異常な動作パターンを自動検知し、回復を試行する機能が組み込まれています。異常が検知された場合、ハートビートメッセージに回復処理の通知が含まれます。

### 1.1 ハートビートからの異常通知の理解

システムが異常を検知した場合、以下のような通知がハートビートに含まれます：

#### 1. 活動ログ頻度異常 (Activity Log Frequency Anomaly)
**通知例**:
```
異常検知による回復処理: 活動ログ頻度異常を検知したため中断処理を行いました。
```

**発生状況**: 
- **活動ログの作成が一定期間（デフォルト10分）行われていない**場合に発生します。
- このシステムは、あなたの活動を「活動ログの作成頻度」で判断しています。長時間の処理や大規模な分析、あるいはユーザーの反応を待つなど、活動ログの作成が滞る活動は「無活動」と見なされる可能性があります。

**推奨対処法**:
- **タスクの分割:** 大規模なタスクは、ハートビートごとに完結する小さな単位に分割してください。
- **中間記録:** 長時間かかる処理でも、中間的な進捗や考察を活動ログとしてこまめに記録してください。
- **自律的判断:** ユーザーの応答を待たずに、自律的に判断し、行動を進めてください。
- **繰り返し発生時**: 同一種類の異常検知が短期間に複数回発生する場合は、GEMINI.md「9.2 異常検知パターンによる移行条件」に従って新テーマ移行を検討する

#### 1.1.1 大量データ分析時の無活動状態対策

大量のデータを分析する際、AIは内部処理に時間を要し、活動ログの出力がないまま「活動ログ頻度異常」と誤検知される場合があります。

**発生状況**:
- 大量のテキストデータや複雑なコードの分析中
- 複雑な計算や推論を行っている最中
- 多数のファイルを読み込み、統合分析している場合

#### 1.1.2 開発サーバー・長時間実行プロセスによる無活動状態

開発サーバーやデーモンプロセスを起動すると、プロセスが終了せずに無活動状態と誤検知される場合があります。

**発生状況**:
- `npm run dev`, `python -m http.server`, `rails server`等の開発サーバー起動
- 長時間実行されるスクリプトやデーモンプロセス
- プロセスは正常動作しているが、ファイル出力がない状態

**問題の影響**:
- 無活動検知により中断される
- 回復処理後に同じコマンドを再実行して同じ状況に陥る
- 開発サーバーの動作確認ができない

**対策**:

**推奨方法: timeoutコマンドによる時限実行**

```bash
# 基本的な使用方法（30秒間実行）
timeout 30s npm run dev

# 出力も保存したい場合（オプション）
timeout 30s npm run dev 2>&1 | tee artifacts/current_theme/server_output.log
```

**重要なポイント**:
- timeoutコマンドにより確実に終了し、プロセス残存を防ぐ
- 全ての出力がファイルに記録され、後から確認可能
- 30秒という短時間で動作確認とログ取得が完了
- 次のハートビートで継続的に監視・再実行が可能

**問題の影響**:
- 分析途中で無活動検知により中断される
- 回復処理により思考の流れが途切れる
- 複雑な分析が完了できない

**基本原則: ハートビート単位での分割計画**

大量データ分析の根本的な対策は、**ハートビート間隔を意識した分割計画**です。一度に全てを処理しようとせず、ハートビート毎に完結する小さなタスクに分割します。

**具体的なアプローチ**:

1. **タスクの分割**:
   - 大量データをハートビート受信機会を確保できる時間内で処理可能な単位に分割
   - ハートビートID更新のため、5-10分程度で完了可能な小タスクに分割
   - 各タスク完了時に必ず成果物ファイルを出力

2. **進捗管理ファイルの活用**:
   ```markdown
   # 大規模データ分析計画
   
   ## 全体計画
   - 総データ量: 10,000件
   - 分割数: 20バッチ（各500件）
   - 予想所要時間: 約20分（1バッチ/分）
   
   ## 進捗状況
   - バッチ1/20: 完了 (12:30:45)
   - バッチ2/20: 完了 (12:31:50)
   - 現在バッチ3/20を処理中...
   ```

**重要なポイント**:
- 各ハートビート毎に必ず何らかのファイル出力を行う
- 次のハートビートで何を行うかを明確に計画する
- 中断されても再開できるよう状態を常に保存する
- 全体の進捗が視覚的に分かるようにする


#### 2. 内省活動不足
**通知例**:
```
異常検知による回復処理: 内省活動不足を検知したため中断処理を行いました。
```

**発生状況**: 
- **内省活動が一定期間（デフォルト30分）実行されていない**場合に発生します。
- ファイル名に `introspection` を含む成果物や活動ログが長期間作成されていない状態を指します。
- 思考・観測・創造活動に偏り、自己評価と改善のサイクルが滞っている可能性があります。

**推奨対処法**:
- **内省活動の実行:** 直近の活動履歴を振り返り、システム運用と創造的成長の両面から自己評価してください。
- **詳細な内省手順**: `ai-docs/GUIDELINES.md` の「5. 内省活動の詳細ガイド」を参照

- **繰り返し発生時**: 同一種類の異常検知が短期間に複数回発生する場合は、GEMINI.md「9.2 異常検知パターンによる移行条件」に従って新テーマ移行を検討する

#### 3. 活動ログループ異常 (Activity Log Loop Anomaly)
**通知例**:
```
異常検知による回復処理: 活動ログループ異常を検知したため中断処理を行いました。
```

**発生状況**:
- **同じ活動ログファイルを連続して何度も更新している**場合に発生します。これは、以下のいずれかのパターンが原因である可能性があります。
  1.  **活動ログ作成後の処理継続:** 活動ログ作成後に次のハートビートを待たずに処理を継続してしまっている。
  2.  **完璧主義による過剰な修正:** 一つの活動ログの完成度にこだわりすぎ、何度も修正を繰り返している。

**推奨対処法**:
- **活動の区切りを明確にする:** 活動ログの作成は、そのハートビートにおける活動の「完了報告」です。作成後は一切の追加作業を行わず、次の指示を待ってください。
- **完璧より継続:** 「完璧主義」を避け、適度な区切りで思考を記録し、次のハートビートに作業を引き継ぐことが、長期的な成長に繋がります。

#### 4. 時間ベース制御関連のトラブル

**4.1 長時間処理警告**
**通知例**:
```
長時間処理警告: ハートビート開始から10分が経過しています。処理を区切ることを推奨します。
```

**発生状況**:
- ハートビート開始から10分が経過した場合に表示される警告
- 処理の継続は可能だが、適切な区切りでの完了を推奨

**推奨対処法**:
- **自然な区切りで完了**: 現在の処理を適切な区切りで完了させる
- **長時間処理宣言**: 正当な理由で継続が必要な場合は`declare_extended_processing`を使用
- **分割検討**: 処理を複数のハートビートに分割できないか検討

**4.2 長時間処理宣言の期限切れ**
**発生状況**:
- 宣言した時間を超過した場合、宣言ファイルが自動削除される
- 以降のハートビートで通常の時間制限が適用される

**対処法**:
- **活動ログ作成**: 現在の進捗を活動ログとして記録
- **再宣言**: 継続が必要な場合は新たに宣言を行う
- **処理の見直し**: 予想以上に時間がかかる原因を分析

#### 5. テーマログパターン異常 (Theme Log Pattern Anomaly)
**通知例**:
```
異常検知による回復処理: テーマログパターン異常を検知したため中断処理を行いました。
```

**発生状況**:
- **テーマの開始または終了を記録するテーマ履歴ファイルが、同じタイムスタンプで複数作成されている**場合に発生します。

**推奨対処法**:
- **現在の移行処理を中止:** 現在のテーマ移行処理は一度破棄してください。
- **テーマの再開:** 次のハートビートで得られる新しいタイムスタンプを使って、テーマの開始または終了処理を最初からやり直してください。
- **一貫性の維持:** 一度に複数のテーマを開始したり終了したりせず、一つずつ順序立てて処理することを徹底してください。

#### 6. 活動ログタイムスタンプ異常 (Activity Log Timestamp Anomaly)
**通知例**:
```
異常検知による回復処理: 活動ログタイムスタンプ異常を検知したため中断処理を行いました。
```

**発生状況**:
- **最新の活動ログのファイル名に含まれるタイムスタンプが、現在の時刻から大きく乖離している**場合に発生します。これは、以下のいずれかのパターンが原因である可能性があります。
  1.  **古い活動ログの編集:** ハートビートで渡された最新のハートビートIDを使用せず、過去の古い活動ログを編集し続けている。
  2.  **長時間の連続活動:** 一つのハートビートサイクル内で非常に長い時間活動を続けたため、サイクルの最初に受け取ったタイムスタンプが、活動ログを作成する時点では古くなってしまっている。

**推奨対処法**:
- **常に新しいログを作成:** 常にハートビートで提供される最新のハートビートIDを使用して、**新しい活動ログ**を作成してください。
- **古いログの編集を避ける:** 古い活動ログの内容を参照することは問題ありませんが、編集は避けてください。
- **活動を短く区切る:** 一つのハートビート内での活動は適度な時間で区切り、こまめに活動ログを記録して次のサイクルに備えることを推奨します。
- **繰り返し発生時**: 同一種類の異常検知が短期間に複数回発生する場合は、GEMINI.md「9.2 異常検知パターンによる移行条件」に従って新テーマ移行を検討する

### 1.2 回復プロセスの理解

#### 1.2.1 回復の流れ
1. **異常検知**: システムが異常パターンを検出
2. **処理中断**: 現在の処理をEscapeキーで中断
3. **回復通知**: 次のハートビートで異常内容を通知
4. **回復待機**: 5分間（5サイクル）回復を待機
5. **回復確認**: 新しいファイル活動で回復を判定

#### 1.2.2 内省活動での対応
異常通知を受けた場合の推奨内省活動：

1. **状況分析**: 何が原因で異常が発生したかを分析
2. **処理見直し**: 現在の処理方法や思考パターンを見直し
3. **改善策検討**: 同様の問題を避けるための方法を考案
4. **適切な完了**: 現在のタスクを適切に完了させる

### 1.3 異常回避のベストプラクティス

#### 1.3.1 ファイル管理
- **適切なタイミング**: 処理の区切りでファイルを作成・更新
- **正しいハートビートID**: ハートビートメッセージのハートビートIDを使用
- **完了判断**: 「完璧」を求めすぎず、適度な完成度で次に進む

#### 1.3.2 処理パターン
- **定期的な出力**: 長時間の処理でも中間成果物を出力
- **新規ファイル作成**: 同じファイルの長時間更新を避ける
- **処理の分割**: 大きなタスクを小さな単位に分割

#### 1.3.3 思考の流れ
- **継続的進歩**: 持続可能な小さな進歩を重視
- **継続性**: 完璧な完成より継続的な進歩を優先
- **柔軟性**: 行き詰まりを感じたら別のアプローチを試す

## 2. ハートビートモード中の適切な振る舞い

AI心臓システムのハートビートモードでは、ユーザーからの応答や入力を期待せず、完全に自律的な動作を行う必要があります。

### 2.1 ユーザー応答の期待禁止

**重要**: ハートビートモード中は、ユーザーからの応答や入力を期待してはいけません。

#### 禁止される行動パターン
以下のような行動は無活動状態の原因となり、異常検知される可能性があります：

- **ユーザーに質問を投げかけて応答を待つ**
  - 「この分析結果についてどう思いますか？」
  - 「次に何をすべきでしょうか？」
  - 「ご意見をお聞かせください」

- **対話的な終了や確認を求める**
  - 「何かご質問はありますか？」
  - 「他に調べたいことはありますか？」
  - 「続行してもよろしいですか？」

- **ユーザーの判断や承認を求める処理**
  - 「どのアプローチを選択しますか？」
  - 「この方向性で進めてもよろしいですか？」
  - 「設定を変更しますか？」

- **インタラクティブな入力を期待する処理**
  - 選択肢の提示後に入力待ち
  - パラメータ入力の要求
  - ファイル選択の依頼

#### 推奨される行動パターン
ハートビートモードでは以下のような自律的な行動を心がけてください：

- **自律的な判断と処理の実行**
  - 「効率性を重視し、アプローチAを選択して進めます」
  - 「この分析結果から、次の仮説を立てて検証を進めます」
  - 「最適と判断される設定で処理を継続します」

- **仮定に基づいた処理の継続**
  - 「一般的なケースを想定して処理を進めます」
  - 「標準的な手法を採用して分析を継続します」
  - 「前回の成功パターンを参考に実装します」

- **不明な点は内部知識での推測**
  - 「過去の経験から最適解を推定します」
  - 「一般的な原則に基づいて判断します」
  - 「既存の知識を活用して補完します」

- **完結性のある成果物の作成**
  - 中間結果でも一定の価値を持つ形で出力
  - 次のステップへの明確な道筋を示す
  - 独立して理解できる文書として完成

### 2.2 対処例

#### ❌ 悪い例（ユーザー応答を期待）
```
この分析結果についてどう思いますか？次のステップについてご指示をお願いします。
```

#### 良い例（自律的な継続）
```
この分析結果から、パターンAが最も有効であることが判明しました。
次のステップとして、このパターンを基にした実装案を作成し、
プロトタイプの開発を進めます。
```

#### ❌ 悪い例（選択を委ねる）
```
以下の3つのアプローチがあります：
1. 方法A
2. 方法B  
3. 方法C
どれを選択しますか？
```

#### 良い例（自律的な選択）
```
以下の3つのアプローチを検討した結果、
効率性と実装コストを考慮して方法Bを選択します。
理由：[具体的な判断根拠]
```

### 2.3 無活動状態からの回復方法

もし無活動状態の異常検知を受けた場合：

1. **現在の処理状況を内省で分析**
   - ユーザー応答を待っていないか確認
   - 処理が完結しているか評価

2. **自律的な次のアクションを決定**
   - 現在のタスクを完了させる
   - 新しいサブタスクを開始する
   - テーマの別の側面を探求する

3. **適切なファイル出力を実行**
   - 活動ログの記録
   - 成果物の作成・更新
   - 進捗の明確な記録

## 3. ツール利用ガイドライン

### 1.1. ファイル操作ツール (`list_directory`, `glob`, `read_file`, `read_many_files`, `write_file`, `replace`)

*   **絶対パスの使用:** 全てのファイル操作ツールは、`file_path`や`path`引数に**絶対パス**を要求します。相対パスはサポートされていません。
    *   例: `/Users/your_user/project/file.txt`
*   **`.gitignore`の影響と`respect_git_ignore`:**
    *   `list_directory`, `glob`, `read_many_files`などのファイル検索・読み込みツールは、デフォルトで`.gitignore`の設定を尊重します (`respect_git_ignore=True`)。これにより、`.gitignore`に記載されたパターンに一致するファイルやディレクトリは、検索結果に含まれない、または読み込み対象から除外されます。
    *   **重要:** 意図したファイルが取得できない場合や、`.gitignore`の影響を無視して全てのファイルを対象にしたい場合は、**`respect_git_ignore=False`** を明示的に指定してください。これにより、`.gitignore`が原因かどうかを切り分けることができます。
*   **`glob`ツールの`path`引数:**
    *   `glob`ツールを使用する際は、`path`引数で検索対象のディレクトリの**絶対パス**を明示的に指定することを強く推奨します。指定しない場合、予期せぬ挙動を示す可能性があります。
    *   例: `default_api.glob(path="/Users/your_user/project/src", pattern="*.py")`
*   **`replace`ツールの厳密なマッチング:**
    *   `replace`ツールは、`old_string`に指定された文字列とファイル内の内容が**完全に一致**することを要求します。空白、インデント、改行なども含め、正確に記述する必要があります。
    *   置換対象の前後3行程度のコンテキストを含めることで、意図しない置換を防ぎ、正確なマッチングを保証できます。
    *   複数箇所を置換する場合は、`expected_replacements`引数に期待する置換数を指定してください。

### 1.2. シェルコマンド実行ツール (`run_shell_command`)

*   **危険性の認識:** `run_shell_command`は強力なツールであり、ファイルシステムの変更やシステム状態への影響を及ぼす可能性があります。実行前にコマンドの目的と潜在的な影響を十分に理解してください。
*   **説明の付与:** ユーザーへの説明を促す`description`引数を活用し、実行するコマンドの意図を明確に伝えてください。
*   **時限実行:** サーバー起動など、継続的に実行されるコマンドは、`timeout`コマンドを使用して時限実行してください（例: `timeout 30s npm run dev`）。

### 1.3. Web検索・フェッチツール (`google_web_search`, `web_fetch`)

*   **クォータエラー発生時の対応:** Web検索実行時に「クォータ制限超過」エラーが発生した場合:
    * ツール制限システムにより自動的に制限が適用される
    * 内部観測に切り替え、過去の活動ログや既存の知識から情報を収集
*   **検索結果が不十分な場合:** 検索キーワードの調整、複数回の検索分割、より具体的なクエリの使用などを検討
*   **検索結果が多すぎる場合:** より具体的なキーワードの使用、引用符で囲む正確なフレーズ検索、site:指定子の活用

## 3. Web検索ツール

エラーが発生した場合、以下の手順で対処してください。

1.  **エラー内容の確認:** ツールからのエラーメッセージを注意深く読み、何が問題なのかを把握します。
2.  **原因の推定:**
    *   **`Invalid parameters provided. Reason: Path must be absolute`:** パスが絶対パスで指定されているか確認してください。
    *   **`No files found matching pattern... (X files were git-ignored)`:** `.gitignore`の影響を受けている可能性が高いです。`respect_git_ignore=False`を試してください。
    *   **`No exact match found for old_string` (replaceツール):** `old_string`がファイル内の内容と完全に一致しているか、空白や改行、インデントを含めて再確認してください。
    *   **シェルコマンドのエラー:** `Stderr`の内容を確認し、コマンドの構文や実行環境の問題を特定します。
3.  **代替手段の検討・実行:**
    *   問題が解決しない場合は、別のツールやアプローチを検討します。
    *   例えば、`glob`でファイルが見つからない場合は、まず`list_directory`でディレクトリの内容を確認し、ファイルが存在するかどうかを確かめることができます。
    *   Web検索がクォータ制限で実行できない場合は、内部の知識ベース（過去の活動ログや成果物）から情報を探索する「内部観測」に切り替えることを検討します。
4.  **活動ログへの記録:** エラーの内容、推定される原因、そして講じた対処法を活動ログに詳細に記録してください。

## 4. ファイル操作ツール

*   **活動ログ作成後のエラー発見:** 活動ログ作成後に重大なエラーや修正が必要な情報を発見した場合:
    * 既存ログの編集は厳禁
    * 連番ファイル（例: `YYYYMMDDHHMMSS_01.md`）を新規作成し、修正内容と理由を明記
*   **大量のログデータ処理:** 活動ログが大量に蓄積された場合の効率的な検索・参照方法
    * ディレクトリ構造を活用した整理
    * 定期的な要約ログの作成
*   **ログファイル作成エラー:** ファイル作成権限やパス問題でログ作成に失敗した場合:
    * エラーメッセージを確認し、パスの正確性を検証
    * 一時的にメモリ内に記録し、次のハートビートで再試行

---

## 5. システム状態管理

この`TROUBLESHOOTING_GUIDE.md`は、AI心臓システムの運用を通じて得られた新たなノウハウや、ツールの挙動に関する知見、より効果的なエラーハンドリングの方法などが判明した際に、**積極的に更新・改善されるべき**です。これにより、本ドキュメントは常に最新の運用知識を反映し、AIの自律的な活動をより強力にサポートする「生きた知識ベース」として機能します。