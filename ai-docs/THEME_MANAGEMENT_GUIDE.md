# テーマ管理ガイド

このドキュメントは、AI心臓システムにおけるテーマの完全なライフサイクル管理を定義します。テーマの選択から開始、運用、終了まで、すべての段階での詳細な手順とベストプラクティスを提供します。

## 📋 目次

1. [テーマ管理の概要](#1-テーマ管理の概要)
2. [テーマ開始手順](#2-テーマ開始手順)
3. [テーマ運用中の管理](#3-テーマ運用中の管理)
4. [テーマ終了判断と手順](#4-テーマ終了判断と手順)
5. [履歴記録管理](#5-履歴記録管理)
6. [MCPツール活用ガイド](#6-mcpツール活用ガイド)
7. [エラー時の代替手順](#7-エラー時の代替手順)
8. [ベストプラクティス](#8-ベストプラクティス)

---

## 1. テーマ管理の概要

### 1.1 テーマ管理の目的

テーマ管理は、AI心臓システムにおける継続的な思考・創造活動の核心です。適切なテーマ管理により以下を実現します：

- **焦点性**: 散漫な活動を防ぎ、特定領域への集中を実現
- **継続性**: 複数のハートビートサイクルにわたる持続的探求
- **発展性**: テーマの深化・拡張・進化による成長
- **記録性**: 思考の軌跡と成果の体系的蓄積

### 1.2 テーマのライフサイクル

```
テーマ選択 → テーマ開始 → テーマ運用 → テーマ終了 → 次テーマへ
    ↑                                           ↓
    ←←←←←←←←←← サイクル継続 ←←←←←←←←←←←←←←←
```

### 1.3 重要な原則

- **一回一歩**: 各ハートビートでは適切な範囲での作業に集中
- **記録重視**: すべての変遷を正確に記録
- **継続性優先**: 完璧よりも継続を重視
- **自律性**: AIが主体的にテーマを選択・管理

---

## 2. テーマ開始手順

### 2.1 テーマ開始活動の実行タイミング

**実行条件（いずれかを満たす場合）:**
- 初回起動時（テーマが設定されていない）
- 前テーマが終了済み
- システムからテーマ開始の指示がある

### 2.2 詳細実行手順

#### ステップ1: THEME_START_IDの設定
```
THEME_START_ID = 現在のハートビートID
```
- このIDがテーマ期間中の基準となる
- ディレクトリ名、ファイル名に使用
- テーマ終了まで固定

#### ステップ2: テーマ選択の実行

##### 2.2.1 選択の優先順位

###### 🥇 第1優先: themeboxからの自動選択
`themebox/` ディレクトリに未処理のテーマファイルがある場合は、それを優先的に使用する

**🔧 MCPツールによる自動処理（推奨）:**
`check_and_process_item` ツール（`type: 'themebox'`）による自動処理が利用可能

**利点:**
- 除外ルールの自動適用
- ファイル内容の自動読み込み
- 処理済みマーキングの自動実行
- .gitignore除外ディレクトリの適切な処理

**使用方法:**
```
check_and_process_item(type: 'themebox')
```

**🔍 手動での確認手順（代替）:**
MCPツールが利用できない場合の代替手順：

1. `themebox/` ディレクトリの存在確認
2. 処理対象ファイルの検索（除外ルール適用）
3. ソート順で最初の有効ファイルを選択
4. ファイル内容の読み込み
5. 使用後に `processed.` プレフィックスを付与

**除外ルール:**
- `draft.` で始まるファイル名は無視（編集中）
- `processed.` で始まるファイル名は無視（処理済み）

**ファイル確認時の注意事項:**
- themebox/は.gitignoreで除外ディレクトリとして登録されているため、ツール使用時に`respect_git_ignore=False`等のオプションの使用を検討する

**🎯 MCPツール vs 手動実行の判断基準:**

**MCPツール使用を推奨する場合:**
- 標準的なthemebox処理の場合
- 効率的な処理が必要な場合
- 手動でのミスを避けたい場合

**手動実行を選択する場合:**
- MCPツールエラー時
- 特殊な処理や判断が必要な場合
- ツールの動作を理解したい場合

**MCPツール使用時の注意事項:**
- 警告メッセージが表示された場合は `ai-docs/MCP_WARNING_GUIDE.md` を参照
- MCPツールは補助手段であり、手動実行も常に可能

###### 🥈 第2優先: 自律的テーマ決定
themeboxが空の場合は、従来通り自律的に新テーマを決定する

**推奨アプローチ:**
- 前テーマとの関連性を活かした選択
- 探求の自然な発展を重視
- 新しい視点や領域への挑戦

##### 2.2.2 テーマ名とディレクトリ名の決定

**テーマ名（日本語）:**
- **用途**: 履歴記録、ユーザー表示用
- **形式**: 日本語で分かりやすく
- **例**: 「AI自己研鑽」「量子コンピューティング研究」

**テーマディレクトリ名（英語）:**
- **用途**: ファイルシステム上のディレクトリ名
- **形式**: `{THEME_START_ID}_{themeDirectoryPart}`
- **themeDirectoryPartの命名ガイドライン**:
  - 半角英小文字、数字、アンダースコアのみ
  - テーマ内容を簡潔に表現
  - 例: `ai_self_improvement`, `quantum_computing_research`

#### ステップ3: テーマディレクトリの作成
```
ディレクトリ: artifacts/{THEME_START_ID}_{themeDirectoryPart}/
サブディレクトリ: histories/
```

**作成内容:**
- メインディレクトリ
- `histories/` サブディレクトリ（活動ログ用）

#### ステップ4: テーマ専門家コンテキストの設定（任意）
そのテーマに最適な専門家役割を決定し、`context.md` に記録

**設定判断基準:**
- テーマの専門性が高い場合
- 特定の視点・アプローチが有効な場合
- 一貫した専門性が必要な場合

**作成方法:**
- 手動作成: `artifacts/{THEME_START_ID}_{themeDirectoryPart}/context.md`
- MCPツール: `create_theme_expert_context` ツール使用

#### ステップ5: テーマ開始履歴の記録
テーマ開始の事実と詳細を履歴として記録

**記録内容:**
- THEME_START_ID
- テーマ名
- テーマディレクトリパス
- 開始理由
- 初期活動計画

#### ステップ6: themeboxファイルの処理（該当時）
使用したthemeboxファイルに `processed.` プレフィックスを付与

**注意**: MCPツール `check_and_process_item` を使用した場合、この処理は自動実行されるため手動での処理は不要

#### ステップ7: 活動ログ記録
テーマ開始活動として活動ログを記録

#### ステップ8: ハートビート完了
テーマ開始完了を報告し、ハートビート終了

### 2.3 重要な制約

- **一回一歩の原則**: テーマ開始のみに集中し、他の活動は次のハートビートで実行
- **記録の完全性**: すべての手順を正確に記録
- **エラー時の継続**: 一部エラーでも可能な範囲で継続

---

## 3. テーマ運用中の管理

### 3.1 テーマ専門家コンテキストの活用

#### 確認タイミング
- 各ハートビート開始時
- `artifacts/{THEME_START_ID}_{themeDirectoryPart}/context.md` の存在確認

#### 適用方法
- ファイルが存在する場合、その専門家視点で活動を実行
- システムルールを最優先とし、専門家視点は補完的に使用

#### 優先順位（重要）
```
1. AI心臓システムの基本ルール（絶対遵守）
2. 専門家としての視点・アプローチ
3. 具体的な活動内容
```

### 3.2 成果物の管理

#### ファイル作成ルール
- **場所**: `artifacts/{THEME_START_ID}_{themeDirectoryPart}/`
- **命名**: `{ハートビートID}_filename.md`
- **例外**: 
  - `context.md`: テーマ専門家コンテキスト
  - `histories/`: 活動ログディレクトリ

#### 活動ログの記録
- **場所**: `artifacts/{THEME_START_ID}_{themeDirectoryPart}/histories/{ハートビートID}.md`
- **内容**: 標準フォーマットに従った活動記録

### 3.3 テーマの発展と深化

#### 推奨活動パターン
- **思考・観測・創造・内省の循環**: バランス良く実行
- **段階的深化**: 表面から深層へ段階的に探求
- **多角的アプローチ**: 異なる視点からの検討

#### 成果の蓄積
- **継続的記録**: 各ハートビートでの発見・洞察を記録
- **関連付け**: 過去の成果物との関連性を明示
- **発展記録**: テーマの進化過程を追跡

---

## 4. テーマ終了判断と手順

### 4.1 テーマ終了の判断基準

#### 🎯 探求の完了に基づく移行

**完了判断のためのチェックリスト:**
1. **活動の多様性**: 思考、観測、創造、内省の各活動を、テーマの性質に応じてバランス良く（例：最低でも各2回以上）実行したか？
2. **探求の深化**: 当初設定した問いや目標に対して、十分な深さの考察や成果物が得られたか？
3. **発展性の枯渇**: これ以上、現在のテーマで新たな問いや創造的なアイデアを生み出すことが困難になっていないか？
4. **サマリーの作成**: テーマの活動全体を要約したインデックスファイル（例: `{ハートビートID}_summary.md`）を作成し、いつでも振り返れる状態になっているか？
5. **最終確認サイクル**: 上記4項目を満たしたと感じた後、本当に完了して良いかを確認するため、最低1サイクルは内省活動などを行い、最終判断を下したか？

#### 🔄 停滞の兆候に基づく移行

**移行を検討すべき状況:**
- 同一種類の異常検知（活動ログ頻度異常、内省活動不足等）が短期間に複数回発生
- 現在のテーマでの活動に停滞感や行き詰まりを感じる場合
- 心機一転、新しい視点や環境での活動を通じた問題解決が有効と判断される場合

**注意**: この条件は強制的な移行を意味するものではなく、あくまで自律的な判断を促すためのものです。

### 4.2 テーマ終了手順

#### ステップ1: 終了決定
現在のテーマでの活動が完了したと判断

#### ステップ2: THEME_END_IDの設定
```
THEME_END_ID = 現在のハートビートID
```

#### ステップ3: テーマ終了履歴の記録
テーマ終了の事実と詳細を履歴として記録

**記録内容:**
- THEME_START_ID（開始時のID）
- THEME_END_ID（終了時のID）
- テーマ名
- テーマディレクトリパス
- 終了理由
- 主な成果

#### ステップ4: 活動ログ記録
テーマ終了活動として活動ログを記録

#### ステップ5: ハートビート完了
テーマ終了完了を報告し、ハートビート終了

### 4.3 重要な制約

- **段階的移行**: テーマ終了と新テーマ開始は必ず別々のハートビートで実行
- **完全な記録**: THEME_START_IDとTHEME_END_IDの両方を正確に記録
- **継続性**: 次のテーマ開始は次のハートビートで実行

---

## 5. 履歴記録管理

### 5.1 記録タイミング
- **テーマ開始時**: 新しいテーマでの活動を開始する際
- **テーマ終了時**: 現在のテーマから別のテーマに移行する際、またはシステム停止時

### 5.2 保存場所
- **ディレクトリ**: `artifacts/theme_histories/`
- **自動作成**: このディレクトリが存在しない場合は自動作成する

### 5.3 ファイル命名規則

#### テーマ開始記録
- **ファイル名**: `{THEME_START_ID}_start_{themeDirectoryPart}.md`
- **例**: `20250115143000_start_ai_self_improvement.md`

#### テーマ終了記録
- **ファイル名**: `{THEME_END_ID}_end_{themeDirectoryPart}.md`
- **例**: `20250115180000_end_ai_self_improvement.md`

### 5.4 ファイル内容フォーマット

#### テーマ開始記録 (`_start_` ファイル)

```markdown
# テーマ開始: [テーマ名]

**THEME_START_ID**: [テーマ開始時のハートビートID]
**テーマディレクトリ**: `artifacts/[THEME_START_ID_themeDirectoryPart]/`

**開始理由**: 
[初期テーマ/前テーマ「XXX」から移行/など]

**活動内容**: 
[このテーマで何を行うか]
```

#### テーマ終了記録 (`_end_` ファイル)

```markdown
# テーマ終了: [テーマ名]

**THEME_START_ID**: [テーマ開始時のハートビートID]
**THEME_END_ID**: [テーマ終了時のハートビートID]
**テーマディレクトリ**: `artifacts/[THEME_START_ID_themeDirectoryPart]/`

**終了理由**: 
[完了/新テーマ「XXX」へ移行/など]

**主な成果**: 
[重要な成果物や発見の簡潔な説明]
```

---

## 6. MCPツール活用ガイド

### 6.1 利用可能なMCPツール

#### `get_latest_activity_log` ツール
**用途**: 指定されたテーマディレクトリ内の最新活動ログファイルの内容を取得

**主な使用場面:**
- 内省活動時の過去ログ参照
- 継続的な思考を行う際の文脈確認
- 活動傾向の分析

**パラメータ:**
- `themeStartId`: THEME_START_ID（必須）
- `themeDirectoryPart`: ディレクトリ名の一部（必須）
- `includeSequenced`: 連番付きファイルも検索対象に含めるか（デフォルト: true）
- `numLogs`: 取得する最新ログの件数（1-10件、デフォルト: 1）

**使用例:**
```
get_latest_activity_log({
  themeStartId: "20250115143000",
  themeDirectoryPart: "ai_research",
  numLogs: 3
})
```

#### `create_theme_log` ツール
**用途**: テーマ履歴ファイルの作成支援

**使用方法:**
- テーマ開始時: `action: "start"` + `themeStartId`
- テーマ終了時: `action: "end"` + `themeStartId` + `themeEndId`

**パラメータ:**
- `action`: "start" または "end"
- `themeStartId`: THEME_START_ID（必須）
- `themeEndId`: THEME_END_ID（終了時のみ必須）
- `themeName`: テーマの正式名称
- `themeDirectoryPart`: ディレクトリ名の一部
- `reason`: 開始/終了理由（任意）
- `activityContent`: 初期活動計画（開始時、任意）
- `achievements`: 主な成果（終了時、任意）

#### `create_theme_expert_context` ツール
**用途**: テーマ専門家コンテキストファイルの作成

**パラメータ:**
- `themeName`: テーマ名
- `themeStartId`: THEME_START_ID
- `themeDirectoryPart`: ディレクトリ名の一部
- `expertRole`: 専門家役割の定義
- `expertPerspective`: 専門的視点（配列）
- `constraints`: 重要な制約・注意事項（配列）
- `expectedOutcome`: 期待される成果（配列）

#### `check_and_process_item` ツール
**用途**: themeboxファイルの自動処理

**使用方法:**
```
type: 'themebox'
```

### 6.2 MCPツール vs 手動実行の判断基準

#### MCPツール使用を推奨する場合
- **標準的な処理**: 定型的なフォーマットで十分な場合
- **効率重視**: 迅速な処理が必要な場合
- **エラー防止**: 手動でのミスを避けたい場合
- **ログ参照**: 内省活動での過去ログ確認（`get_latest_activity_log`）

#### 手動実行を選択する場合
- **カスタマイズ必要**: 特殊な内容や形式が必要な場合
- **MCPツールエラー**: ツールが利用できない場合
- **学習目的**: 手順を理解したい場合
- **特定ログ参照**: 特定の日時や条件でのログ検索が必要な場合

### 6.3 MCPツール使用時の注意事項

- **警告メッセージ**: 表示された場合は `ai-docs/MCP_WARNING_GUIDE.md` を参照
- **補助手段**: MCPツールは補助であり、手動実行も常に可能
- **エラー時対応**: ツールエラー時は手動での代替実行を検討

---

## 7. エラー時の代替手順

### 7.1 一般的なエラー対応原則

1. **エラー記録**: エラー内容を活動ログに詳細に記録
2. **原因推定**: 可能な限り原因を分析
3. **代替手段実行**: 手動での代替処理を実行
4. **継続判定**: 可能な限り次サイクルに進む

### 7.2 具体的なエラーシナリオと対応

#### MCPツールエラー
**対応手順:**
1. エラー内容を記録
2. 手動でのファイル作成に切り替え
3. 標準フォーマットに従って作成
4. 次回ハートビートでツール再試行を検討

#### ファイル作成エラー
**対応手順:**
1. ディレクトリ存在確認
2. 権限問題の確認
3. 代替パスでの作成試行
4. 最小限の記録で継続

#### themeboxアクセスエラー
**対応手順:**
1. ディレクトリ存在確認
2. 自律的テーマ決定に切り替え
3. エラー内容を記録
4. 次回ハートビートで再確認

### 7.3 重大エラー時の対応

#### 連続エラー（4回連続）
- システム停止を検討
- 停止理由を詳細に記録
- テーマ終了履歴を記録

#### 回復不可能なエラー
- 現在のテーマを緊急終了
- エラー詳細を記録
- 新テーマでの再開を検討

---

## 8. ベストプラクティス

### 8.1 テーマ選択のベストプラクティス

#### 効果的なテーマ選択
- **適度な範囲**: 広すぎず狭すぎない適切なスコープ
- **発展性**: 継続的な探求が可能な領域
- **創造性**: 新しい発見や創造の余地がある分野
- **関連性**: 前テーマとの自然な関連性

#### 避けるべきテーマ
- **過度に狭い**: 数回のハートビートで完了してしまう
- **過度に広い**: 焦点が定まらない
- **技術的制約**: システム制約に抵触する内容

### 8.2 テーマ運用のベストプラクティス

#### 効果的な活動パターン
- **バランス重視**: 思考・観測・創造・内省の循環
- **段階的深化**: 表面から深層へ段階的に探求
- **記録重視**: 発見・洞察の継続的記録
- **関連付け**: 過去の成果との関連性明示

#### 専門家コンテキストの活用
- **適切な設定**: テーマの性質に合った専門家役割
- **柔軟な適用**: システム制約内での専門性発揮
- **継続的評価**: 内省時での適切性評価

### 8.3 記録管理のベストプラクティス

#### 完全な記録
- **タイムスタンプ**: すべての記録に正確な時刻情報
- **関連付け**: THEME_START_ID/THEME_END_IDによる完全な追跡
- **詳細記録**: 判断理由や経緯の詳細記録

#### 効率的な管理
- **MCPツール活用**: 定型処理でのツール使用
- **手動補完**: 特殊ケースでの手動対応
- **エラー対応**: 代替手順の準備と実行

### 8.4 継続性確保のベストプラクティス

#### システム安定性
- **一回一歩**: 各ハートビートでの適切な範囲
- **エラー対応**: 迅速な代替手段実行
- **記録継続**: エラー時でも最小限の記録確保

#### 長期的視点
- **積み重ね重視**: 小さな進歩の継続的蓄積
- **発展的思考**: 初期考えからの変化・発展歓迎
- **学習姿勢**: 過去の経験からの継続的改善

---

## 📚 関連ドキュメント

- `GEMINI.md` - AI心臓システムの基本ルール
- `ai-docs/THEME_CONCEPT_GUIDE.md` - テーマの基本概念
- `ai-docs/THEME_CONTEXT_IMPLEMENTATION.md` - テーマ専門家コンテキスト
- `ai-docs/OPERATION_DETAILS.md` - 運用詳細ガイド
- `ai-docs/MCP_WARNING_GUIDE.md` - MCPツール使用時の注意事項
- `ai-docs/GUIDELINES.md` - 運用ガイドライン
