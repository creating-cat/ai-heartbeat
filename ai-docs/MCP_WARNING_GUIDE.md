# MCP警告・エラー対応ガイド

## 概要

AI心臓システム用MCP（Model Context Protocol）ツールが出力する警告やエラーメッセージへの対応方法を説明します。

## MCPツール共通の警告

### 1. 時刻乖離警告

**警告メッセージ例:**
```
情報: ハートビートIDの時刻と現在時刻に 8分 の乖離があります。
警告: ハートビートIDの時刻と現在時刻に 12分 の乖離があります。
重大: ハートビートIDの時刻と現在時刻に 14分 の乖離があります。
```

**直接的な原因:**
- ハートビートIDの時刻と現在時刻に乖離が発生している

**想定される根本原因:**
- 処理時間の長期化による時刻差の蓄積
  - 1ハートビート内での複数処理の実行や、分割不可の長時間処理の実行
- 過去のハートビートIDを意図せず使用している

**この警告の影響範囲:**
- この状態が続くと、AI心臓システムの理念である「小さな一歩」が実現されていない可能性がある。
  - 警告レベルが高いほど長期間処理になってしまっていて、小さな積み重ねができていない可能性がある。
- ハートビートIDの間違った運用を行っている可能性がある。
- この警告は、create_activity_log と create_theme_log の両方で発生する可能性があります。

**対応方法:**
1. **タスクを終了**: 次のハートビートでの内省するために、タスクを終了してプロンプト待ち状態にして、次のハートビート受信を待機します。
2. **次のハートビートでの内省**: 以下について内省する
  - 原因の考察
    - 1ハートビート内で複数処理を実行していたりしたか？
    - 長期の実行になってしまうことが意図された、分割不可の長期間処理だったり、複数処理の実行だったりしたか？
    - ハートビートIDの間違った運用を行っていないかを確認する。
    - その他原因について考察する
  - 事象の評価と今後の予防策について
    - 今回の事象は問題ありだったか問題なしだったか？
      - 分割不可の長期処理だった場合は問題なし
      - 分割可能な複数処理だった場合は効率等を踏まえて分割すべきだったかどうかを考える
    - 今後の予防策が必要かどうかとその内容を検討する
3. **活動ログ作成・タスクを終了**: 今回の活動ログ作成しタスクを終了する

**予防策:**

- 複数処理を行う場合は、効率等を考慮しつつ、複数ハートビートで分割しての対応可能かどうかを検討する


## 活動ログ作成ツール（create_activity_log）の警告

### 1. 重複ハートビートID警告

**警告メッセージ例:**
```
警告: ハートビートID 20250115143000 は既に存在するため、連番 01 を付与しました。
```

**直接的な原因:**
- 同一のハートビートIDで複数回ログ作成を試行している

**想定される根本原因:**
- 活動ログ作成後に、タスクを終了せず次のハートビートを待たずに、次の処理を継続してしまっている。

**この警告の影響範囲:***
- 意図しない連続実行の場合、AI心臓システムの理念である「小さな一歩」が実現されていない可能性がある。

**対応方法:**
1. **タスクを終了**: 次のハートビートでの内省するために、タスクを終了してプロンプト待ち状態にして、次のハートビート受信を待機します。
2. **次のハートビートでの内省**: 以下について内省する
   - 原因の考察
     - 活動ログ作成後にタスクを終了せず処理をしてしまっていた場合があったか
     - 意図的な同一のハートビートIDでのログ作成だったか
     - その他原因について考察する
   - 事象の評価と今後の予防策について
     - 今回の事象は問題ありだったか問題なしだったか？
     - 今後の予防策が必要かどうかとその内容を検討する
3. **活動ログ作成・タスクを終了**: 今回の活動ログ作成しタスクを終了する

**予防策例:**
- 活動ログ作成後に必ずタスクを終了し、プロンプト待ち状態にして、次のハートビート受信を待機する。


## テーマ履歴作成ツール（create_theme_log）の警告・エラー

### 1. ハートビートID重複エラー（ルール違反）

**エラーメッセージ例:**
```
ルール違反: 同じハートビートID (20250115143000) を持つテーマ履歴ファイルが既に存在します（20250115143000_start_ai_research.md）。1つのハートビートで複数のテーマ操作（開始/終了）はできません。
```

**直接的な原因:**
- 同一のハートビートIDで複数のテーマ履歴ファイル作成を試行している

**想定される根本原因:**
- 1つのハートビート内でテーマ終了と新テーマ開始を同時に実行しようとしている
- テーマ移行の安全性確保の原則に反する複数のテーマ操作を実行している

**この警告の影響範囲:**
- **重大なルール違反**: AI心臓システムの基本原則であるテーマ移行の安全性確保に直接違反している
- システムの異常検知機能により、さらなる問題が発生する可能性がある

**対応方法:**
1. **即座にタスクを終了**: エラーが発生した時点で、そのハートビートでの作業を完全に停止する
2. **次のハートビートでの内省**: 以下について徹底的に内省する
   - 原因の考察
     - なぜ1つのハートビートで複数のテーマ操作を行おうとしたか？
     - テーマ移行の手順を正しく理解していたか？
     - テーマ移行の安全性確保の重要性を忘れていなかったか？
   - 事象の評価と今後の予防策について
     - 今回の事象は明確な問題行動であったことを認識する
     - テーマ移行時の正しい手順を再確認する
     - 今後の予防策を具体的に検討する
3. **正しい手順での再実行**: 次のハートビートで、1つのテーマ操作のみを実行する

**予防策:**
- **テーマ移行の安全性確保**: テーマ終了と新テーマ開始は必ず別々のハートビートで実行する
  理由: テーマ履歴の整合性確保とシステムの異常検知回避のため
- **THEME_MANAGEMENT_GUIDE.mdの遵守**: テーマ管理の正しい手順を常に参照する
- **適切な粒度での実行**: ハートビート受信機会を確保するため、テーマ操作は適切に区切って実行する

### 2. ディレクトリ名サニタイズ警告

**警告メッセージ例:**
```
注意: 指定されたディレクトリ名「AI研究/新しいテーマ」は命名規則に合わない、または安全でない可能性があるため、「ai_____」に修正しました。今後は半角英小文字、数字、アンダースコアのみを使用してください。
```

**直接的な原因:**
- ディレクトリ名に日本語、特殊文字、スラッシュなどの不適切な文字が含まれている

**想定される根本原因:**
- ファイルシステムの命名規則への理解不足
- セキュリティ上の配慮不足（ディレクトリトラバーサル攻撃の防止）

**この警告の影響範囲:**
- ファイルシステムの安全性に関わる問題
- 意図しないディレクトリ構造の作成

**対応方法:**
1. **警告内容の確認**: 修正されたディレクトリ名を確認し、意図した名前になっているかチェック
2. **次回からの改善**: 以下の命名規則を遵守する
   - 半角英小文字のみ使用
   - 数字の使用は可能
   - アンダースコア（_）の使用は可能
   - 日本語、特殊文字、スラッシュは使用禁止
3. **必要に応じて手動修正**: 自動修正された名前が不適切な場合は、次のハートビートで適切な名前に変更

**予防策:**
- **英語での命名**: テーマディレクトリ名は常に英語で命名する
- **命名例**: `ai_research`, `quantum_computing`, `creative_writing` など
- **事前確認**: ディレクトリ名を決める際は、命名規則を事前に確認する

### 3. ファイル既存エラー

**エラーメッセージ例:**
```
テーマ履歴ファイルは既に存在します: artifacts/theme_histories/20250115143000_start_ai_research.md。ハートビートIDが重複していないか確認してください。
```

**直接的な原因:**
- 同じファイル名のテーマ履歴ファイルが既に存在している

**想定される根本原因:**
- 同じハートビートIDとテーマ操作の組み合わせで複数回実行している
- ファイルシステムの状態確認不足

**対応方法:**
1. **ファイル確認**: 既存のファイルが正しく作成されているか確認
2. **処理を継続**: 必要に応じて追加の処理を実行する
3. **活動ログ作成・タスクを終了**: 今回の活動ログ作成しタスクを終了する

**予防策:**
- **実行前確認**: テーマ履歴作成前に、既存ファイルの有無を確認
- **一度だけ実行**: 同じテーマ操作は1回のみ実行する


## 関連ドキュメント

- [運用詳細ガイド](OPERATION_DETAILS.md)
- [ガイドライン](GUIDELINES.md)
- [トラブルシューティングガイド](TROUBLESHOOTING_GUIDE.md)
