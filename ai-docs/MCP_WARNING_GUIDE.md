# MCP警告対応ガイド

## 概要

AI心臓システム用MCP（Model Context Protocol）ツールが出力する警告メッセージへの対応方法を説明します。

## 思考ログ作成ツール（create_thinking_log）の警告

### 1. 重複ハートビートID警告

**警告メッセージ例:**
```
⚠️ ハートビートID 20250115143000 は既に存在するため、連番 01 を付与しました。
```

**直接的な原因:**
- 同一のハートビートIDで複数回ログ作成を試行している

**想定される根本原因:**
- 思考ログ作成後に、タスクを終了せず次のハートビートを待たずに、次の処理を継続してしまっている。

**この警告の影響範囲:***
- この状態が続くと、AI心臓システムの理念である「小さな一歩」が実現されていない可能性がある。

**対応方法:**
1. **タスクを終了**: タスクを終了してプロンプト待ち状態にして、次のハートビート受信を待機します。
2. **次のハートビートでの内省**: 以下について内省する
   - 原因の考察
     - 思考ログ作成後にタスクを終了せず処理をしてしまっていた場合があったか
     - 意図的な同一のハートビートIDでのログ作成だったか
   - 今後の予防策について
3. **思考ログ作成・タスクを終了**: 今回の思考ログ作成しタスクを終了する

**予防策:**
- 思考ログ作成後に必ずタスクを終了し、プロンプト待ち状態にして、次のハートビート受信を待機する。


### 2. 時刻乖離警告

#### 2.1 情報レベル（ℹ️ 情報）

**警告メッセージ例:**
```
ℹ️ 情報: ハートビートIDの時刻と現在時刻に 8分 の乖離があります。
```

**原因:**
- 軽微なシステム時刻のずれ
- 処理遅延による時刻差

**対応方法:**
1. **継続**: 通常の活動を継続
2. **軽微な確認**: システム時刻を確認（緊急性は低い）

#### 2.2 警告レベル（⚠️ 警告）

**警告メッセージ例:**
```
⚠️ 警告: ハートビートIDの時刻と現在時刻に 12分 の乖離があります。
```

**原因:**
- システム時刻の大きなずれ
- 長時間の処理遅延
- 手動入力での時刻ミス

**対応方法:**
1. **時刻確認**: システム時刻を確認・修正
2. **継続判断**: 活動は継続可能だが、時刻同期を検討
3. **記録**: 乖離の原因を記録（後で分析）

#### 2.3 重大レベル（🚨 重大）

**警告メッセージ例:**
```
🚨 重大: ハートビートIDの時刻と現在時刻に 14分 の乖離があります。
```

**原因:**
- 重大なシステム時刻のずれ
- heartbeat.shエラー直前の状態
- 意図的でない古い時刻での実行

**対応方法:**
1. **即座に時刻確認**: システム時刻を即座に確認・修正
2. **システム状態確認**: heartbeat.shの状態を確認
3. **一時停止検討**: 必要に応じて活動を一時停止し、システム調整
4. **ログ確認**: 他のログでも同様の問題が発生していないか確認

**注意:**
- この警告が出た場合、heartbeat.shがエラーで停止する可能性が高い
- 早急な対応が必要

## 複数警告の対応

**警告メッセージ例:**
```
思考ログを作成しました: artifacts/theme/histories/20250115143000_01.md
⚠️ ハートビートID 20250115143000 は既に存在するため、連番 01 を付与しました。
🚨 重大: ハートビートIDの時刻と現在時刻に 14分 の乖離があります。
```

**対応方法:**
1. **最も重大な警告を優先**: 時刻乖離（🚨 重大）を最優先で対応
2. **段階的対応**: 重大な問題を解決してから、他の警告に対応
3. **根本原因の特定**: 複数警告の関連性を確認

## 警告の記録と分析

### 記録すべき情報
- 警告発生時刻
- 警告内容
- 実行していた活動
- システム状態
- 対応内容

### 分析観点
- 警告の発生パターン
- システム環境との関連
- 改善可能な運用手順

## システム設定の確認

### heartbeat.conf の確認
```bash
# 時刻乖離の閾値確認
grep TIMESTAMP_ANOMALY_THRESHOLD heartbeat.conf
```

**デフォルト値:** 900秒（15分）

### 警告タイミング
- 情報: 閾値の50%（デフォルト7.5分）
- 警告: 閾値の75%（デフォルト11.25分）
- 重大: 閾値の90%（デフォルト13.5分）

## トラブルシューティング

### よくある問題

#### 1. 頻繁な時刻乖離警告
**原因:** システム時刻の不安定性
**解決:** NTPサーバーとの同期設定確認

#### 2. 重複警告の多発
**原因:** 処理の重複実行
**解決:** 実行タイミングの調整、プロセス管理の確認

#### 3. 警告が表示されない
**原因:** MCPツールの設定問題
**解決:** heartbeat.confの設定確認、MCPサーバーの再起動

## 関連ドキュメント

- [運用詳細ガイド](OPERATION_DETAILS.md)
- [ガイドライン](GUIDELINES.md)
- [トラブルシューティングガイド](TROUBLESHOOTING_GUIDE.md)

## 更新履歴

- 2025-01-15: 初版作成（思考ログツール対応）