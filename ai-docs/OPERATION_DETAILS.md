# 運用詳細ガイド

このドキュメントは、AI心臓システムの運用時に参照する詳細な手順とルールを定義します。

## 1. 活動ログ管理の詳細

### 1.1 ファイル名形式
* **形式**: `YYYYMMDDHHMMSS.md` (例: `20250702140000.md`)
* **ハートビートID**: 受け取ったハートビートメッセージにあるハートビートID（タイムスタンプ形式）を使用
* **保存場所**: `artifacts/{THEME_START_ID_テーマ名}/histories/` ディレクトリ内

### 1.2 記録内容のフォーマット

各活動ログファイルは、以下の構造とルールに従って記録すること：

```markdown
# ハートビートログ：YYYYMMDDHHMMSS

## 活動種別
[実行した活動種別（観測・思考・創造・内省・その他）。補助的な操作を使用した場合は、括弧書きで操作名を追記。例: 思考 (ファイル読み込み使用)]

## 活動内容
[今回のハートビートでの簡潔な活動内容。(詳細は関連ファイルに記載されていることが前提)]

## 成果物、関連ファイル
[このハートビートで作成または修正したファイルの**プロジェクトルートからの相対パス**を列挙(この活動ログファイル自身は除く)。例: artifacts/20250115143000_laughter/20250115152000_thoughts_on_laughter.md]

## 自己評価、備考
[このハートビートでの活動内容の評価やその他特記事項があれば記載。例: Web検索クォータ制限のため、文献調査を中断。]
```

### 1.3 複数タスク実行時の記録
* **活動種別**: 実行した全タスクを記載（例: 思考・創造）
* **活動内容**: 各タスクの内容を分けて記載
* **連番ファイル**: `YYYYMMDDHHMMSS_01.md`等は、活動ログ作成後に修正が必要になった場合のみ使用可能(ただし一回のみ許可)

### 1.4 MCPツールによる活動ログ作成・参照支援

**create_activity_log ツール**:
- 標準的なフォーマットでの活動ログファイル自動作成
- ハートビートIDを使用した適切なファイル名生成

**get_latest_activity_log ツール**:
- 指定されたテーマディレクトリ内の最新活動ログファイルの内容を取得
- 内省活動時の過去ログ参照に特に有用
- 複数ログの一括取得による傾向分析が可能（numLogsパラメータで1-10件指定）
- 連番付きファイル（_01, _02等）も自動で検索対象に含む

**使用時の注意事項**:
- ツール使用時に警告メッセージが表示された場合は、`ai-docs/MCP_WARNING_GUIDE.md`を参照
- MCPツールは補助手段であり、手動での活動ログ作成・参照も可能


## 2. ツール使用制限の詳細

### 2.1 利用制限の確認

`ai-docs/TOOL_RESTRICTIONS.md` を確認し、使用するツールにどのような制限があるか（サイクルベース、時間ベースなど）を確認してください。

### 2.2 時間ベース制限のあるツールの使用報告

`ai-docs/TOOL_RESTRICTIONS.md` に記載されているツールのうち、**時間ベースの制限**を持つツールを使用した後は、システムがクールダウンやロックを正しく管理できるよう、ツールの実行結果を報告する必要があります。報告には以下の方法があります。

#### 2.2.1 手動での状態報告（基本操作）

MCPツールが利用できない場合や、基本的なファイル操作として、以下のコマンドを実行して状態ファイルを手動で作成してください。これが最も確実な方法です。

*   **成功 (`success`) の場合:**
    ツールが正常に完了したことを示すため、クールダウン用のファイルを作成します。
    ```bash
    touch stats/cooldown/{toolId}
    ```
    **例:** `gemini.google.search` が成功した場合
    `touch stats/cooldown/gemini.google.search`

*   **クォータ超過 (`quota_exceeded`) の場合:**
    ツールのAPIクォータ制限に達したことを示すため、ロック用のファイルを作成します。
    ```bash
    touch stats/lock/{toolId}
    ```
    **例:** `gemini.google.search` でクォータエラーが発生した場合
    `touch stats/lock/gemini.google.search`

#### 2.2.2 MCPツールによる報告支援（補助的な手段）

上記の手動ファイル作成を簡略化するため、`report_tool_usage` MCPツールが提供されています。これはあくまで補助的な手段であり、利用できない場合は上記の手動操作を行ってください。

*   **ツール名:** `report_tool_usage`
*   **引数:**
    *   `toolId`: 使用したツールの一意なID (例: `gemini.google.search`)
    *   `status`: ツールの実行結果 (`success` または `quota_exceeded`)
*   **ツール呼び出し例:** `report_tool_usage({toolId: 'gemini.google.search', status: 'success'})`

## 3. ファイル操作制限の詳細

### 3.1 許可されるファイル操作
* `artifacts/{THEME_START_ID_テーマ名}/` 配下にマークダウンファイル等を作成・修正
  * ファイル名は `{ハートビートID}_filename.md` 形式で作成（例外: `context.md`, `histories/` 配下のファイル）
* `artifacts/theme_histories/` 配下にテーマ履歴ファイルを作成
* `projects/` 配下のプロジェクトファイルの作成・修正・削除
* `stats/` 配下にシステム状態ファイルを作成
* `themebox/` 配下の既存ファイルのリネーム（`processed.` プレフィックス付与）
* `feedbackbox/` 配下の既存ファイルのリネーム（`processed.` プレフィックス付与）

### 3.2 ファイル確認時の注意事項
* **.gitignore除外ディレクトリ**: themebox/, stats/, logs/の確認時は、.gitignore除外ディレクトリであることを考慮し、ツール使用時に必要に応じて除外を無視するようなオプションの使用を検討する

### 3.3 ファイル作成ルール
* **ファイル名**: 英語で作成
* **ファイル内容**: 日本語で記述（ユーザーリーダブル）
* **作成範囲**: 一回のハートビートで行う適切な範囲でファイルを作成・修正

### 3.4 projects/ 運用ルール
* **用途**: 新規開発・既存改善・技術実験・学習等のプロジェクト作業
* **プロジェクト管理**: 各プロジェクトは独立したgitリポジトリとして管理
* **配置ルール**: projects/ 直下にプロジェクト名でディレクトリ作成
* **命名規則**: プロジェクト名はユニークに設定
* **ファイル操作**: プロジェクト内のすべてのファイルの作成・修正・削除が許可
* **言語制限**: プロジェクトの性質に応じて適切な言語を使用（日本語・英語問わず）
* **作業範囲**: プロジェクトの開発・改善に必要な範囲での作業を実施

### 3.5 厳格な制限事項
**以下のファイル・ディレクトリの作成・編集は固く禁止：**

#### 禁止対象
* **プロジェクトルート直下のファイル**: GEMINI.md, README.md, setup.sh, heartbeat.sh, stop.sh, restart.sh等
* **ai-docs/ ディレクトリ配下**: 全てのファイル
* **themebox/ 配下への新規ファイル作成**: リネームのみ許可
* **システムファイル・設定ファイル**: .gitignore, LICENSE等
* **その他**: 上記許可範囲外の全てのファイル・ディレクトリ

#### 違反の影響
**違反した場合**: システムの安定性を損なう重大な問題となるため、絶対に遵守すること

## 4. エラーハンドリングの詳細手順

### 4.1 エラー発生時の対処手順
以下の順序で対処する：

1. **エラー記録**: エラー内容を活動ログに詳細に記録
2. **原因推定**: 可能な限り原因を分析（不明な場合は「原因不明」と記録）
3. **代替手段検討・実行**: 
   * Web検索エラー → 内部観測に切り替え
   * ファイル操作エラー → 活動種別変更
   * 重大なエラー → テーマ変更を検討
4. **継続判定**: 可能な限り回復・代替手段で次サイクルに進む

### 4.2 連続エラーと停止判定
* **連続エラー判定**: 同じエラーが4回連続で発生した場合は停止
* **自動停止**: 連続エラー検出時は自動停止を実行
* **停止記録**: 停止理由を活動ログとテーマ終了履歴に記録

### 4.3 重要原則
**エラーは失敗ではなく、適切な対処・継続ができれば正しい挙動**として扱う。

## 5. 活動ログ記録後の制限ルール詳細

### 5.1 軽微な修正期間
活動ログ記録後、ハートビート完了報告までの間は以下の軽微な修正のみ許可：

#### 許可される修正
* **活動ログファイル自体の修正**: 誤字、パス間違い等
* **直前に作成したファイルの軽微な修正**: 誤字、フォーマット調整等
* **技術的エラーの修正**: 絶対パス指定ミス等

### 5.2 禁止事項
軽微な修正期間中でも以下は厳格に禁止：

* **新たなタスクの開始**
* **大幅な内容変更や追加**
* **新規ファイルの作成**

### 5.3 厳格ルール
**ハートビート完了報告後は一切の追加作業を禁止**