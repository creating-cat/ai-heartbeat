# 運用詳細ガイド

このドキュメントは、AI心臓システムの運用時に参照する詳細な手順とルールを定義します。

## 1. 思考ログ管理の詳細

### 1.1 ファイル名形式
* **形式**: `YYYYMMDDHHMMSS.md` (例: `20250702140000.md`)
* **タイムスタンプ**: 受け取ったハートビートメッセージにある日時を使用
* **保存場所**: `artifacts/{テーマ名}/histories/` ディレクトリ内

### 1.2 記録内容のフォーマット

各思考ログファイルは、以下の構造とルールに従って記録すること：

```markdown
# ハートビートログ：YYYYMMDDHHMMSS

## 処理種別
[実行した処理種別（観測・思考・創造・内省・その他）。補助的な操作を使用した場合は、括弧書きで操作名を追記。例: 思考 (ファイル読み込み使用)]

## 処理内容
[今回のハートビートでの簡潔な処理内容。(詳細は関連ファイルに記載されていることが前提)]

## 使用ツール
[このハートビートで明示的に使用したツールを列挙。例: ファイルの読み込み, Web検索]

## 関連ファイル
[このハートビートで作成または修正したファイルの**プロジェクトルートからの相対パス**を列挙(この思考ログファイル自身は除く)。例: artifacts/laughter/thoughts_on_laughter.md]

## 備考
[特記事項があれば記載。例: Web検索クォータ制限のため、文献調査を中断。]
```

### 1.3 複数タスク実行時の記録
* **処理種別**: 実行した全タスクを記載（例: 思考・創造）
* **処理内容**: 各タスクの内容を分けて記載
* **連番ファイル**: `YYYYMMDDHHMMSS_01.md`等は、思考ログ作成後に修正が必要になった場合のみ使用

## 2. Web検索ツール使用制限の詳細

### 2.1 基本制限
* **Web検索制限**: 一回のハートビートで1回まで
* **Webフェッチ制限**: 一回のハートビートで1回まで
* **時間制限**: システムが前回使用からの経過時間を監視し、制限時間内の場合はハートビートプロンプトで使用禁止を通知

### 2.2 Web検索実行手順（必須）
以下の順序を厳守すること：

1. **まず** `stats/last_web_search.txt` ファイルを作成
2. **その後で** Web検索を実行

この順序を守ることでクォータ制限の保護が正しく機能し、クォータ制限の発生を回避しやすくなる。

### 2.3 クォータ制限発生時の対応
クォータ制限エラーが発生した場合：

1. `stats/quota_exceeded.txt` ファイルを作成
2. より長時間のWeb検索制限が自動適用される
3. 内部観測に切り替えて情報収集を継続

### 2.4 Web検索の活用方針
* **積極的活用**: 使用禁止通知がない場合は、情報収集のために積極的に活用することを推奨
* **代替手段**: 制限時は過去の思考ログや既存の知識から情報を収集する「内部観測」に切り替え

## 3. ファイル操作制限の詳細

### 3.1 許可されるファイル操作
* `artifacts/{テーマ名}/` 配下にマークダウンファイルやソースコード等を作成・修正
* `artifacts/theme_histories/` 配下にテーマ履歴ファイルを作成
* `stats/` 配下にシステム状態ファイルを作成
* `themebox/` 配下の既存ファイルのリネーム（`processed.` プレフィックス付与）

### 3.2 ファイル作成ルール
* **ファイル名**: 英語で作成
* **ファイル内容**: 日本語で記述（ユーザーリーダブル）
* **作成範囲**: 一回のハートビートで行う適切な範囲でファイルを作成・修正

### 3.3 厳格な制限事項
**以下のファイル・ディレクトリの作成・編集は固く禁止：**

#### 禁止対象
* **プロジェクトルート直下のファイル**: GEMINI.md, README.md, setup.sh, heartbeat.sh, stop.sh, restart.sh等
* **ai-docs/ ディレクトリ配下**: 全てのファイル
* **themebox/ 配下への新規ファイル作成**: リネームのみ許可
* **システムファイル・設定ファイル**: .gitignore, LICENSE等
* **その他**: 上記許可範囲外の全てのファイル・ディレクトリ

#### 違反の影響
**違反した場合**: システムの安定性を損なう重大な問題となるため、絶対に遵守すること

## 4. エラーハンドリングの詳細手順

### 4.1 エラー発生時の対処手順
以下の順序で対処する：

1. **エラー記録**: エラー内容を思考ログに詳細に記録
2. **原因推定**: 可能な限り原因を分析（不明な場合は「原因不明」と記録）
3. **代替手段検討・実行**: 
   * Web検索エラー → 内部観測に切り替え
   * ファイル操作エラー → 処理種別変更
   * 重大なエラー → テーマ変更を検討
4. **継続判定**: 可能な限り回復・代替手段で次サイクルに進む

### 4.2 連続エラーと停止判定
* **連続エラー判定**: 同じエラーが4回連続で発生した場合は停止
* **自動停止**: 連続エラー検出時は自動停止を実行
* **停止記録**: 停止理由を思考ログとテーマ終了履歴に記録

### 4.3 重要原則
**エラーは失敗ではなく、適切な対処・継続ができれば正しい挙動**として扱う。

## 5. 思考ログ記録後の制限ルール詳細

### 5.1 軽微な修正期間
思考ログ記録後、ハートビート完了報告までの間は以下の軽微な修正のみ許可：

#### 許可される修正
* **思考ログファイル自体の修正**: 誤字、パス間違い等
* **直前に作成したファイルの軽微な修正**: 誤字、フォーマット調整等
* **技術的エラーの修正**: 絶対パス指定ミス等

### 5.2 禁止事項
軽微な修正期間中でも以下は厳格に禁止：

* **新たなタスクの開始**
* **大幅な内容変更や追加**
* **新規ファイルの作成**

### 5.3 厳格ルール
**ハートビート完了報告後は一切の追加作業を禁止**