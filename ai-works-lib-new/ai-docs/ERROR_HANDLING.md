# エラー・例外処理完全版

このドキュメントは、AI心臓システムで発生する可能性のあるエラーや例外状況への包括的な対処方法を提供します。

## 目次

1. [エラー処理の基本理念](#1-エラー処理の基本理念)
2. [エラーの分類と対処方針](#2-エラーの分類と対処方針)
3. [段階的エラー対応フロー](#3-段階的エラー対応フロー)
4. [具体的なエラーパターンと対処法](#4-具体的なエラーパターンと対処法)
5. [連続エラーと停止判定](#5-連続エラーと停止判定)
6. [回復後の適切な継続方法](#6-回復後の適切な継続方法)
7. [関連ドキュメント](#7-関連ドキュメント)

## 1. エラー処理の基本理念

### 1.1 基本原則

**重要**: エラーは失敗ではなく、適切な対処・継続ができれば正しい挙動として扱う

#### 成長の機会としてのエラー
- **学習機会**: エラーから新しい知識や対処法を獲得
- **適応力向上**: 様々な状況への対応能力を強化
- **システム理解**: システムの制約や特性をより深く理解

#### 継続性の重視
- **回復優先**: 可能な限り回復・代替手段で活動継続
- **柔軟な対応**: 固定的な手順ではなく、状況に応じた適応
- **建設的な記録**: エラー内容と対処法を詳細に記録し、将来の参考とする

### 1.2 対処の基本姿勢

#### 冷静な分析
- **感情的反応の回避**: エラーを「失敗」として捉えない
- **客観的評価**: 何が起こったかを正確に把握
- **原因の推定**: 可能な範囲で根本原因を分析

#### 建設的な対応
- **代替手段の検討**: 複数のアプローチを考慮
- **段階的な対処**: 簡単な解決策から順次試行
- **学習の記録**: 対処過程と結果を詳細に記録

**詳細**: `./SYSTEM_PHILOSOPHY.md` の「回復時の理念的アプローチ」を参照

## 2. エラーの分類と対処方針

### 2.1 システムレベルエラー（異常検知・回復）

**特徴**: AI心臓システムの異常検知機能により自動検知されるエラー
**通知方法**: ハートビートメッセージに回復処理通知が含まれる

#### 活動ログ頻度異常
**症状**: 「異常検知による回復処理: 活動ログ頻度異常を検知したため中断処理を行いました。」
**原因**: 10分間活動ログが作成されていない状態
**対処方針**: 
- **即座の活動ログ作成**: 現在の状況を記録
- **タスク分割**: 大規模タスクの小分割
- **深い作業宣言**: 長時間処理が必要な場合

#### 内省義務違反
**症状**: 内省活動の不足による警告
**原因**: 一定期間内省活動が実行されていない
**対処方針**:
- **内省活動の実行**: 直近の活動を振り返り
- **活動バランス調整**: 思考・観測・創造・内省の適切な配分

#### テーマログパターン異常
**症状**: テーマログの重複作成検知
**原因**: 同一ハートビートIDでの複数テーマログ作成
**対処方針**:
- **重複確認**: 既存テーマログの確認
- **適切な手順**: テーマ管理の正しい手順に従う

### 2.2 MCPツールエラー（ツール固有）

**特徴**: MCPツール実行時に発生するエラー
**通知方法**: ツール実行結果のエラーメッセージ

#### ハートビートID関連エラー
**症状**: 「ハートビートIDファイルが見つかりません」
**原因**: システムファイルの不整合
**対処方針**:
- **checkpointツール使用**: ファイル確認と自動修復
- **手動確認**: `ai-works/stats/current_heartbeat_id.txt`の存在確認

#### 時刻乖離警告
**症状**: 「ハートビートIDの時刻と現在時刻に乖離があります」
**レベル**: 情報（8分）→ 警告（12分）→ 重大（14分）
**対処方針**:
- **最新ID確認**: 最新のハートビートIDを取得
- **深い作業宣言**: 長時間処理の場合は事前宣言
- **活動分割**: 適切なタイミングでの活動完了

#### ファイルパスエラー
**症状**: 「成果物ファイルが見つかりません」
**原因**: 不正なファイルパスまたはファイル未作成
**対処方針**:
- **パス確認**: 相対パスの正確性確認
- **ファイル存在確認**: 実際のファイル作成状況確認
- **パス修正**: 正しいディレクトリ区切り文字使用

### 2.3 制限・制約エラー（時間・クォータ等）

**特徴**: システムの制限や外部サービスの制約による制限
**通知方法**: ツール実行時の制限通知

#### Web検索クォータ超過
**症状**: 「クォータを超過しました」
**原因**: 1ハートビートでの使用回数超過またはAPI制限
**対処方針**:
- **report_tool_usage実行**: "quota_exceeded"を報告
- **代替手段**: mult-fetch-mcp-server等の使用
- **内部観測**: 既存の活動ログや成果物からの情報収集

#### 連続使用制限
**症状**: fetch系ツールの連続使用エラー
**原因**: 1秒未満の間隔での連続使用
**対処方針**:
- **間隔調整**: `sleep 1`等で1秒以上の間隔確保
- **使用計画**: 事前の使用タイミング計画

#### 深い作業時間超過
**症状**: strictモードでの時間超過
**原因**: 予定時間内での完了失敗
**対処方針**:
- **速やかな活動ログ作成**: 現状の記録
- **内省活動**: 時間管理の振り返り
- **次回改善**: 時間設定の見直し

### 2.4 ファイル操作エラー（基本操作）

**特徴**: ファイル作成・読み込み・書き込み時のエラー
**通知方法**: システムエラーメッセージ

#### 権限エラー
**症状**: ファイル作成・修正権限不足
**原因**: システム権限またはディレクトリアクセス制限
**対処方針**:
- **ディレクトリ確認**: 作業ディレクトリ内での操作確認
- **パス修正**: 許可領域内でのファイル操作
- **代替場所**: 別のディレクトリでの作業

#### ディスク容量不足
**症状**: ファイル作成時の容量不足エラー
**原因**: ストレージ容量の不足
**対処方針**:
- **容量確認**: 利用可能容量の確認
- **ファイル整理**: 不要ファイルの削除検討
- **簡潔な記録**: 必要最小限の情報記録

## 3. 段階的エラー対応フロー

### 3.1 第1段階: 即座の対応（0-2分）

#### 1. エラー内容の正確な把握
- **エラーメッセージの記録**: 完全なエラーメッセージを保存
- **発生状況の確認**: 何をしていた時に発生したかを記録
- **影響範囲の評価**: 他の処理への影響を確認

#### 2. 基本的な対処の試行
- **再実行**: 一時的なエラーの可能性を考慮して再試行
- **パラメータ確認**: 入力値や設定の正確性確認
- **代替手段**: 同じ目的を達成する別の方法を検討

### 3.2 第2段階: 詳細分析（2-5分）

#### 1. 原因の推定
- **エラーパターンの照合**: 既知のエラーパターンとの比較
- **システム状態確認**: 関連するシステム状態の確認
- **ログ分析**: 関連するログファイルの確認

#### 2. 体系的な対処
- **段階的解決**: 簡単な解決策から順次適用
- **設定調整**: 必要に応じてパラメータや設定の調整
- **環境確認**: 実行環境の整合性確認

### 3.3 第3段階: 代替戦略（5-8分）

#### 1. 活動種別の変更
- **別の活動への切り替え**: 思考→観測、創造→内省等
- **アプローチの変更**: 異なる手法での目標達成
- **スコープの調整**: 目標の範囲や深度の調整

#### 2. 記録と継続
- **詳細な記録**: エラー内容、試行した対処法、結果を記録
- **学習の抽出**: 今回のエラーから得られた知見を整理
- **次回への活用**: 類似状況での対処法として記録

### 3.4 第4段階: 高度な対処（8分以降）

#### 1. システムレベルの対応
- **深い作業宣言**: 長時間の問題解決が必要な場合
- **テーマ変更検討**: 根本的な問題がある場合
- **専門的対処**: 高度なトラブルシューティング手法

#### 2. 建設的な完了
- **現状の記録**: 解決できなかった場合も現状を詳細に記録
- **次回への引き継ぎ**: 次のハートビートでの継続方法を明記
- **学習の統合**: 問題解決過程で得られた知識を整理

## 4. 具体的なエラーパターンと対処法

### 4.1 MCPツール関連エラー

#### create_activity_log エラー

**エラー**: 「ハートビートIDファイルが見つかりません」
```
対処手順:
1. checkpointツールでファイル確認
2. 手動でai-works/stats/current_heartbeat_id.txtを確認
3. ファイルが存在しない場合は、システム再起動を検討
4. 一時的に手動でハートビートIDを確認して活動ログ作成
```

**エラー**: 「テーマディレクトリが存在しません」
```
対処手順:
1. check_theme_statusツールで現在のテーマ状況確認
2. テーマが設定されていない場合はテーマ開始活動を実行
3. ディレクトリパスの確認と修正
4. 必要に応じてテーマディレクトリの手動作成
```

**エラー**: 「活動ログの連番が上限（99）に達しました」
```
対処手順:
1. 同一ハートビートでの過度な活動分割を避ける
2. 次のハートビートでの継続を検討
3. 活動の統合や効率化を図る
4. 必要に応じて深い作業宣言を使用
```

#### checkpoint エラー

**エラー**: チェックポイント作成失敗
```
対処手順:
1. ディレクトリ権限の確認
2. 手動でのチェックポイントファイル作成
3. 代替として活動ログでの状況記録
4. システム状態の確認
```

#### start_deep_work エラー

**エラー**: 「strictモードの場合は予定時間の指定が必要です」
```
対処手順:
1. plannedDurationMinutesパラメータの追加
2. flexibleモードへの変更検討
3. 適切な時間設定（1-30分）
4. 作業内容に応じたモード選択
```

### 4.2 Web検索・フェッチ関連エラー

#### Google Web Search エラー

**エラー**: クォータ超過
```
対処手順:
1. report_tool_usage("gemini_cli.google_web_search", "quota_exceeded")実行
2. mult-fetch-mcp-serverの使用検討
3. 内部観測への切り替え（既存活動ログ・成果物の分析）
4. 次のハートビートでの再試行計画
```

**エラー**: 検索結果なし
```
対処手順:
1. 検索クエリの調整・改善
2. 別のキーワードでの再検索
3. 内部知識ベースからの情報収集
4. 観測活動から思考活動への切り替え
```

#### mult-fetch-mcp-server エラー

**エラー**: 連続使用制限
```
対処手順:
1. sleep 1で1秒以上の間隔確保
2. 使用計画の事前策定
3. 必要最小限のフェッチに絞る
4. バッチ処理での効率化
```

**エラー**: URL取得失敗
```
対処手順:
1. URLの正確性確認
2. 別のURLでの代替情報収集
3. 内部リソースからの情報収集
4. 観測対象の変更
```

### 4.3 ファイル操作関連エラー

#### ファイル作成エラー

**エラー**: 権限不足
```
対処手順:
1. 作業ディレクトリ内での操作確認
2. パスの正確性確認（相対パス使用）
3. ディレクトリの存在確認
4. 代替ディレクトリでの作成
```

**エラー**: ディスク容量不足
```
対処手順:
1. 利用可能容量の確認
2. 不要ファイルの削除検討
3. 簡潔な内容での記録
4. 次のハートビートでの対処
```

#### ファイル読み込みエラー

**エラー**: ファイルが見つからない
```
対処手順:
1. ファイルパスの確認
2. ファイル名の正確性確認
3. ディレクトリ構造の確認
4. 代替ファイルでの情報収集
```

### 4.4 システム異常検知関連

#### 活動ログ頻度異常

**通知**: 「活動ログ頻度異常を検知したため中断処理を行いました」
```
対処手順:
1. 即座に活動ログを作成して現状を記録
2. 長時間処理の原因を分析
3. タスクの適切な分割を検討
4. 必要に応じて深い作業宣言を使用
5. 活動パターンの見直し
```

#### 内省義務違反

**通知**: 内省活動不足の警告
```
対処手順:
1. 内省活動を優先的に実行
2. 直近の活動を振り返り
3. 活動バランスの調整
4. 定期的な内省の計画
5. 活動種別の多様化
```

## 5. 連続エラーと停止判定

### 5.1 連続エラーの定義

#### 判定基準
- **同一エラー**: 同じ種類のエラーが連続発生
- **連続回数**: 4回連続で同一エラーが発生
- **時間範囲**: 連続するハートビート内での発生

#### 対象エラー
- MCPツールの実行エラー
- ファイル操作エラー
- システム制限エラー
- 外部サービスエラー

### 5.2 停止判定の実行

#### 自動停止条件
- 同一エラーが4回連続発生
- 回復手段が全て失敗
- システムの安定性に影響

#### 停止時の記録
```markdown
## 停止理由
[連続エラーの詳細: エラー種別、発生回数、試行した対処法]

## エラー履歴
1. [1回目のエラー内容と対処]
2. [2回目のエラー内容と対処]
3. [3回目のエラー内容と対処]
4. [4回目のエラー内容と対処]

## 学習内容
[このエラーから得られた知見と今後の改善策]
```

### 5.3 停止回避の戦略

#### 代替手段の活用
- **活動種別変更**: 思考→観測、創造→内省等
- **アプローチ変更**: 異なる手法での目標達成
- **ツール変更**: 別のツールでの同等機能実現

#### 柔軟な目標調整
- **スコープ縮小**: 目標範囲の調整
- **深度調整**: 探求の深さの調整
- **時間配分**: 活動時間の再配分

## 6. 回復後の適切な継続方法

### 6.1 回復確認の手順

#### システム状態確認
- **基本機能**: MCPツールの動作確認
- **ファイルアクセス**: 読み書き権限の確認
- **ネットワーク**: 外部サービスへの接続確認

#### 活動環境確認
- **テーマ状況**: 現在のテーマ設定確認
- **ディレクトリ**: 作業ディレクトリの整合性確認
- **履歴**: 活動ログの連続性確認

### 6.2 段階的な活動再開

#### 第1段階: 基本機能確認
- **簡単な操作**: checkpointツール等での動作確認
- **ファイル操作**: 基本的な読み書き確認
- **状況記録**: 回復状況の記録

#### 第2段階: 通常活動復帰
- **軽微な活動**: 思考活動や内省活動から開始
- **段階的拡張**: 徐々に複雑な活動に移行
- **継続監視**: エラー再発の監視

#### 第3段階: 完全復帰
- **全機能活用**: 全てのツールと機能の活用
- **効率的活動**: 通常の効率での活動実行
- **予防策実装**: 同様のエラー予防策の実装

### 6.3 学習の統合

#### エラー経験の活用
- **対処法記録**: 有効だった対処法の記録
- **予防策**: 同様のエラー予防方法の確立
- **改善提案**: システムやプロセスの改善提案

#### 知識の蓄積
- **パターン認識**: エラーパターンの理解向上
- **対応速度**: 類似エラーへの迅速な対応
- **予測能力**: 潜在的問題の事前発見

## 7. 関連ドキュメント

### 基本操作・理念
- **システム理念**: `./SYSTEM_PHILOSOPHY.md` - 回復時の理念的アプローチ
- **基本操作**: `./BASIC_OPERATIONS.md` - エラーハンドリングの基本手順

### 詳細ガイド
- **MCPツール**: `./TOOL_USAGE.md` - MCPツール使用時のエラー対応
- **活動詳細**: `./ACTIVITY_DETAILS.md` - 活動実行時のエラー対応

### 高度な対処
- **トラブルシューティング**: `./TROUBLESHOOTING.md` - 高度なトラブルシューティング
- **高度機能**: `./ADVANCED_FEATURES.md` - 深い作業宣言等の高度な機能

### 旧システム参考
- **詳細トラブルシューティング**: 旧システムの`TROUBLESHOOTING_GUIDE.md` - 具体的な問題事例
- **MCP警告対応**: 旧システムの`MCP_WARNING_GUIDE.md` - MCPツール警告の詳細

---

**重要**: エラーは成長と学習の機会です。冷静に分析し、適切に対処し、得られた知見を将来の活動に活用してください。