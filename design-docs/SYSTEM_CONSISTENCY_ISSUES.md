# システム一貫性問題調査結果

## 概要

AI心臓システムの各種ドキュメント（GEMINI.md、ai-docs配下、heartbeat.sh、MCPツール）間で発見された統一感のない指示や説明の詳細調査結果。

調査日: 2025年1月20日
調査範囲: システム全体のドキュメントとコード

## 発見された問題一覧

### 1. 連続活動の許可 vs 連番ID警告の矛盾

**問題の重要度**: 🔴 高（日常運用に直接影響）

**矛盾の詳細**:
- **許可側の記述**:
  - `GEMINI.md`: 「自然な思考フロー」として観測→思考→創造の連続処理を明示的に許可
  - `GUIDELINES.md`: 「論理的に連続した処理は一つのハートビート内で実行可能」と明記
  - 「時間ベース制御による適切なリズム」を重視し、連続処理を推奨

- **警告側の記述**:
  - `MCP_WARNING_GUIDE.md`: 連番IDファイル作成を「問題行動」として警告
  - `activityLogTool.ts`: 連番ファイル作成時に警告メッセージを表示
  - 「活動ログ作成後にタスクを終了せず処理をしてしまっていた場合があったか」として否定的に扱う

**具体的な影響**:
- AIエージェントが「自然な思考フロー」で複数活動を実行すると、MCPツールから警告を受ける
- システムが推奨する動作パターンに対して、ツールが否定的なフィードバックを与える矛盾
- エージェントの判断に混乱を生じさせ、適切な活動パターンの学習を阻害

**関連ファイル**:
- `GEMINI.md` (3.2節)
- `ai-docs/GUIDELINES.md` (1.2節、2.1節)
- `ai-docs/MCP_WARNING_GUIDE.md` (重複ハートビートID警告)
- `mcp/ai-heartbeat-mcp/src/tools/activityLogTool.ts`

### 2. 時間制御の基準が複数存在

**問題の重要度**: 🔴 高（システム動作の根幹に関わる）

**矛盾の詳細**:
- **heartbeat.sh の基準**:
  - 5分: 警告レベル (INACTIVITY_WARNING_THRESHOLD=300)
  - 10分: エラーレベル (INACTIVITY_STOP_THRESHOLD=600)
  - 15分: タイムスタンプ異常検知 (TIMESTAMP_ANOMALY_THRESHOLD=900)

- **activityLogTool.ts の基準**:
  - 5分: 情報通知 (infoThreshold: 300)
  - 10分: 警告 (warningThreshold: 600)
  - 15分: エラー (errorThreshold: 900)

- **declareExtendedProcessingTool.ts の基準**:
  - 最大30分まで宣言可能 (max: 30)

**具体的な影響**:
- heartbeat.shでは10分でエラーレベルなのに、MCPツールでは15分でエラー
- 長時間処理宣言は30分まで可能だが、基本的な異常検知との整合性が不明確
- 異なるコンポーネントが異なる時間基準で動作し、予期しない動作を引き起こす可能性

**関連ファイル**:
- `heartbeat.sh` (check_agent_health関数)
- `mcp/ai-heartbeat-mcp/src/tools/activityLogTool.ts` (PROCESSING_TIME_CONFIG)
- `mcp/ai-heartbeat-mcp/src/tools/declareExtendedProcessingTool.ts`
- `heartbeat.conf` (設定値定義)

### 3. 活動ログ作成後の制限ルールの曖昧さ

**問題の重要度**: 🟡 中（運用時の判断に影響）

**矛盾の詳細**:
- **GEMINI.md**: 「活動ログ記録後は軽微な修正のみ許可、完了報告後は一切の追加作業禁止」
- **OPERATION_DETAILS.md**: 「軽微な修正期間」として以下を定義
  - 活動ログファイル自体の修正: 誤字、パス間違い等
  - 直前に作成したファイルの軽微な修正: 誤字、フォーマット調整等
  - 技術的エラーの修正: 絶対パス指定ミス等

**具体的な影響**:
- 「軽微な修正」の具体的な範囲が主観的で、実際の運用で混乱を招く
- どこまでが「軽微」でどこからが「追加作業」なのかの境界が不明確
- エージェントが適切な判断を下せない可能性

**関連ファイル**:
- `GEMINI.md` (3.4節)
- `ai-docs/OPERATION_DETAILS.md` (5節)

### 4. テーマ終了判断基準の重複と矛盾

**問題の重要度**: 🟡 中（テーマ管理の一貫性に影響）

**矛盾の詳細**:
- **GEMINI.md の基準**:
  - 活動の多様性（思考・観測・創造・内省のバランス）
  - 探求の深化（十分な考察と成果物）
  - 発展性の評価（新たな問いや創造の余地）
  - サマリーの作成（活動全体の要約）

- **THEME_MANAGEMENT_GUIDE.md の基準**:
  - より詳細なチェックリスト形式
  - MCPツールによる客観的評価の追加
  - 最終確認サイクルの明示

**具体的な影響**:
- 同じ判断基準が複数箇所に記載され、微妙に表現や重点が異なる
- どちらを優先すべきかが不明確
- 判断基準の更新時に複数箇所の同期が必要

**関連ファイル**:
- `GEMINI.md` (9.1節)
- `ai-docs/THEME_MANAGEMENT_GUIDE.md` (5.1節)

### 5. MCPツール使用の位置づけの不一致

**問題の重要度**: 🟡 中（ツール活用方針に影響）

**矛盾の詳細**:
- **補助手段としての記述**:
  - 「MCPツールは補助手段であり、手動実行も常に可能」
  - 「MCPツールが利用できない場合の代替手順」を重視

- **積極活用としての記述**:
  - 「MCPツール支援」として積極的な活用を推奨
  - 「効率的な処理」「エラー防止」の観点から優先使用を推奨

**具体的な影響**:
- ツール使用の優先度が不明確
- 手動実行 vs MCPツール使用の判断基準が一貫していない
- エージェントがツール選択時に迷いを生じる可能性

**関連ファイル**:
- 複数のai-docsファイル全般
- `ai-docs/THEME_MANAGEMENT_GUIDE.md` (7節)

### 6. feedbackbox処理の緊急性レベルの混乱

**問題の重要度**: 🟡 中（ユーザーフィードバック対応に影響）

**矛盾の詳細**:
- **heartbeat.sh**: 緊急フィードバック検知時に即座に処理中断
  ```bash
  if [ "$EMERGENCY_FEEDBACK_DETECTED" = true ]; then
      interrupt_agent
  ```

- **GEMINI.md**: 「内省時に確認・対応」として通常処理扱い
  - 「内省活動時に必ずfeedbackboxをチェック」

**具体的な影響**:
- 緊急フィードバックの処理タイミングが不明確
- システムレベルでは即座中断、ドキュメントレベルでは通常処理
- 緊急度の判定基準と対応レベルが統一されていない

**関連ファイル**:
- `heartbeat.sh` (check_feedbackbox関数)
- `GEMINI.md` (10節)

### 7. ファイル操作制限の表現の不統一

**問題の重要度**: 🟢 低（表現の統一性の問題）

**矛盾の詳細**:
- **強度の異なる表現**:
  - 「固く禁止」
  - 「厳格な制限事項」
  - 「絶対に遵守」
  - 「重大な問題となるため、絶対に遵守すること」

**具体的な影響**:
- 同じ制限に対して異なる強度の表現が使用されている
- 制限の重要度レベルが文書間で統一されていない
- 読み手に与える印象が一貫していない

**関連ファイル**:
- `ai-docs/OPERATION_DETAILS.md` (3.5節)
- その他複数のドキュメント

## 影響度評価

### 高影響度（🔴）
1. 連続活動の許可 vs 連番ID警告の矛盾
2. 時間制御の基準が複数存在

これらは日常的な運用に直接影響し、システムの安定性や一貫性を損なう可能性が高い。

### 中影響度（🟡）
3. 活動ログ作成後の制限ルールの曖昧さ
4. テーマ終了判断基準の重複と矛盾
5. MCPツール使用の位置づけの不一致
6. feedbackbox処理の緊急性レベルの混乱

運用時の判断に影響を与えるが、システム全体の動作には致命的ではない。

### 低影響度（🟢）
7. ファイル操作制限の表現の不統一

主に表現の統一性の問題で、機能的な影響は限定的。

## 推奨対応順序

1. **時間制御基準の統一**（最優先）
2. **連続活動ポリシーの明確化**
3. **テーマ終了判断基準の統合**
4. **MCPツール使用方針の統一**
5. **feedbackbox処理レベルの明確化**
6. **活動ログ制限ルールの具体化**
7. **表現の統一**

## 次のステップ

各問題に対する具体的な修正案の検討と、システム全体の一貫性を保つための統一方針の策定が必要。