# サブテーマ機能 設計ノート

## 概要

AI心臓システムにサブテーマ機能を追加する設計案についてのディスカッション記録と設計方針をまとめたドキュメント。

## 背景・課題

### 現状の問題
- ボリュームの大きいテーマが与えられた場合、自然な分割処理が不十分
- 明示的なサブテーマ概念が存在しない
- 大きなテーマの進捗管理や完了判定が困難
- ステップ間の関連性が不明確

### 現状で自然分割される要因
- 「一回一歩」の原則による小分け傾向
- ハートビート制約による物理的な分割必要性
- 段階的深化の概念（表面から深層へ）
- 継続性重視の設計思想

## 提案されたサブテーマ機能

### 基本コンセプト
- テーマディレクトリ内に`subthemes`ディレクトリを作成
- サブテーマごとに`{THEME_START_ID}_{subtheme_name}`形式のディレクトリ
- サブテーマ完了後は元のメインテーマに戻る

### ディレクトリ構造案
```
artifacts/
├── 20250115143000_ai_research/              # メインテーマ
│   ├── histories/                           # メインテーマの活動ログ
│   ├── context.md                          # テーマ専門家コンテキスト
│   ├── subthemes/                          # サブテーマコンテナ
│   │   ├── 20250115150000_neural_networks/ # サブテーマ1
│   │   │   ├── histories/                  # サブテーマ1の活動ログ
│   │   │   └── context.md                  # サブテーマ専門家コンテキスト
│   │   └── 20250115160000_ethics/          # サブテーマ2
│   │       ├── histories/
│   │       └── context.md
│   └── [その他のメインテーマファイル]
```

### 作業フロー
1. 大きなテーマ開始
2. テーマをサブテーマに分割
3. 各サブテーマで集中作業
4. サブテーマ完了時に成果をメインテーマに統合
5. 必要に応じて次のサブテーマへ
6. 全サブテーマ完了後、メインテーマ終了

## theme_histories管理方針

### 基本方針
- **統一的な管理**: メインテーマ・サブテーマ関係なく同じ形式で作成
- **親テーマ情報の追加**: サブテーマの場合のみ親テーマ情報を記録

### ファイル名形式
- 現在と同じ形式を維持: `{START_ID}_start_{theme_name}.md`
- サブテーマ識別子は追加しない（内容で判別）

### サブテーマ履歴ファイルの内容例

#### サブテーマ開始時
```markdown
# サブテーマ開始: ニューラルネットワークの基礎理解

**PARENT_THEME_START_ID**: 20250115143000
**PARENT_THEME_NAME**: AI研究の基礎
**SUBTHEME_START_ID**: 20250115150000
**テーマディレクトリ**: `artifacts/20250115143000_ai_research/subthemes/20250115150000_neural_networks/`

**開始理由**:
親テーマ「AI研究の基礎」の一部として、ニューラルネットワークに特化した深い理解を得るため

**活動内容**:
- 基本的なパーセプトロンの理解
- 多層ニューラルネットワークの仕組み
```

#### サブテーマ終了時
```markdown
# サブテーマ終了: ニューラルネットワークの基礎理解

**PARENT_THEME_START_ID**: 20250115143000
**PARENT_THEME_NAME**: AI研究の基礎
**SUBTHEME_START_ID**: 20250115150000
**SUBTHEME_END_ID**: 20250115155000
**テーマディレクトリ**: `artifacts/20250115143000_ai_research/subthemes/20250115150000_neural_networks/`

**終了理由**:
ニューラルネットワークの基礎的な理解が完了し、次のサブテーマ「倫理」に移行するため

**主な成果**:
- neural_networks_summary.md の作成
- 基本概念の整理完了
- 次のサブテーマへの橋渡し情報を記録
```

## 設計上の考慮事項

### 1. ネストの深さ制限
- **推奨**: 1階層のみ（サブテーマの中にサブテーマは作らない）
- **理由**: 複雑性の回避、管理の簡素化

### 2. サブテーマの終了判定
- サブテーマ完了時の成果をメインテーマにどう反映するか
- サブテーマの成果物の参照方法の確立

### 3. MCPツールの拡張必要箇所
- `create_theme_log`: サブテーマ対応（parentThemeStartIdパラメータ追加）
- `check_theme_status`: サブテーマ状況も表示
- `list_theme_artifacts`: サブテーマ成果物も含める
- `create_activity_log`: サブテーマディレクトリ対応

### 4. 活動ログの管理
- サブテーマ中の活動ログはサブテーマの`histories/`に記録
- メインテーマとサブテーマの関連性を活動ログに記録

## 実装の利点

### 1. 既存構造との親和性
- 現在の `{THEME_START_ID}_{theme_name}` パターンを踏襲
- ディレクトリベースの管理で一貫性を保持
- MCPツールの拡張で対応可能

### 2. 階層的な思考管理
- 大きなテーマの構造化された探求が可能
- AIの思考がより体系的になる

### 3. トレーサビリティ
- サブテーマから親テーマへの参照が明確
- 全体のテーマ履歴を時系列で追跡可能

## ID管理方式の検討

### 案1: 新しいSUBTHEME_START_IDを導入
```
メインテーマ: THEME_START_ID = 20250115143000
サブテーマ1: THEME_START_ID = 20250115143000, SUBTHEME_START_ID = 20250115150000
サブテーマ2: THEME_START_ID = 20250115143000, SUBTHEME_START_ID = 20250115160000
```

**利点:**
- 概念的に明確（メインテーマとサブテーマの区別が明示的）
- サブテーマ固有のIDで管理が独立
- 将来的な拡張（サブサブテーマ等）に対応しやすい

**欠点:**
- 新しい概念の導入でシステムが複雑化
- 既存のMCPツールの大幅な変更が必要
- IDの管理が二重になる

### 案2: 既存構造にPARENT_THEME_START_IDを追加
```
メインテーマ: THEME_START_ID = 20250115143000, PARENT_THEME_START_ID = null
サブテーマ1: THEME_START_ID = 20250115150000, PARENT_THEME_START_ID = 20250115143000
サブテーマ2: THEME_START_ID = 20250115160000, PARENT_THEME_START_ID = 20250115143000
```

**利点:**
- 既存のTHEME_START_ID概念をそのまま活用
- MCPツールの変更が最小限
- 統一的なID管理（すべてのテーマが同じ形式）
- シンプルで理解しやすい

**欠点:**
- サブテーマも独立したTHEME_START_IDを持つため、概念的に少し混乱する可能性
- ルートテーマとサブテーマの区別が間接的

## 次のステップ

1. ID管理方式の決定
2. MCPツールの拡張仕様の詳細化
3. サブテーマ作成・管理のルール策定
4. 既存ドキュメント（THEME_MANAGEMENT_GUIDE.md等）の更新
5. 実装とテスト

## 決定事項

### ID管理方式
**採用**: 案2 - 既存構造にPARENT_THEME_START_IDを追加

```
メインテーマ: THEME_START_ID = 20250115143000, PARENT_THEME_START_ID = null
サブテーマ1: THEME_START_ID = 20250115150000, PARENT_THEME_START_ID = 20250115143000
サブテーマ2: THEME_START_ID = 20250115160000, PARENT_THEME_START_ID = 20250115143000
```

**決定理由**:
- 既存のTHEME_START_ID概念をそのまま活用
- MCPツールの変更が最小限
- 統一的なID管理（すべてのテーマが同じ形式）
- シンプルで理解しやすい

### 活動種別の統合
**採用**: 既存のテーマ開始・終了活動を拡張（新しい活動種別は作らない）

**決定理由**:
- 概念の統一性（メインテーマもサブテーマも本質的に同じ「テーマ開始/終了」）
- 実装の簡潔性（MCPツールの変更が最小限）
- 学習コストの低さ（既存の知識をそのまま活用）

### themeboxとの統合アプローチ
**採用**: 条件分岐による自然な統合

#### テーマ開始活動の判定フロー
```
1. 現在テーマが存在するか？
   - No → 新規テーマ開始（themebox優先 → 自律的決定）
   - Yes → サブテーマ開始を検討

2. 新規テーマ開始の場合：
   - 🥇 第1優先: themeboxからの自動選択
   - 🥈 第2優先: 自律的な新テーマ決定

3. サブテーマ開始の場合：
   - 現在テーマの分析・分割判定
   - 適切なサブテーマの設計・開始
```

#### 利点
- 自然な判定（AIが状況に応じて自動判定）
- 既存ルールの保持（themeboxの優先順位は変更なし）
- 概念の統一（「テーマ開始」という活動種別を維持）
- 実装の簡潔性（複雑な分岐ロジックが不要）

## テーマ終了活動の統合

### サブテーマ終了の特殊性
1. **終了後の行き先**: 
   - ルートテーマ終了 → 新しいテーマ開始
   - サブテーマ終了 → **親テーマに戻る**

2. **成果の扱い**:
   - ルートテーマ終了 → 完全に独立した成果
   - サブテーマ終了 → **親テーマへの統合が必要**

### 採用方針
**採用**: 既存のテーマ終了活動を拡張

**決定理由**:
- 概念の統一性（「探求を終える」という本質は同じ）
- 実装の簡潔性（MCPツールの変更が最小限）
- 柔軟性（親テーマへの統合情報を追加可能）

### 終了後のフロー
- **ルートテーマ終了後**: テーマ終了 → 新しいテーマ開始（themebox優先 → 自律的決定）
- **サブテーマ終了後**: サブテーマ終了 → 親テーマに戻る → 次のサブテーマ or 親テーマ終了

## サブテーマ判定・活用指針

### 内省時のサブテーマ判定
**採用**: 内省活動時にサブテーマ分割の必要性を判定する仕組みを導入

#### 判定の利点
1. **自然な振り返りタイミング**: 内省は活動を客観視する最適なタイミング
2. **継続性の維持**: 思考や創造の途中で分割判定すると流れが断絶するが、内省なら自然
3. **客観的な判断**: 活動中は集中しているため分割の必要性に気づきにくいが、内省時なら冷静に俯瞰可能

#### 判定基準（内省時に確認）
- **散漫性**: 最近の活動が散漫で焦点が定まらない
- **複雑性**: テーマに複数の独立した要素が混在している
- **深度不足**: 表面的な活動が続いている
- **進捗停滞**: 同じような内容の繰り返しになっている
- **規模感**: 全体を把握するのが困難なほど大きい

### サブテーマ活用ケース
1. **複合的テーマの分割**
   - 例: "AI技術の現在と未来" → "機械学習の現状"、"倫理的課題"、"社会への影響"

2. **段階的深化**
   - 例: "プログラミング学習" → "基礎文法"、"実践プロジェクト"、"応用技術"

3. **専門領域の集中探求**
   - 例: "文学研究" → "特定作家の分析"、"時代背景の調査"、"文体の研究"

### 記載場所と内容

#### GEMINI.md への追加
- **場所**: `0.1 テーマの概念` および `3.3 内省処理の詳細`
- **内容**: サブテーマの基本概念と内省時の判定指針

#### ai-docs/GUIDELINES.md への追加
- **場所**: `5.1 内省処理での自己点検項目` に追加
- **内容**: サブテーマ判定を内省の標準項目として追加

#### ai-docs/THEME_MANAGEMENT_GUIDE.md への追加
- **場所**: `2.1 テーマ開始活動の実行タイミング` に追加
- **内容**: サブテーマ開始の判断基準と手順

#### ai-docs/THEME_CONCEPT_GUIDE.md への追加
- **場所**: 新セクション `1.3 サブテーマの概念と活用`
- **内容**: 詳細な概念説明と活用例

## 実装仕様

### MCPツール拡張

#### create_theme_log の拡張
```typescript
export const themeLogInputSchema = z.object({
  action: z.enum(['start', 'end']),
  themeStartId: z.string().regex(/^\d{14}$/),
  themeEndId: z.string().optional(),
  themeName: z.string(),
  themeDirectoryPart: z.string(),
  reason: z.string(),
  // 新規追加
  parentThemeStartId: z.string().optional()
    .describe('サブテーマの場合、親テーマのTHEME_START_IDを指定。nullの場合はルートテーマ'),
  // サブテーマ終了時の追加情報
  integrationNotes: z.string().optional()
    .describe('サブテーマ終了時、親テーマへの統合に関する情報'),
  // 既存フィールドはそのまま
  achievements: z.array(z.string()).optional(),
  activityContent: z.array(z.string()).optional(),
});
```

#### 判定ロジック
```typescript
const isSubtheme = !!args.parentThemeStartId;
const themeType = isSubtheme ? "サブテーマ" : "テーマ";
const actionType = args.action === 'start' ? '開始' : '終了';
const title = `${themeType}${actionType}: ${args.themeName}`;

// サブテーマ終了時の特別処理
if (isSubtheme && args.action === 'end' && args.integrationNotes) {
  // 親テーマへの統合情報を追加
}
```

### 活動ログ記録例

#### サブテーマ開始時
```markdown
## 活動種別
テーマ開始

## 活動内容
- 現在のテーマ「AI研究の基礎」が大きいため、サブテーマに分割
- サブテーマ「ニューラルネットワークの基礎理解」を開始
- 親テーマとの関連性を維持しながら専門的に探求
- テーマディレクトリとhistoriesディレクトリを作成
```

### 内省時の活動ログ例（サブテーマ判定）

#### サブテーマ分割を決定した場合
```markdown
## 活動種別
内省

## 活動内容
- 最近5回のハートビートを振り返り
- テーマ「AI技術の現在と未来」の進捗を評価
- 機械学習、倫理、社会影響の3つの要素が混在していることを確認
- **サブテーマ分割を決定**: 次回ハートビートで「機械学習の現状」サブテーマを開始

## 自己評価、備考
現在のテーマが大きすぎて焦点が散漫になっている。サブテーマ分割により、より深い探求が可能になると判断。
```

### theme_histories ファイル例

#### サブテーマ開始時
```markdown
# サブテーマ開始: ニューラルネットワークの基礎理解

**PARENT_THEME_START_ID**: 20250115143000
**PARENT_THEME_NAME**: AI研究の基礎
**THEME_START_ID**: 20250115150000
**テーマディレクトリ**: `artifacts/20250115143000_ai_research/subthemes/20250115150000_neural_networks/`

**開始理由**:
親テーマ「AI研究の基礎」の一部として、ニューラルネットワークに特化した深い理解を得るため

**活動内容**:
- 基本的なパーセプトロンの理解
- 多層ニューラルネットワークの仕組み
```

## サブテーマの自律性設計方針

### 「知っているが意識しない」アプローチの採用

**決定日**: 2025-01-XX  
**決定内容**: サブテーマは親テーマとの関係を技術的に管理するが、AIの思考レベルでは自律的に動作する設計を採用

#### 基本思想
- **技術的管理**: システムレベルで親子関係を完全に把握・管理
- **思考的自律**: AIは親テーマを意識せずサブテーマに完全集中
- **後統合**: サブテーマ終了時に親テーマとの関連を整理・統合

#### 具体的な実装方針

##### 1. 専門家コンテキストの設計
```markdown
# テーマ専門家コンテキスト
<!-- 親テーマ情報は表示しない -->

## 専門家設定
**ニューラルネットワーク専門家**

## 専門性・役割
- パーセプトロンの基本原理の理解
- 多層ニューラルネットワークの構造分析
```

**採用理由**:
- サブテーマに完全集中できる
- 創造性が親テーマに制限されない
- メインテーマと同じ体験で一貫性を保持

##### 2. 情報管理の分離
- **AIが見る情報**: 親テーマ情報を含まない純粋なサブテーマコンテキスト
- **システムが管理する情報**: `subtheme_metadata.json`で親子関係を完全管理
- **統合時の情報**: `integrationNotes`で親テーマとの関連を明示

##### 3. パラメータの簡素化
**削除する複雑な機能**:
- `inheritFromParent`: 自動継承ではなく、必要に応じて手動で設定
- `subthemeSpecialization`: 既存の`expertRole`や`expertPerspective`で表現
- 親テーマコンテキストの自動継承機能

**保持する最小限の機能**:
- `parentThemeStartId`, `parentThemeDirectoryPart`: 技術的な親子関係管理のみ

#### 利点
1. **集中力の確保**: サブテーマに完全集中した深い探求
2. **創造性の維持**: 親テーマに縛られない自由な発想
3. **システムの一貫性**: メインテーマと同じ操作感
4. **実装の簡素化**: 複雑な継承ロジックが不要
5. **柔軟な統合**: 終了時に最適な形で親テーマと統合

#### 実装上の注意点
- 専門家コンテキストファイルには親テーマ情報を表示しない
- `check_theme_status`ツールでのみ階層構造を表示
- サブテーマ終了時の`integrationNotes`で親テーマとの関連を整理
- メタデータファイルで技術的な親子関係を確実に管理

## 議論履歴

- **2025-01-XX**: 初回提案・基本コンセプトの合意
- **2025-01-XX**: theme_histories管理方針の決定
- **2025-01-XX**: 設計ノート作成
- **2025-01-XX**: ID管理方式の検討・案2採用決定
- **2025-01-XX**: 活動種別統合方針の決定（開始活動）
- **2025-01-XX**: themeboxとの統合アプローチ決定
- **2025-01-XX**: テーマ終了活動の統合方針決定
- **2025-01-XX**: 内省時サブテーマ判定機能の追加決定
- **2025-01-XX**: 「知っているが意識しない」アプローチの採用決定

---

*このドキュメントは設計の進行に伴って継続的に更新されます*