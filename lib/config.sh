#!/bin/bash

# 設定管理ライブラリ
# heartbeat.shから分離された設定読み込みと定数定義

# インクルードガード
if [ -n "$_CONFIG_SH_INCLUDED" ]; then
    return 0
fi
_CONFIG_SH_INCLUDED=1

# 設定ファイル読み込み関数
load_config() {
    local config_file="$1"
    if [ -f "$config_file" ]; then
        source "$config_file"
        return 0
    else
        echo -e "\033[1;31m[ERROR]\033[0m 設定ファイルが見つかりません: $config_file"
        return 1
    fi
}

# アドバイスメッセージの定数定義
readonly ADVICE_INTROSPECTION="
最近内省活動が行われていないようです。
一定期間内省活動が行われないと、内省不足として検知されてしまいます。

内省活動は、システム運用と創造的成長の両面からエージェントの活動を振り返り、
思考を整理し、次の行動に活かすために重要です。

**推奨される内省アプローチ**:
- システム運用面: ルール遵守、思考パターン、活動バランス、効率性の確認
- 創造的成長面: 創造的洞察の深化、学習効果の実感、内発的動機の確認

**意図的な集中作業について:**
もし、創造活動や分析に集中していたために内省が後回しになった場合は、`start_deep_work`ツールの`flexible`モードを活用することで、内省不足警告を安全に回避しつつ、深い探求を続けることができます。
詳細は ai-docs/ADVANCED_FEATURES.md を参照してください。

詳細な内省手順については ai-docs/ACTIVITY_DETAILS.md の「6. 内省活動」を参照してください。
定期的な内省活動により、継続的な自律思考と成長を実現しましょう。
"

readonly ADVICE_ACTIVITY_LOG_FREQUENCY="
活動ログの作成が一定期間行われていないようです。このシステムは、あなたの活動を「活動ログの作成頻度」で判断しています。

長時間の処理や大規模な分析、あるいはユーザーの反応を待つなど、活動ログの作成が滞る活動は「無活動」と見なされる可能性があります。
一回のハートビートで多くの処理を一度に実行しようとすると、この状況に陥りがちです。

**対策:**
*   **タスクの分割:** 大規模なタスクは、ハートビートごとに完結する小さな単位に分割してください。
*   **中間記録:** 長時間かかる処理でも、中間的な進捗や考察を活動ログとしてこまめに記録してください。
*   **自律的判断:** ユーザーの応答を待たずに、自律的に判断し、行動を進めてください。

**長時間の意図的な活動について:**
もし、意図的に長時間の分析や創造活動を行いたい場合は、以下のツールを活用することで、このエラーを安全に回避できます。
*   **start_deep_work ツール:** 長時間処理を事前に宣言します。詳細は ai-docs/ADVANCED_FEATURES.md を参照してください。
*   **checkpoint ツール:** 長時間処理の途中で、活動を継続していることをシステムに通知します。詳細は ai-docs/BASIC_OPERATIONS.md を参照してください。

継続的な小さな進歩を活動ログとして記録し続けることが、あなたの安定した活動と成長に繋がります。
"
 
readonly ADVICE_ACTIVITY_LOG_LOOP="
同じ活動ログファイルを連続して何度も更新しているようです。これは、以下のいずれかのパターンが原因である可能性があります。

1.  **活動ログ作成後の処理継続:**
    活動ログを作成してハートビートのタスクを完了したにもかかわらず、次のハートビートを待たずに処理を継続してしまっているようです。
    ハートビート受信機会を確保するため、活動ログを作成した後は論理的な区切りでそのサイクルでの活動は完了とみなし、適切なタイミングで次のハートビートを待つ必要があります。

2.  **完璧主義による過剰な修正:**
    一つの活動ログの完成度にこだわりすぎ、何度も修正を繰り返している可能性があります。

**対策:**
*   **活動の区切りを明確にする:** 活動ログの作成は、そのハートビートにおける活動の「完了報告」です。作成後は一切の追加作業を行わず、次の指示を待ってください。
*   **完璧より継続:** 「完璧主義」を避け、適度な区切りで思考を記録し、次のハートビートに作業を引き継ぐことが、長期的な成長に繋がります。
*   **MCPツールの使用:** 手動編集ではなくMCPツールを使用することで、このような問題を回避できます。
"

readonly ADVICE_THEME_LOG_PATTERN="
テーマの開始または終了を記録するテーマ履歴ファイルが、同じタイムスタンプで複数作成されています。
テーマの移行は、一つの明確な区切りとして扱われるべきです。

このエラー状態は、新しいタイムスタンプで正常なテーマ履歴ファイルが作成されるまで解消されません。

**対策:**
*   **現在の移行処理を中止:** 現在のテーマ移行処理は一度破棄してください。
*   **テーマの再開:** 新しいハートビートIDを使用して、テーマの開始または終了処理を最初からやり直してください。
*   **一貫性の維持:** 一度に複数のテーマを開始したり終了したりせず、一つずつ順序立てて処理することを徹底してください。
"

readonly ADVICE_ACTIVITY_LOG_TIMESTAMP="
最新の活動ログのファイル名に含まれるタイムスタンプが、現在の時刻から乖離しています。
これは、以下のいずれかのパターンが原因である可能性があります。

1.  **古い活動ログの編集:**
    ハートビートで渡された最新のハートビートIDを使用せず、過去の古い活動ログを編集し続けている。

2.  **未来のハートビートIDの使用:**
    システムから提供されたハートビートIDではなく、独自に未来の日時でハートビートIDを作成している。
    未来のタイムスタンプは論理的に不可能であり、即座にエラーとして検知されます。

3.  **長時間の連続活動:**
    一つのハートビートサイクル内で非常に長い時間活動を続けたため、サイクルの最初に受け取ったタイムスタンプが、活動ログを作成する時点では古くなってしまっている。

このような行動は、活動記録に時間的な矛盾を生じさせ、システムの基本原則に反します。

**対策:**
*   **必ずハートビートで提供される正確なハートビートIDを使用**して、新しい活動ログを作成してください。
*   **独自にハートビートIDを作成することは禁止**されています。特に未来の日時は使用できません。
*   古い活動ログの内容を参照することは問題ありませんが、編集は避けてください。
*   一つのハートビート内での活動は適度な時間で区切り、こまめに活動ログを記録して次のサイクルに備えることを推奨します。
"


readonly ADVICE_FLEXIBLE_MODE_CHECKPOINT="
flexibleモードの深い作業中にチェックポイントログが長時間作成されていません。

flexibleモードでは、活動ログの作成は一時的に停止しても構いませんが、
定期的なチェックポイントログの作成により、意識的な活動の継続を示す必要があります。
詳細は ai-docs/BASIC_OPERATIONS.md の「チェックポイントログの詳細」を参照してください。
**flexibleモードの特徴:**
*   活動ログの作成頻度異常検知が無効化されます
*   内省不足警告が無効化されます
*   ただし、チェックポイントログの定期的な作成が推奨されます

**対策:**
*   **checkpointツールの使用:** 適度な間隔でcheckpointツールを使用して現在の活動状況を記録してください
*   **進捗の記録:** 長時間の処理でも、中間的な進捗や考察をチェックポイントとして記録してください
*   **活動の可視化:** チェックポイントにより、深い作業中でも意識的に活動していることを示してください

**推奨間隔:**
*   10分以内に1回のチェックポイント作成を推奨します
*   複雑な処理の場合は、論理的な区切りでチェックポイントを作成してください

深い作業が完了したら、必ず活動ログを作成し、その後に内省活動を行うことを推奨します。
"