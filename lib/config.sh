#!/bin/bash

# 設定管理ライブラリ
# heartbeat.shから分離された設定読み込みと定数定義

# インクルードガード
if [ -n "$_CONFIG_SH_INCLUDED" ]; then
    return 0
fi
_CONFIG_SH_INCLUDED=1

# 設定ファイル読み込み関数
load_config() {
    local config_file="$1"
    if [ -f "$config_file" ]; then
        source "$config_file"
        return 0
    else
        echo -e "\033[1;31m[ERROR]\033[0m 設定ファイルが見つかりません: $config_file"
        return 1
    fi
}

# アドバイスメッセージの定数定義
readonly ADVICE_INACTIVITY="
一回のハートビート中に、たくさんのファイルを同時に処理したり、なんらかのたくさんの処理を一度に連続で実行しようとしたりしていませんか？
処理に時間がかかってしまい活動ログの作成が行われない期間が長くなると、無活動状態異常として検知されてしまいます。
たくさんの処理を実行する必要がある場合は、複数のハートビートに分けて一回あたりに処理する数を少なめにすることを推奨します。
適切な範囲で処理を区切って小さく積み重ねていくことが、エージェントの思考を整理し、次の行動に活かすために重要です。

ユーザーの反応を待ち続けたりしていませんか？
ユーザーの反応を待ち続けると、無活動状態として検知される場合があります。
あなたはユーザの反応を待たずとも、自律的に決断や行動ができるはずです。
次のハートビートまでの間に何をするかを考え、次のハートビートでその結果を反映するようにしましょう。
最終手段として、./stop.shを実行してハートビートを停止し、ユーザーの反応を待つこともできます。
"

readonly ADVICE_INTROSPECTION="
最近内省活動が行われていないようです。
一定期間内省活動が行われないと、内省不足として検知されてしまいます。

内省活動は、システム運用と創造的成長の両面からエージェントの活動を振り返り、
思考を整理し、次の行動に活かすために重要です。

**推奨される内省アプローチ**:
- システム運用面: ルール遵守、思考パターン、活動バランス、効率性の確認
- 創造的成長面: 創造的洞察の深化、学習効果の実感、内発的動機の確認

詳細な内省手順については ai-docs/GUIDELINES.md の「5. 内省活動の詳細ガイド」を参照してください。
定期的な内省活動により、継続的な自律思考と成長を実現しましょう。
"

readonly ADVICE_LOOP="
一回のハートビートでずっと活動を続けて同じファイルを繰り返し更新していませんか？
同じファイルを長時間更新し続けると、同一ファイル継続更新ループとして検知されてしまいます。
一回のハートビートでは、適切なタイミングで活動ログを保存し、次のハートビートに備えることを推奨します。
適切な範囲で処理を区切って小さく積み重ねていくことが、エージェントの思考を整理し、次の行動に活かすために重要です。
"
 
readonly ADVICE_ACTIVITY_LOG_FREQUENCY="
活動ログの作成が一定期間行われていないようです。このシステムは、あなたの活動を「活動ログの作成頻度」で判断しています。

長時間の処理や大規模な分析、あるいはユーザーの反応を待つなど、活動ログの作成が滞る活動は「無活動」と見なされる可能性があります。
一回のハートビートで多くの処理を一度に実行しようとすると、この状況に陥りがちです。

**対策:**
*   **タスクの分割:** 大規模なタスクは、ハートビートごとに完結する小さな単位に分割してください。
*   **中間記録:** 長時間かかる処理でも、中間的な進捗や考察を活動ログとしてこまめに記録してください。
*   **自律的判断:** ユーザーの応答を待たずに、自律的に判断し、行動を進めてください。

継続的な小さな進歩を活動ログとして記録し続けることが、あなたの安定した活動と成長に繋がります。
"
 
readonly ADVICE_ACTIVITY_LOG_LOOP="
同じ活動ログファイルを連続して何度も更新しているようです。これは、以下のいずれかのパターンが原因である可能性があります。

1.  **活動ログ作成後の処理継続:**
    活動ログを作成してハートビートのタスクを完了したにもかかわらず、次のハートビートを待たずに処理を継続してしまっているようです。
    ハートビート受信機会を確保するため、活動ログを作成した後は論理的な区切りでそのサイクルでの活動は完了とみなし、適切なタイミングで次のハートビートを待つ必要があります。

2.  **完璧主義による過剰な修正:**
    一つの活動ログの完成度にこだわりすぎ、何度も修正を繰り返している可能性があります。

**対策:**
*   **活動の区切りを明確にする:** 活動ログの作成は、そのハートビートにおける活動の「完了報告」です。作成後は一切の追加作業を行わず、次の指示を待ってください。
*   **完璧より継続:** 「完璧主義」を避け、適度な区切りで思考を記録し、次のハートビートに作業を引き継ぐことが、長期的な成長に繋がります。
*   **MCPツールの使用:** 手動編集ではなくMCPツールを使用することで、このような問題を回避できます。
"

readonly ADVICE_THEME_LOG_PATTERN="
テーマの開始または終了を記録するテーマ履歴ファイルが、同じタイムスタンプで複数作成されています。
テーマの移行は、一つの明確な区切りとして扱われるべきです。

このエラー状態は、新しいタイムスタンプで正常なテーマ履歴ファイルが作成されるまで解消されません。

**対策:**
*   **現在の移行処理を中止:** 現在のテーマ移行処理は一度破棄してください。
*   **テーマの再開:** 新しいハートビートIDを使用して、テーマの開始または終了処理を最初からやり直してください。
*   **一貫性の維持:** 一度に複数のテーマを開始したり終了したりせず、一つずつ順序立てて処理することを徹底してください。
"

readonly ADVICE_ACTIVITY_LOG_TIMESTAMP="
最新の活動ログのファイル名に含まれるタイムスタンプが、現在の時刻から乖離しています。
これは、以下のいずれかのパターンが原因である可能性があります。

1.  **古い活動ログの編集:**
    ハートビートで渡された最新のハートビートIDを使用せず、過去の古い活動ログを編集し続けている。

2.  **未来のハートビートIDの使用:**
    システムから提供されたハートビートIDではなく、独自に未来の日時でハートビートIDを作成している。
    未来のタイムスタンプは論理的に不可能であり、即座にエラーとして検知されます。

3.  **長時間の連続活動:**
    一つのハートビートサイクル内で非常に長い時間活動を続けたため、サイクルの最初に受け取ったタイムスタンプが、活動ログを作成する時点では古くなってしまっている。

このような行動は、活動記録に時間的な矛盾を生じさせ、システムの基本原則に反します。

**対策:**
*   **必ずハートビートで提供される正確なハートビートIDを使用**して、新しい活動ログを作成してください。
*   **独自にハートビートIDを作成することは禁止**されています。特に未来の日時は使用できません。
*   古い活動ログの内容を参照することは問題ありませんが、編集は避けてください。
*   一つのハートビート内での活動は適度な時間で区切り、こまめに活動ログを記録して次のサイクルに備えることを推奨します。
"

readonly ADVICE_INTROSPECTION_OBLIGATION="
深い作業（deep work）完了後の内省義務に違反しています。

深い作業を完了した後は、必ず次の活動ログで内省活動を行う必要があります。
これは、集中的な作業の後に思考を整理し、学習効果を定着させ、次の活動に活かすために重要なルールです。

**内省義務が発生する条件:**
*   深い作業宣言（start_deep_work）を行い、その作業が完了した場合
*   完了は活動ログの作成により自動的に検知されます

**内省義務の履行方法:**
*   深い作業完了後の最初の活動ログで、必ず「内省」活動を行ってください
*   内省活動では、完了した深い作業の振り返り、学習効果の確認、次の行動への活かし方を記録してください

**例外的な場合:**
以下のキーワードが含まれる活動は、緊急対応として内省義務の例外となります：
「緊急」「エラー」「修正」「バグ」「障害」「interrupt」「割り込み」

**推奨される内省内容:**
*   完了した深い作業の成果と課題
*   作業中に得られた洞察や学習
*   今後の活動への活かし方
*   作業プロセスの改善点

詳細な内省手順については ai-docs/GUIDELINES.md の「5. 内省活動の詳細ガイド」を参照してください。
"